# Minimal Dockerfile - Ultra Lightweight
# Excludes ML/AI dependencies for smallest possible image
# Use this if you don't need:
# - Predictive scaling (scikit-learn, scipy, statsmodels)
# - GenAI features (openai, gemini, claude)
#
# Image size: ~200-300MB (vs ~800MB+ with ML libraries)
# Build time: 1-2 minutes

# Build stage
FROM python:3.12-slim AS builder

WORKDIR /build

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    gcc \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy minimal requirements
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir --prefix=/install -r requirements.txt && \
    pip install --no-cache-dir --prefix=/install \
        flask==3.0.0 \
        flask-cors==4.0.0 \
        prometheus-client==0.19.0 \
        python-json-logger==2.0.7 \
        psutil==5.9.8

# Runtime stage
FROM python:3.12-slim

LABEL maintainer="phamngocsonls"
LABEL description="Smart Kubernetes Autoscaler - Minimal Build (No ML/AI)"
LABEL org.opencontainers.image.source="https://github.com/phamngocsonls/enhanced-smart-k8s-autoscaler"

WORKDIR /app

# Install only essential runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    sqlite3 \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Copy installed Python packages from builder
COPY --from=builder /install /usr/local

# Copy application code
COPY src/ ./src/
COPY templates/ ./templates/

# Create data directory
RUN mkdir -p /data && chmod 777 /data

# Create operator user
# Handle case where group might already exist
RUN groupadd -r operator 2>/dev/null || true && \
    useradd -r -g operator -u 1000 -m -s /sbin/nologin operator 2>/dev/null || true && \
    chown -R operator:operator /app /data

# Security: Run as non-root user
USER operator

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD python -c "import sqlite3; sqlite3.connect('/data/autoscaler.db').close()" || exit 1

# Expose ports
EXPOSE 8000 5000

# Environment variables
ENV ENABLE_PREDICTIVE=false \
    ENABLE_GENAI=false

# Run application
CMD ["python", "-u", "-m", "src.integrated_operator"]
