<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Autoscaler Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            /* Grafana-inspired color palette */
            --bg-canvas: #111217;
            --bg-primary: #181b1f;
            --bg-secondary: #22252b;
            --bg-tertiary: #2c3039;
            --bg-hover: #31363f;
            --border-weak: #2c3039;
            --border-medium: #3d424d;
            --text-primary: #d8d9da;
            --text-secondary: #8e8e8e;
            --text-disabled: #6e6e6e;
            --accent-blue: #3d71d9;
            --accent-green: #73bf69;
            --accent-yellow: #fade2a;
            --accent-orange: #ff9830;
            --accent-red: #f2495c;
            --accent-purple: #b877d9;
            --accent-cyan: #5794f2;
            --gradient-blue: linear-gradient(180deg, rgba(61,113,217,0.15) 0%, transparent 100%);
            --gradient-green: linear-gradient(180deg, rgba(115,191,105,0.15) 0%, transparent 100%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-canvas);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: 13px;
            line-height: 1.5;
        }
        
        /* Grafana-style Header */
        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-weak);
            padding: 0 16px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
        }
        .logo-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .version-badge {
            background: var(--bg-tertiary);
            color: var(--accent-cyan);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        .header-center {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--bg-secondary);
            border-radius: 4px;
            font-size: 11px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-dot.healthy { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); }
        .status-dot.warning { background: var(--accent-yellow); box-shadow: 0 0 8px var(--accent-yellow); }
        .status-dot.error { background: var(--accent-red); box-shadow: 0 0 8px var(--accent-red); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        .time-display {
            color: var(--text-secondary);
            font-size: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        /* Main Container */
        .container {
            max-width: 1920px;
            margin: 0 auto;
            padding: 16px;
        }
        
        /* Stats Row - Grafana style */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        @media (max-width: 1200px) { .stats-row { grid-template-columns: repeat(5, 1fr); } }
        @media (max-width: 900px) { .stats-row { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 600px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
        
        .stat-panel {
            background: var(--bg-primary);
            border: 1px solid var(--border-weak);
            border-radius: 4px;
            padding: 12px 16px;
            position: relative;
            overflow: hidden;
        }
        .stat-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
        }
        .stat-panel.blue::before { background: var(--accent-blue); }
        .stat-panel.green::before { background: var(--accent-green); }
        .stat-panel.yellow::before { background: var(--accent-yellow); }
        .stat-panel.red::before { background: var(--accent-red); }
        .stat-panel.purple::before { background: var(--accent-purple); }
        .stat-panel.cyan::before { background: var(--accent-cyan); }
        .stat-panel.orange::before { background: var(--accent-orange); }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 500;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        .stat-value.blue { color: var(--accent-blue); }
        .stat-value.green { color: var(--accent-green); }
        .stat-value.yellow { color: var(--accent-yellow); }
        .stat-value.red { color: var(--accent-red); }
        .stat-value.purple { color: var(--accent-purple); }
        .stat-value.cyan { color: var(--accent-cyan); }
        .stat-value.orange { color: var(--accent-orange); }
        .stat-sub {
            font-size: 10px;
            color: var(--text-disabled);
            margin-top: 2px;
        }
        
        /* Tab Navigation - Grafana style */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border-weak);
            padding-bottom: 0;
        }
        .tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.15s;
        }
        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }
        .tab.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
        }
        
        /* Panel - Grafana style */
        .panel {
            background: var(--bg-primary);
            border: 1px solid var(--border-weak);
            border-radius: 4px;
            margin-bottom: 16px;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-weak);
            min-height: 40px;
        }
        .panel-title {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .panel-title-icon {
            font-size: 14px;
        }
        .panel-actions {
            display: flex;
            gap: 8px;
        }
        .panel-body {
            padding: 16px;
        }
        
        /* Buttons - Grafana style */
        .btn {
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-medium);
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-blue);
        }
        .btn-primary {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
        .btn-primary:hover {
            background: #4d81e9;
        }
        
        /* Table - Grafana style */
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-weak);
        }
        th {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-secondary);
        }
        tr:hover {
            background: var(--bg-hover);
        }
        tr.clickable {
            cursor: pointer;
        }
        
        /* Badge - Grafana style */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .badge.healthy { background: rgba(115,191,105,0.15); color: var(--accent-green); }
        .badge.warning { background: rgba(250,222,42,0.15); color: var(--accent-yellow); }
        .badge.critical { background: rgba(242,73,92,0.15); color: var(--accent-red); }
        .badge.info { background: rgba(87,148,242,0.15); color: var(--accent-cyan); }
        .badge.steady { background: rgba(61,113,217,0.15); color: var(--accent-blue); }
        .badge.bursty { background: rgba(255,152,48,0.15); color: var(--accent-orange); }
        .badge.growing { background: rgba(115,191,105,0.15); color: var(--accent-green); }
        .badge.periodic { background: rgba(184,119,217,0.15); color: var(--accent-purple); }
        .badge.unknown { background: var(--bg-tertiary); color: var(--text-secondary); }
        
        /* Progress Bar - Grafana style */
        .progress-bar {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }
        .progress-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        .progress-fill.healthy { background: var(--accent-green); }
        .progress-fill.warning { background: var(--accent-yellow); }
        .progress-fill.critical { background: var(--accent-red); }
        .progress-fill.blue { background: var(--accent-blue); }
        
        /* Chart Container */
        .chart-container { height: 180px; }
        .chart-container-lg { height: 250px; }
        .chart-container-sm { height: 140px; }
        
        /* Grid Layouts */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 16px;
        }
        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        @media (max-width: 900px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } }
        
        /* Metric Display */
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-weak);
        }
        .metric-row:last-child { border-bottom: none; }
        .metric-label { color: var(--text-secondary); font-size: 12px; }
        .metric-value { font-weight: 500; font-family: 'Monaco', 'Menlo', monospace; }
        
        /* Resource Card - Grafana style */
        .resource-card {
            background: var(--bg-secondary);
            border-radius: 4px;
            padding: 16px;
        }
        .resource-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 500;
        }
        .resource-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .resource-icon.cpu { background: rgba(87,148,242,0.2); color: var(--accent-cyan); }
        .resource-icon.memory { background: rgba(184,119,217,0.2); color: var(--accent-purple); }
        
        .resource-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        .resource-stat-label {
            font-size: 10px;
            color: var(--text-disabled);
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        .resource-stat-value {
            font-size: 16px;
            font-weight: 500;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        /* Big Progress Bar */
        .big-progress {
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .big-progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 11px;
            font-weight: 500;
            color: white;
        }
        .big-progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-disabled);
            margin-top: 4px;
        }
        
        /* Insight Card */
        .insight-card {
            background: var(--bg-secondary);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .insight-title {
            font-weight: 500;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .insight-value {
            font-size: 18px;
            font-weight: 600;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        .insight-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        /* Timeline */
        .timeline-event {
            display: flex;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-weak);
        }
        .timeline-event:last-child { border-bottom: none; }
        .timeline-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        .timeline-icon.up { background: rgba(115,191,105,0.2); color: var(--accent-green); }
        .timeline-icon.down { background: rgba(242,73,92,0.2); color: var(--accent-red); }
        .timeline-icon.change { background: rgba(87,148,242,0.2); color: var(--accent-cyan); }
        .timeline-content { flex: 1; }
        .timeline-time {
            font-size: 11px;
            color: var(--text-disabled);
            margin-top: 2px;
        }
        
        /* Gauge */
        .gauge-container { text-align: center; padding: 12px; }
        .gauge {
            position: relative;
            width: 120px;
            height: 60px;
            margin: 0 auto;
            overflow: hidden;
        }
        .gauge-bg {
            position: absolute;
            width: 120px;
            height: 60px;
            border-radius: 60px 60px 0 0;
            background: var(--bg-tertiary);
        }
        .gauge-fill {
            position: absolute;
            width: 120px;
            height: 60px;
            border-radius: 60px 60px 0 0;
            background: var(--accent-green);
            transform-origin: center bottom;
        }
        .gauge-cover {
            position: absolute;
            width: 90px;
            height: 45px;
            border-radius: 45px 45px 0 0;
            background: var(--bg-primary);
            top: 15px;
            left: 15px;
        }
        .gauge-value {
            position: absolute;
            bottom: 0;
            width: 100%;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        .gauge-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 6px;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        .empty-state-icon {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        
        /* Refresh Indicator */
        .refresh-indicator {
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: var(--bg-secondary);
            padding: 8px 14px;
            border-radius: 20px;
            border: 1px solid var(--border-weak);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .spinner {
            animation: spin 1s linear infinite;
            color: var(--accent-cyan);
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Namespace Filter */
        .filter-bar {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
        }
        .filter-select {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        .filter-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        .filter-label {
            color: var(--text-secondary);
            font-size: 12px;
        }
        
        /* Recommendation Panel */
        .recommendation-panel {
            background: var(--bg-secondary);
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 3px solid var(--accent-green);
        }
        .recommendation-panel.high { border-left-color: var(--accent-red); }
        .recommendation-panel.medium { border-left-color: var(--accent-yellow); }
        .recommendation-panel.low { border-left-color: var(--accent-cyan); }
        
        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .recommendation-title {
            font-weight: 600;
            font-size: 14px;
        }
        .recommendation-savings {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-green);
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .recommendation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 12px;
        }
        .recommendation-col h4 {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .recommendation-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
        }
        .recommendation-item .label { color: var(--text-secondary); }
        .recommendation-item .value { font-family: 'Monaco', 'Menlo', monospace; }
        .recommendation-item .value.new { color: var(--accent-green); }
        .recommendation-item .value.old { color: var(--text-disabled); text-decoration: line-through; }
        
        .recommendation-warning {
            background: rgba(250,222,42,0.1);
            border: 1px solid rgba(250,222,42,0.3);
            border-radius: 4px;
            padding: 10px 12px;
            font-size: 11px;
            color: var(--accent-yellow);
            margin-top: 12px;
        }
        
        .yaml-snippet {
            background: var(--bg-canvas);
            border-radius: 4px;
            padding: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            overflow-x: auto;
            white-space: pre;
            color: var(--text-secondary);
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <div class="logo-icon">‚ö°</div>
                <span>Smart Autoscaler</span>
                <span class="version-badge" id="version">v0.0.18</span>
            </div>
        </div>
        <div class="header-center">
            <div class="status-indicator">
                <span class="status-dot healthy" id="prom-status"></span>
                <span>Prometheus</span>
            </div>
            <div class="status-indicator">
                <span class="status-dot healthy" id="k8s-status"></span>
                <span>Kubernetes</span>
            </div>
            <div class="status-indicator">
                <span class="status-dot healthy" id="db-status"></span>
                <span>Database</span>
            </div>
        </div>
        <div class="header-right">
            <span class="time-display" id="last-update">--:--:--</span>
            <button class="btn" onclick="refreshData()">‚ü≥ Refresh</button>
        </div>
    </header>

    <div class="container">
        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-panel blue">
                <div class="stat-label">Deployments / Pods</div>
                <div class="stat-value blue"><span id="stat-deployments">-</span> / <span id="stat-pods">-</span></div>
                <div class="stat-sub">watched / running</div>
            </div>
            <div class="stat-panel green">
                <div class="stat-label">CPU / Efficiency</div>
                <div class="stat-value green"><span id="stat-cpu">-</span>% / <span id="stat-efficiency">-</span>%</div>
                <div class="stat-sub">utilization / resource</div>
            </div>
            <div class="stat-panel yellow">
                <div class="stat-label">Cost / Savings</div>
                <div class="stat-value yellow">$<span id="stat-cost">-</span> / $<span id="stat-savings">-</span></div>
                <div class="stat-sub">monthly / potential</div>
            </div>
            <div class="stat-panel cyan">
                <div class="stat-label">Predictions</div>
                <div class="stat-value cyan" id="stat-accuracy">-%</div>
                <div class="stat-sub">accuracy</div>
            </div>
            <div class="stat-panel orange">
                <div class="stat-label">Scale Events</div>
                <div class="stat-value orange" id="stat-events">-</div>
                <div class="stat-sub">last 24h</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="deployments">üìä Deployments</button>
            <button class="tab" data-tab="cluster">üñ•Ô∏è Cluster</button>
            <button class="tab" data-tab="finops">üí∞ FinOps</button>
            <button class="tab" data-tab="insights">üß† AI Insights</button>
            <button class="tab" data-tab="timeline">üìà Timeline</button>
            <button class="tab" data-tab="predictions">üîÆ Predictions</button>
            <button class="tab" data-tab="alerts">üîî Alerts</button>
            <button class="tab" data-tab="hpa-analysis">üõ°Ô∏è HPA Analysis</button>
            <button class="tab" data-tab="config">‚öôÔ∏è Config</button>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <span class="filter-label">Namespace:</span>
            <select id="namespace-filter" class="filter-select">
                <option value="all">All Namespaces</option>
            </select>
        </div>

        <div class="main-grid">
            <div class="main-content">
                <!-- Deployments Tab -->
                <div class="panel tab-content" id="tab-deployments">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üìä</span> Watched Deployments</span>
                        <div class="panel-actions">
                            <button class="btn" onclick="refreshData()">‚ü≥ Refresh</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Deployment</th>
                                    <th>Priority</th>
                                    <th>CPU Usage</th>
                                    <th>CPU Req</th>
                                    <th>Mem Req</th>
                                    <th>Pods</th>
                                    <th>HPA Target</th>
                                    <th>Pattern</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="deployments-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Cluster Tab -->
                <div class="panel tab-content" id="tab-cluster" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üñ•Ô∏è</span> Cluster Monitoring</span>
                        <div class="panel-actions">
                            <button class="btn" onclick="loadClusterMetrics()">‚ü≥ Refresh</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <!-- Cluster Summary -->
                        <div class="grid-3" style="margin-bottom:16px;">
                            <div class="stat-panel blue">
                                <div class="stat-label">Nodes</div>
                                <div class="stat-value blue" id="cluster-node-count">-</div>
                                <div class="stat-sub">active nodes</div>
                            </div>
                            <div class="stat-panel green">
                                <div class="stat-label">Total Pods</div>
                                <div class="stat-value green" id="cluster-pod-count">-</div>
                                <div class="stat-sub">across cluster</div>
                            </div>
                            <div class="stat-panel cyan">
                                <div class="stat-label">Cluster Health</div>
                                <div class="stat-value cyan" id="cluster-health">-</div>
                                <div class="stat-sub">overall status</div>
                            </div>
                        </div>
                        
                        <!-- CPU Resources -->
                        <div class="resource-card" style="margin-bottom:16px;">
                            <div class="resource-header">
                                <div class="resource-icon cpu">üíª</div>
                                <span>CPU Resources</span>
                            </div>
                            <div class="resource-stats">
                                <div>
                                    <div class="resource-stat-label">Capacity</div>
                                    <div class="resource-stat-value" id="cpu-capacity">- cores</div>
                                </div>
                                <div>
                                    <div class="resource-stat-label">Allocatable</div>
                                    <div class="resource-stat-value" id="cpu-allocatable">- cores</div>
                                </div>
                                <div>
                                    <div class="resource-stat-label">Requested</div>
                                    <div class="resource-stat-value" style="color:var(--accent-yellow)" id="cpu-requests">- cores</div>
                                    <div style="font-size:10px;color:var(--text-disabled)" id="cpu-requests-pct">-</div>
                                </div>
                                <div>
                                    <div class="resource-stat-label">Usage</div>
                                    <div class="resource-stat-value" style="color:var(--accent-green)" id="cpu-usage">- cores</div>
                                    <div style="font-size:10px;color:var(--text-disabled)" id="cpu-usage-pct">-</div>
                                </div>
                            </div>
                            <div class="big-progress">
                                <div id="cpu-usage-bar" class="big-progress-fill" style="width:0%;background:var(--accent-green);"></div>
                            </div>
                            <div class="big-progress-label">
                                <span>0%</span>
                                <span>CPU Usage vs Allocatable</span>
                                <span>100%</span>
                            </div>
                        </div>
                        
                        <!-- Memory Resources -->
                        <div class="resource-card" style="margin-bottom:16px;">
                            <div class="resource-header">
                                <div class="resource-icon memory">üß†</div>
                                <span>Memory Resources</span>
                            </div>
                            <div class="resource-stats">
                                <div>
                                    <div class="resource-stat-label">Capacity</div>
                                    <div class="resource-stat-value" id="mem-capacity">- GB</div>
                                </div>
                                <div>
                                    <div class="resource-stat-label">Allocatable</div>
                                    <div class="resource-stat-value" id="mem-allocatable">- GB</div>
                                </div>
                                <div>
                                    <div class="resource-stat-label">Requested</div>
                                    <div class="resource-stat-value" style="color:var(--accent-yellow)" id="mem-requests">- GB</div>
                                    <div style="font-size:10px;color:var(--text-disabled)" id="mem-requests-pct">-</div>
                                </div>
                                <div>
                                    <div class="resource-stat-label">Usage</div>
                                    <div class="resource-stat-value" style="color:var(--accent-purple)" id="mem-usage">- GB</div>
                                    <div style="font-size:10px;color:var(--text-disabled)" id="mem-usage-pct">-</div>
                                </div>
                            </div>
                            <div class="big-progress">
                                <div id="mem-usage-bar" class="big-progress-fill" style="width:0%;background:var(--accent-purple);"></div>
                            </div>
                            <div class="big-progress-label">
                                <span>0%</span>
                                <span>Memory Usage vs Allocatable</span>
                                <span>100%</span>
                            </div>
                        </div>
                        
                        <!-- Trend Charts -->
                        <div class="grid-2" style="margin-bottom:16px;">
                            <div class="resource-card">
                                <div class="resource-header">CPU Trend (24h)</div>
                                <div class="chart-container-sm">
                                    <canvas id="cluster-cpu-history-chart"></canvas>
                                </div>
                            </div>
                            <div class="resource-card">
                                <div class="resource-header">Memory Trend (24h)</div>
                                <div class="chart-container-sm">
                                    <canvas id="cluster-mem-history-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Nodes Table -->
                        <div class="resource-card">
                            <div class="resource-header">üì¶ Nodes Detail</div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Node</th>
                                            <th>CPU Capacity</th>
                                            <th>CPU Usage</th>
                                            <th>CPU %</th>
                                            <th>Memory Capacity</th>
                                            <th>Memory Usage</th>
                                            <th>Memory %</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="nodes-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FinOps Tab -->
                <div class="panel tab-content" id="tab-finops" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üí∞</span> FinOps Resource Recommendations</span>
                        <div class="panel-actions">
                            <span id="finops-summary-stats" style="font-size:11px;color:var(--text-secondary);margin-right:12px;"></span>
                            <button class="btn" onclick="loadFinOpsSummary()">‚ü≥ Refresh</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <!-- Cost Trends Chart -->
                        <div class="resource-card" style="margin-bottom:16px;">
                            <div class="resource-header">
                                <span>üìä Cost Trends (30 days)</span>
                                <span id="cost-trend-summary" style="font-size:11px;color:var(--text-secondary);"></span>
                            </div>
                            <div class="chart-container">
                                <canvas id="cost-trends-chart"></canvas>
                            </div>
                        </div>
                        <!-- Recommendations List -->
                        <div id="finops-content">
                            <div class="empty-state">
                                <div class="empty-state-icon">üí∞</div>
                                <div>Loading recommendations...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Insights Tab -->
                <div class="panel tab-content" id="tab-insights" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üß†</span> AI Insights</span>
                    </div>
                    <div class="panel-body" id="insights-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">üß†</div>
                            <div>Loading insights...</div>
                        </div>
                    </div>
                </div>

                <!-- Timeline Tab -->
                <div class="panel tab-content" id="tab-timeline" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üìà</span> Scaling Timeline</span>
                    </div>
                    <div class="panel-body" id="timeline-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìà</div>
                            <div>No scaling events yet</div>
                        </div>
                    </div>
                </div>

                <!-- Predictions Tab -->
                <div class="panel tab-content" id="tab-predictions" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üîÆ</span> AI Predictions</span>
                        <div class="panel-actions">
                            <span id="prediction-stats" style="font-size:11px;color:var(--text-secondary);margin-right:12px;"></span>
                            <button class="btn" onclick="loadPredictionAccuracy()">‚ü≥ Refresh</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <!-- Prediction Accuracy Chart -->
                        <div class="grid-2" style="margin-bottom:16px;">
                            <div class="resource-card">
                                <div class="resource-header">üìä Prediction vs Actual (7 days)</div>
                                <div class="chart-container">
                                    <canvas id="prediction-accuracy-chart"></canvas>
                                </div>
                            </div>
                            <div class="resource-card">
                                <div class="resource-header">üìà Daily Accuracy Trend</div>
                                <div class="chart-container">
                                    <canvas id="daily-accuracy-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <!-- Prediction History -->
                        <div id="predictions-content">
                            <div class="empty-state">
                                <div class="empty-state-icon">üîÆ</div>
                                <div>Select a deployment to view predictions</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alerts Tab -->
                <div class="panel tab-content" id="tab-alerts" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üîî</span> Alerts & Anomalies</span>
                        <div class="panel-actions">
                            <span id="alerts-summary" style="font-size:11px;color:var(--text-secondary);margin-right:12px;"></span>
                            <button class="btn" onclick="loadAlerts()">‚ü≥ Refresh</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <!-- Alert Types Legend -->
                        <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px;padding:12px;background:var(--bg-secondary);border-radius:4px;">
                            <div style="font-size:11px;color:var(--text-secondary);">
                                <strong>Alert Types:</strong>
                            </div>
                            <div style="font-size:11px;"><span style="color:var(--accent-red)">‚óè</span> cpu_spike - Unusual CPU increase</div>
                            <div style="font-size:11px;"><span style="color:var(--accent-yellow)">‚óè</span> scaling_thrashing - Too many scale events</div>
                            <div style="font-size:11px;"><span style="color:var(--accent-purple)">‚óè</span> high_memory - Memory near limit</div>
                            <div style="font-size:11px;"><span style="color:var(--accent-cyan)">‚óè</span> low_efficiency - Wasted resources</div>
                            <div style="font-size:11px;"><span style="color:var(--accent-orange)">‚óè</span> hpa_flapping - HPA config issue</div>
                            <div style="font-size:11px;"><span style="color:var(--text-secondary)">‚óè</span> low_confidence - Unreliable predictions</div>
                        </div>
                        
                        <div id="alerts-content">
                            <div class="empty-state">
                                <div class="empty-state-icon">üîî</div>
                                <div>Loading alerts...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- HPA Analysis Panel (shown when deployment selected) -->
                <div class="panel tab-content" id="tab-hpa-analysis" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üõ°Ô∏è</span> HPA Behavior Analysis</span>
                        <div class="panel-actions">
                            <button class="btn" onclick="loadHpaAnalysis()">‚ü≥ Refresh</button>
                        </div>
                    </div>
                    <div class="panel-body" id="hpa-analysis-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">üõ°Ô∏è</div>
                            <div>Select a deployment to analyze HPA behavior</div>
                        </div>
                    </div>
                </div>

                <!-- Config Tab -->
                <div class="panel tab-content" id="tab-config" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">‚öôÔ∏è</span> Configuration</span>
                        <div class="panel-actions">
                            <button class="btn btn-primary" onclick="reloadConfig()">üîÑ Hot Reload</button>
                        </div>
                    </div>
                    <div class="panel-body" id="config-content"></div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Resource Efficiency</span>
                    </div>
                    <div class="panel-body">
                        <div class="gauge-container">
                            <div class="gauge">
                                <div class="gauge-bg"></div>
                                <div class="gauge-fill" id="efficiency-gauge"></div>
                                <div class="gauge-cover"></div>
                                <div class="gauge-value" id="efficiency-value">-</div>
                            </div>
                            <div class="gauge-label">CPU Utilization vs Requests</div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">CPU Trend (1h)</span>
                    </div>
                    <div class="panel-body">
                        <div class="chart-container">
                            <canvas id="cpu-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">System Health</span>
                    </div>
                    <div class="panel-body" id="health-metrics"></div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Quick Actions</span>
                    </div>
                    <div class="panel-body">
                        <div style="display:flex;flex-direction:column;gap:8px">
                            <button class="btn" style="width:100%" onclick="refreshData()">‚ü≥ Refresh All</button>
                            <button class="btn" style="width:100%" onclick="reloadConfig()">‚öôÔ∏è Reload Config</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="refresh-indicator">
        <span class="spinner">‚ü≥</span>
        <span id="countdown">30</span>s
    </div>

    <script>
        let state = { deployments: [], cpuChart: null, costChart: null, countdown: 30, currentDep: null, current: {} };
        const cache = new Map();
        const CACHE_TTL = 10000;
        
        // Chart.js global config for Grafana style
        Chart.defaults.color = '#8e8e8e';
        Chart.defaults.borderColor = '#2c3039';
        Chart.defaults.font.family = "'Inter', sans-serif";
        
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => loadClusterMetrics(), 500);
        });

        async function fetchAPI(url, force = false) {
            const now = Date.now();
            if (!force && cache.has(url)) {
                const { data, time } = cache.get(url);
                if (now - time < CACHE_TTL) return data;
            }
            try {
                const res = await fetch(url);
                if (!res.ok) return null;
                const data = await res.json();
                cache.set(url, { data, time: now });
                return data;
            } catch (e) { return null; }
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).style.display = 'block';
                
                if (tab.dataset.tab === 'cluster') loadClusterMetrics();
                else if (tab.dataset.tab === 'finops') { loadFinOpsSummary(); loadCostTrends(); }
                else if (tab.dataset.tab === 'alerts') loadAlerts();
                else if (tab.dataset.tab === 'hpa-analysis') loadHpaAnalysis();
                else if (tab.dataset.tab === 'predictions') loadPredictionAccuracy();
                else if (state.currentDep) {
                    const [ns, dep] = state.currentDep.split('/');
                    if (tab.dataset.tab === 'insights') loadInsights(ns, dep, true);
                    if (tab.dataset.tab === 'timeline') loadTimeline(ns, dep, true);
                }
            });
        });

        async function loadData(force = false) {
            await Promise.all([loadOverview(force), loadDeployments(force), loadHealth(force), loadConfig(force)]);
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        async function loadOverview(force) {
            const data = await fetchAPI('/api/overview', force);
            if (!data) return;
            document.getElementById('stat-deployments').textContent = data.total_deployments || 0;
            document.getElementById('stat-cost').textContent = (data.total_monthly_cost || 0).toFixed(0);
            document.getElementById('stat-savings').textContent = (data.total_savings_potential || 0).toFixed(0);
        }

        async function loadDeployments(force) {
            const deployments = await fetchAPI('/api/deployments', force) || [];
            state.deployments = deployments;
            
            let totalPods = 0, totalCpu = 0, totalEfficiency = 0, totalEvents = 0;
            let rows = '';

            for (const dep of deployments) {
                const current = await fetchAPI(`/api/deployment/${dep.namespace}/${dep.deployment}/current`, force);
                const insights = await fetchAPI(`/api/ai/insights/${dep.deployment}`, force);
                
                if (!current) {
                    rows += `<tr><td>${dep.deployment}</td><td colspan="8" style="color:var(--text-secondary)">Loading...</td></tr>`;
                    continue;
                }

                if (!state.currentDep) state.currentDep = `${dep.namespace}/${dep.deployment}`;

                totalPods += current.pod_count || 0;
                const cpuPct = (current.pod_cpu_usage || 0) * 100;
                totalCpu += cpuPct;
                
                const efficiency = insights?.efficiency?.cpu_efficiency || 0;
                totalEfficiency += efficiency;
                totalEvents += insights?.scaling_events?.length || 0;

                const cpuStatus = cpuPct > 80 ? 'critical' : cpuPct > 50 ? 'warning' : 'healthy';
                const pattern = current.pattern || 'unknown';
                const cpuReq = current.cpu_request || 0;
                const memReq = current.memory_request || 0;
                const priority = current.priority || 'medium';
                
                const priorityColors = {
                    'critical': 'critical', 'high': 'warning', 'medium': 'healthy',
                    'low': 'info', 'best_effort': 'info'
                };

                rows += `<tr class="clickable" onclick="selectDeployment('${dep.namespace}', '${dep.deployment}')">
                    <td><strong>${dep.deployment}</strong><br><small style="color:var(--text-secondary)">${dep.namespace}</small></td>
                    <td><span class="badge ${priorityColors[priority] || 'healthy'}">${priority}</span></td>
                    <td>
                        ${cpuPct.toFixed(1)}%
                        <div class="progress-bar"><div class="progress-fill ${cpuStatus}" style="width:${Math.min(cpuPct, 100)}%"></div></div>
                    </td>
                    <td>${cpuReq}m</td>
                    <td>${memReq}Mi</td>
                    <td>${current.pod_count || 0}</td>
                    <td>${current.hpa_target || '-'}%</td>
                    <td><span class="badge ${pattern}">${pattern}</span></td>
                    <td><span class="badge ${cpuStatus}">${cpuStatus}</span></td>
                </tr>`;

                if (deployments.indexOf(dep) === 0) {
                    loadCPUHistory(dep.namespace, dep.deployment, force);
                    updateEfficiencyGauge(efficiency);
                    if (insights?.prediction_accuracy) {
                        const acc = (insights.prediction_accuracy.accuracy || 0) * 100;
                        document.getElementById('stat-accuracy').textContent = acc.toFixed(0) + '%';
                    }
            }
            }

            document.getElementById('deployments-body').innerHTML = rows || '<tr><td colspan="9" class="empty-state">No deployments</td></tr>';
            document.getElementById('stat-pods').textContent = totalPods;
            document.getElementById('stat-cpu').textContent = deployments.length ? (totalCpu / deployments.length).toFixed(1) : '-';
            document.getElementById('stat-efficiency').textContent = deployments.length ? (totalEfficiency / deployments.length).toFixed(0) : '-';
            document.getElementById('stat-events').textContent = totalEvents;
            
            const namespaces = [...new Set(deployments.map(d => d.namespace))].sort();
            const namespaceFilter = document.getElementById('namespace-filter');
            const currentValue = namespaceFilter.value;
            namespaceFilter.innerHTML = '<option value="all">All Namespaces</option>';
            for (const ns of namespaces) {
                namespaceFilter.innerHTML += `<option value="${ns}">${ns}</option>`;
            }
            if (currentValue && (currentValue === 'all' || namespaces.includes(currentValue))) {
                namespaceFilter.value = currentValue;
            }
        }

        function selectDeployment(ns, dep) {
            state.currentDep = `${ns}/${dep}`;
            loadCPUHistory(ns, dep, true);
            loadInsights(ns, dep, true);
        }

        function populateFinOpsSelect() {
            // Deprecated - now using loadFinOpsSummary
        }

        async function loadFinOpsSummary() {
            const container = document.getElementById('finops-content');
            const statsEl = document.getElementById('finops-summary-stats');
            
            container.innerHTML = '<div class="empty-state"><div class="spinner">‚ü≥</div><div>Loading all recommendations...</div></div>';
            
            try {
                const res = await fetch('/api/finops/summary');
                const data = await res.json();
                
                if (data.error) {
                    container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>${data.error}</div></div>`;
                    return;
                }
                
                // Update summary stats
                const s = data.summary || {};
                if (statsEl) {
                    statsEl.innerHTML = `
                        <span style="color:var(--accent-red)">üî¥ ${s.high_priority || 0}</span> ¬∑ 
                        <span style="color:var(--accent-yellow)">üü° ${s.medium_priority || 0}</span> ¬∑ 
                        <span style="color:var(--accent-cyan)">üîµ ${s.low_priority || 0}</span> ¬∑ 
                        <span style="color:var(--accent-green)">‚úÖ ${s.optimal || 0}</span>
                        ${s.memory_leaks_detected > 0 ? ` ¬∑ <span style="color:var(--accent-red)">‚ö†Ô∏è ${s.memory_leaks_detected} leaks</span>` : ''}
                    `;
                }
                
                if (!data.recommendations || data.recommendations.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div>No deployments found</div></div>';
                    return;
                }
                
                let html = '';
                
                // Total savings banner
                if (s.total_monthly_savings > 0) {
                    html += `<div class="recommendation-panel" style="border-left-color:var(--accent-green);margin-bottom:16px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-size:12px;color:var(--text-secondary);">Total Potential Monthly Savings</div>
                                <div style="font-size:24px;font-weight:600;color:var(--accent-green);font-family:'Monaco','Menlo',monospace;">$${s.total_monthly_savings.toFixed(2)}</div>
                            </div>
                            <div style="text-align:right;font-size:11px;color:var(--text-secondary);">
                                ${s.high_priority + s.medium_priority} deployments need attention<br>
                                ${s.optimal} deployments are optimal
                            </div>
                        </div>
                    </div>`;
                }
                
                // Render each recommendation
                for (const rec of data.recommendations) {
                    const level = rec.recommendation_level || 'unknown';
                    const levelIcons = { high: 'üî¥', medium: 'üü°', low: 'üîµ', optimal: '‚úÖ', unknown: '‚ùì' };
                    const levelBorders = { high: 'high', medium: 'medium', low: 'low', optimal: '', unknown: '' };
                    
                    // Memory leak warning
                    let memoryLeakHtml = '';
                    if (rec.memory_leak && rec.memory_leak.is_leak_detected) {
                        const leak = rec.memory_leak;
                        memoryLeakHtml = `
                            <div class="recommendation-warning" style="background:rgba(242,73,92,0.1);border-color:rgba(242,73,92,0.3);color:var(--accent-red);">
                                <strong>‚ö†Ô∏è Memory Leak Detected (${leak.leak_severity})</strong><br>
                                <span style="font-size:10px;">
                                    ${leak.reasons ? leak.reasons.join(' ¬∑ ') : ''}
                                    ${leak.time_to_oom_hours ? ` ¬∑ Est. OOM in ${leak.time_to_oom_hours.toFixed(1)}h` : ''}
                                </span>
                            </div>`;
                    }
                    
                    if (rec.error) {
                        html += `
                            <div class="recommendation-panel" style="border-left-color:var(--text-secondary);">
                                <div class="recommendation-header">
                                    <div class="recommendation-title">
                                        ${levelIcons[level]} <strong>${rec.deployment}</strong>
                                        <span style="font-size:11px;color:var(--text-secondary);margin-left:8px;">${rec.namespace}</span>
                                    </div>
                                    <span class="badge unknown">Pending</span>
                                </div>
                                <div style="font-size:12px;color:var(--text-secondary);">${rec.recommendation_text}</div>
                                <div style="font-size:10px;color:var(--text-disabled);margin-top:4px;">Updated: ${new Date(rec.updated_at).toLocaleString()}</div>
                            </div>`;
                        continue;
                    }
                    
                    const savings = rec.savings ? (rec.savings.monthly_savings_usd || 0) : 0;
                    const current = rec.current || {};
                    const recommended = rec.recommended || {};
                    const usage = rec.usage_stats || {};
                    
                    html += `
                        <div class="recommendation-panel ${levelBorders[level]}">
                            <div class="recommendation-header">
                                <div class="recommendation-title">
                                    ${levelIcons[level]} <strong>${rec.deployment}</strong>
                                    <span style="font-size:11px;color:var(--text-secondary);margin-left:8px;">${rec.namespace}</span>
                                </div>
                                <div style="text-align:right;">
                                    ${savings > 0 ? `<div class="recommendation-savings">Save $${savings.toFixed(2)}/mo</div>` : '<span class="badge healthy">Optimal</span>'}
                                </div>
                            </div>
                            
                            <div style="font-size:12px;margin-bottom:12px;">${rec.recommendation_text}</div>
                            
                            <div class="recommendation-grid">
                                <div class="recommendation-col">
                                    <h4>Current</h4>
                                    <div class="recommendation-item">
                                        <span class="label">CPU</span>
                                        <span class="value ${level !== 'optimal' ? 'old' : ''}">${current.cpu_request_millicores || '-'}m</span>
                                    </div>
                                    <div class="recommendation-item">
                                        <span class="label">Memory</span>
                                        <span class="value ${level !== 'optimal' ? 'old' : ''}">${current.memory_request_mb || '-'}Mi</span>
                                    </div>
                                    <div class="recommendation-item">
                                        <span class="label">HPA Target</span>
                                        <span class="value">${current.hpa_target_percent || '-'}%</span>
                                    </div>
                                </div>
                                <div class="recommendation-col">
                                    <h4>Recommended</h4>
                                    <div class="recommendation-item">
                                        <span class="label">CPU</span>
                                        <span class="value ${level !== 'optimal' ? 'new' : ''}">${recommended.cpu_request_millicores || '-'}m</span>
                                    </div>
                                    <div class="recommendation-item">
                                        <span class="label">Memory</span>
                                        <span class="value ${level !== 'optimal' ? 'new' : ''}">${recommended.memory_request_mb || '-'}Mi</span>
                                    </div>
                                    <div class="recommendation-item">
                                        <span class="label">HPA Target</span>
                                        <span class="value">${recommended.hpa_target_percent ? recommended.hpa_target_percent.toFixed(0) : '-'}%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display:flex;gap:16px;margin-top:8px;font-size:11px;color:var(--text-secondary);">
                                <span>Avg CPU: <strong style="color:var(--accent-cyan)">${usage.cpu_avg_millicores ? usage.cpu_avg_millicores.toFixed(0) : '-'}m</strong></span>
                                <span>P95 CPU: <strong style="color:var(--accent-yellow)">${usage.cpu_p95_millicores ? usage.cpu_p95_millicores.toFixed(0) : '-'}m</strong></span>
                                <span>Utilization: <strong style="color:var(--accent-green)">${current.cpu_utilization_percent ? current.cpu_utilization_percent.toFixed(0) : '-'}%</strong></span>
                                <span>Samples: ${rec.data_points_analyzed || '-'}</span>
                            </div>
                            
                            ${memoryLeakHtml}
                            
                            <div style="font-size:10px;color:var(--text-disabled);margin-top:8px;">Updated: ${new Date(rec.updated_at).toLocaleString()}</div>
                        </div>`;
                }
                
                container.innerHTML = html;
            } catch (err) {
                console.error('Error loading FinOps summary:', err);
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>Error loading recommendations</div></div>`;
            }
        }

        async function loadFinOpsRecommendations() {
            const select = document.getElementById('finops-deployment-select');
            const value = select.value;
            const container = document.getElementById('finops-content');
            
            if (!value) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∞</div><div>Select a deployment to view resource recommendations</div></div>';
                return;
            }
            
            const [ns, dep] = value.split('/');
            container.innerHTML = '<div class="empty-state"><div class="spinner">‚ü≥</div><div>Loading recommendations...</div></div>';
            
            const data = await fetchAPI(`/api/deployment/${ns}/${dep}/recommendations`, true);
            
            if (!data || data.error) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìä</div><div>${data?.error || 'No recommendations available'}</div><div style="margin-top:8px;font-size:11px;color:var(--text-disabled)">${data?.suggestion || 'Need more historical data'}</div></div>`;
                return;
            }
            
            const levelColors = { high: 'high', medium: 'medium', low: 'low', optimal: '' };
            const levelIcons = { high: 'üî¥', medium: 'üü°', low: 'üîµ', optimal: '‚úÖ' };
            
            let html = `
                <div class="recommendation-panel ${levelColors[data.recommendation_level] || ''}">
                    <div class="recommendation-header">
                        <div class="recommendation-title">${levelIcons[data.recommendation_level] || ''} ${data.recommendation_text}</div>
                        <div class="recommendation-savings">Save $${data.savings?.monthly_savings_usd?.toFixed(2) || 0}/mo</div>
                    </div>
                    
                    <div class="recommendation-grid">
                        <div class="recommendation-col">
                            <h4>Current Configuration</h4>
                            <div class="recommendation-item">
                                <span class="label">CPU Request</span>
                                <span class="value old">${data.current?.cpu_request_millicores}m</span>
                            </div>
                            <div class="recommendation-item">
                                <span class="label">Memory Request</span>
                                <span class="value old">${data.current?.memory_request_mb}Mi</span>
                            </div>
                            <div class="recommendation-item">
                                <span class="label">HPA Target</span>
                                <span class="value old">${data.current?.hpa_target_percent}%</span>
                            </div>
                            <div class="recommendation-item">
                                <span class="label">Monthly Cost</span>
                                <span class="value">$${data.current?.monthly_cost_usd?.toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="recommendation-col">
                            <h4>Recommended Configuration</h4>
                            <div class="recommendation-item">
                                <span class="label">CPU Request</span>
                                <span class="value new">${data.recommended?.cpu_request_millicores}m</span>
                            </div>
                            <div class="recommendation-item">
                                <span class="label">Memory Request</span>
                                <span class="value new">${data.recommended?.memory_request_mb}Mi</span>
                            </div>
                            <div class="recommendation-item">
                                <span class="label">HPA Target</span>
                                <span class="value new">${data.recommended?.hpa_target_percent?.toFixed(0)}%</span>
                            </div>
                            <div class="recommendation-item">
                                <span class="label">Monthly Cost</span>
                                <span class="value new">$${data.recommended?.monthly_cost_usd?.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top:16px;">
                        <h4 style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px;">Usage Statistics (${data.data_points_analyzed} samples)</h4>
                        <div class="grid-4">
                            <div class="insight-card">
                                <div class="insight-title">Avg CPU</div>
                                <div class="insight-value" style="color:var(--accent-cyan)">${data.usage_stats?.cpu_avg_millicores?.toFixed(0)}m</div>
                            </div>
                            <div class="insight-card">
                                <div class="insight-title">P95 CPU</div>
                                <div class="insight-value" style="color:var(--accent-yellow)">${data.usage_stats?.cpu_p95_millicores?.toFixed(0)}m</div>
                            </div>
                            <div class="insight-card">
                                <div class="insight-title">Max CPU</div>
                                <div class="insight-value" style="color:var(--accent-red)">${data.usage_stats?.cpu_max_millicores?.toFixed(0)}m</div>
                            </div>
                            <div class="insight-card">
                                <div class="insight-title">Utilization</div>
                                <div class="insight-value" style="color:var(--accent-green)">${data.current?.cpu_utilization_percent?.toFixed(0)}%</div>
                            </div>
                        </div>
                    </div>`;
            
            // Warnings
            if (data.warnings && data.warnings.length > 0) {
                for (const warning of data.warnings) {
                    html += `<div class="recommendation-warning">${warning}</div>`;
                }
            }
            
            // YAML Snippet
            if (data.implementation?.yaml_snippet) {
                html += `
                    <div style="margin-top:16px;">
                        <h4 style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px;">YAML Configuration</h4>
                        <div class="yaml-snippet">${data.implementation.yaml_snippet}</div>
                    </div>`;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        async function loadInsights(ns, dep, force) {
            const insights = await fetchAPI(`/api/ai/insights/${dep}`, force);
            const container = document.getElementById('insights-content');
            
            if (!insights) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üß†</div>Loading insights...</div>';
                return;
            }

            let html = '<div class="grid-2">';
            
            const eff = insights.efficiency || {};
            html += `<div class="insight-card">
                <div class="insight-header">
                    <span class="insight-title">üìä Resource Efficiency</span>
                    <span class="insight-value" style="color:${eff.cpu_efficiency > 70 ? 'var(--accent-green)' : 'var(--accent-yellow)'}">${(eff.cpu_efficiency || 0).toFixed(0)}%</span>
                </div>
                <div class="insight-desc">
                    CPU Usage: ${(eff.avg_cpu_usage || 0).toFixed(1)}% | Request: ${eff.avg_cpu_request || 0}m<br>
                    Based on ${eff.data_points || 0} data points
                </div>
            </div>`;

            const tuning = insights.auto_tuning || {};
            html += `<div class="insight-card">
                <div class="insight-header">
                    <span class="insight-title">üéØ Auto-Tuning</span>
                    <span class="insight-value" style="color:var(--accent-purple)">${tuning.current_optimal || '-'}%</span>
                </div>
                <div class="insight-desc">
                    Learning Rate: ${(tuning.learning_rate || 0.1).toFixed(2)}<br>
                    Samples: ${tuning.samples_collected || 0}
                </div>
            </div>`;

            const pred = insights.prediction_accuracy || {};
            html += `<div class="insight-card">
                <div class="insight-header">
                    <span class="insight-title">üîÆ Prediction Accuracy</span>
                    <span class="insight-value" style="color:var(--accent-cyan)">${((pred.accuracy || 0) * 100).toFixed(0)}%</span>
                </div>
                <div class="insight-desc">
                    MAE: ${(pred.mae || 0).toFixed(3)} | Validated: ${pred.validated_count || 0}<br>
                    Total Predictions: ${pred.total_predictions || 0}
                </div>
            </div>`;

            const patterns = insights.patterns || {};
            html += `<div class="insight-card">
                <div class="insight-header">
                    <span class="insight-title">üìà Learned Patterns</span>
                </div>
                <div class="insight-desc">
                    Peak Hours: ${patterns.peak_hours?.join(', ') || 'Learning...'}<br>
                    Low Hours: ${patterns.low_hours?.join(', ') || 'Learning...'}
                </div>
            </div>`;

            html += '</div>';

            if (insights.scaling_events?.length > 0) {
                html += '<div style="margin-top:16px"><strong>Recent Scaling Events</strong></div>';
                html += '<div style="margin-top:8px">';
                for (const evt of insights.scaling_events.slice(0, 5)) {
                    const icon = evt.action === 'scale_up' ? 'üìà' : evt.action === 'scale_down' ? 'üìâ' : 'üîÑ';
                    const nsInfo = evt.namespace ? `<span style="color:var(--text-disabled)">${evt.namespace}/</span>` : '';
                    html += `<div class="timeline-event">
                        <div class="timeline-icon ${evt.action === 'scale_up' ? 'up' : 'down'}">${icon}</div>
                        <div class="timeline-content">
                            <div><strong>${evt.action}</strong> ‚Üí ${evt.pod_count} pods (HPA: ${evt.hpa_target}%)</div>
                            <div class="timeline-time">${nsInfo}${evt.deployment || ''} ¬∑ ${new Date(evt.timestamp).toLocaleString()}</div>
                        </div>
                    </div>`;
                }
                html += '</div>';
            }

            container.innerHTML = html;
            updateEfficiencyGauge(eff.cpu_efficiency || 0);
        }

        async function loadTimeline(ns, dep, force) {
            const data = await fetchAPI(`/api/scaling/timeline/${dep}`, force);
            const container = document.getElementById('timeline-content');
            
            if (!data || !data.events?.length) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìà</div>No scaling events yet</div>';
                return;
            }

            const nsInfo = data.namespace ? `${data.namespace}/` : '';
            html += `<div style="margin-bottom:12px;color:var(--text-secondary);font-size:12px">${nsInfo}${data.deployment} ¬∑ Total events: ${data.total_events}</div>`;
            
            for (const evt of data.events.slice(0, 20)) {
                let icon, iconClass, title, desc;
                
                if (evt.type === 'scale_up') {
                    icon = '‚Üë'; iconClass = 'up';
                    title = `Scale Up: ${evt.from_pods} ‚Üí ${evt.to_pods} pods`;
                    desc = `CPU: ${evt.cpu_usage}% | Confidence: ${((evt.confidence || 0) * 100).toFixed(0)}%`;
                } else if (evt.type === 'scale_down') {
                    icon = '‚Üì'; iconClass = 'down';
                    title = `Scale Down: ${evt.from_pods} ‚Üí ${evt.to_pods} pods`;
                    desc = `CPU: ${evt.cpu_usage}% | Confidence: ${((evt.confidence || 0) * 100).toFixed(0)}%`;
                } else {
                    icon = '‚öô'; iconClass = 'change';
                    title = `HPA Target: ${evt.from_target}% ‚Üí ${evt.to_target}%`;
                    desc = `Reason: ${evt.reason}`;
                }

                html += `<div class="timeline-event">
                    <div class="timeline-icon ${iconClass}">${icon}</div>
                    <div class="timeline-content">
                        <div><strong>${title}</strong></div>
                        <div style="font-size:11px;color:var(--text-secondary)">${desc}</div>
                        <div class="timeline-time">${new Date(evt.timestamp).toLocaleString()}</div>
                    </div>
                </div>`;
            }

            container.innerHTML = html;
        }

        async function loadPredictions(ns, dep, force) {
            const data = await fetchAPI(`/api/deployment/${ns}/${dep}/predictions`, force);
            const container = document.getElementById('predictions-content');
            
            if (!data?.predictions?.length) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîÆ</div>No predictions yet</div>';
                return;
            }

            if (data.accuracy_stats) {
                const acc = data.accuracy_stats;
                document.getElementById('prediction-stats').textContent = 
                    `Accuracy: ${((acc.accuracy || 0) * 100).toFixed(0)}% | MAE: ${(acc.mae || 0).toFixed(3)}`;
            }

            let html = '';
            for (const pred of data.predictions.slice(0, 10)) {
                const conf = (pred.confidence || 0) * 100;
                const confColor = conf > 70 ? 'var(--accent-green)' : conf > 40 ? 'var(--accent-yellow)' : 'var(--accent-red)';
                
                html += `<div class="insight-card">
                    <div class="insight-header">
                        <span class="insight-title">${pred.action || 'maintain'}</span>
                        <span style="color:${confColor};font-size:12px">${conf.toFixed(0)}% conf</span>
                    </div>
                    <div class="insight-desc">${pred.reasoning || 'No reasoning'}</div>
                    ${pred.validated ? `<div style="margin-top:4px;font-size:10px;color:var(--accent-green)">‚úì Validated | Actual: ${(pred.actual_cpu || 0).toFixed(2)}</div>` : ''}
                    <div class="timeline-time">${new Date(pred.timestamp).toLocaleString()}</div>
                </div>`;
            }
            container.innerHTML = html;
        }

        async function loadCPUHistory(ns, dep, force) {
            const data = await fetchAPI(`/api/deployment/${ns}/${dep}/history?hours=1`, force);
            if (!data?.timestamps) return;

            const ctx = document.getElementById('cpu-chart').getContext('2d');
            if (state.cpuChart) state.cpuChart.destroy();
            
            state.cpuChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.timestamps.map(t => new Date(t).toLocaleTimeString()),
                    datasets: [{
                        label: 'CPU %',
                        data: data.pod_cpu_usage || [],
                        borderColor: '#5794f2',
                        backgroundColor: 'rgba(87, 148, 242, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { beginAtZero: true, max: 100, grid: { color: '#2c3039' }, ticks: { font: { size: 10 } } }
                    }
                }
            });
        }

        function updateEfficiencyGauge(value) {
            const rotation = Math.min(value, 100) * 1.8;
            document.getElementById('efficiency-gauge').style.transform = `rotate(${rotation - 180}deg)`;
            document.getElementById('efficiency-value').textContent = value.toFixed(0) + '%';
            document.getElementById('efficiency-gauge').style.background = 
                value > 70 ? 'var(--accent-green)' : value > 40 ? 'var(--accent-yellow)' : 'var(--accent-red)';
        }

        async function loadHealth(force) {
            const health = await fetchAPI('/api/health', force) || {};
            document.getElementById('prom-status').className = 'status-dot ' + (health.prometheus === 'healthy' ? 'healthy' : 'error');
            document.getElementById('k8s-status').className = 'status-dot ' + (health.kubernetes === 'healthy' ? 'healthy' : 'error');
            document.getElementById('db-status').className = 'status-dot ' + (health.database === 'healthy' ? 'healthy' : 'error');

            document.getElementById('health-metrics').innerHTML = `
                <div class="metric-row"><span class="metric-label">Prometheus</span><span class="badge ${health.prometheus === 'healthy' ? 'healthy' : 'critical'}">${health.prometheus || 'unknown'}</span></div>
                <div class="metric-row"><span class="metric-label">Kubernetes</span><span class="badge ${health.kubernetes === 'healthy' ? 'healthy' : 'critical'}">${health.kubernetes || 'unknown'}</span></div>
                <div class="metric-row"><span class="metric-label">Database</span><span class="badge ${health.database === 'healthy' ? 'healthy' : 'critical'}">${health.database || 'unknown'}</span></div>
                <div class="metric-row"><span class="metric-label">Degraded</span><span class="badge ${health.degraded ? 'warning' : 'healthy'}">${health.degraded ? 'Yes' : 'No'}</span></div>
            `;
        }

        async function loadConfig(force) {
            const config = await fetchAPI('/api/config/status', force);
            if (!config) return;
            
            // Update version in header
            const version = config.current_config?.version || '0.0.18';
            document.getElementById('version').textContent = 'v' + version;
            
            const c = config.current_config || {};
            document.getElementById('config-content').innerHTML = `
                <div class="metric-row"><span class="metric-label">App Version</span><span class="metric-value" style="color:var(--accent-cyan)">v${version}</span></div>
                <div class="metric-row"><span class="metric-label">Config Version</span><span class="metric-value">${config.config_version || '-'}</span></div>
                <div class="metric-row"><span class="metric-label">Check Interval</span><span class="metric-value">${c.check_interval || 30}s</span></div>
                <div class="metric-row"><span class="metric-label">Target Utilization</span><span class="metric-value">${c.target_node_utilization || 40}%</span></div>
                <div class="metric-row"><span class="metric-label">Dry Run</span><span class="badge ${c.dry_run ? 'warning' : 'healthy'}">${c.dry_run ? 'Yes' : 'No'}</span></div>
                <div class="metric-row"><span class="metric-label">Predictive</span><span class="badge ${c.enable_predictive ? 'healthy' : 'warning'}">${c.enable_predictive ? 'On' : 'Off'}</span></div>
                <div class="metric-row"><span class="metric-label">Auto-tuning</span><span class="badge ${c.enable_autotuning ? 'healthy' : 'warning'}">${c.enable_autotuning ? 'On' : 'Off'}</span></div>
            `;
        }

        async function reloadConfig() {
            const res = await fetch('/api/config/reload', { method: 'POST' });
            const data = await res.json();
            alert(data.success ? 'Config reloaded!' : 'Failed: ' + data.error);
            loadConfig(true);
        }

        function refreshData() { state.countdown = 30; loadData(true); }
        
        // Cluster monitoring
        let clusterCpuChart = null;
        let clusterMemChart = null;
        
        async function loadClusterMetrics() {
            try {
                const res = await fetch('/api/cluster/metrics');
                if (!res.ok) return;
                const data = await res.json();
                if (data.error) return;
                
                const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
                
                setEl('cluster-node-count', data.node_count || 0);
                setEl('cluster-pod-count', data.pod_count || '-');
                
                const cpuHealth = data.summary?.cpu?.usage_percent || 0;
                const memHealth = data.summary?.memory?.usage_percent || 0;
                const overallHealth = Math.max(cpuHealth, memHealth);
                const healthStatus = overallHealth > 85 ? 'Critical' : overallHealth > 70 ? 'Warning' : 'Healthy';
                const healthColor = overallHealth > 85 ? 'var(--accent-red)' : overallHealth > 70 ? 'var(--accent-yellow)' : 'var(--accent-green)';
                
                const healthEl = document.getElementById('cluster-health');
                if (healthEl) { healthEl.textContent = healthStatus; healthEl.style.color = healthColor; }
                
                if (data.summary?.cpu) {
                    setEl('cpu-capacity', (data.summary.cpu.capacity || 0).toFixed(1) + ' cores');
                    setEl('cpu-allocatable', (data.summary.cpu.allocatable || 0).toFixed(1) + ' cores');
                    setEl('cpu-requests', (data.summary.cpu.requests || 0).toFixed(1) + ' cores');
                    setEl('cpu-requests-pct', (data.summary.cpu.requests_percent || 0).toFixed(1) + '% of allocatable');
                    setEl('cpu-usage', (data.summary.cpu.usage || 0).toFixed(1) + ' cores');
                    setEl('cpu-usage-pct', (data.summary.cpu.usage_percent || 0).toFixed(1) + '% of allocatable');
                    
                    const cpuPct = data.summary.cpu.usage_percent || 0;
                    const cpuBar = document.getElementById('cpu-usage-bar');
                    if (cpuBar) {
                        cpuBar.style.width = Math.min(cpuPct, 100) + '%';
                        cpuBar.style.background = cpuPct > 85 ? 'var(--accent-red)' : cpuPct > 70 ? 'var(--accent-yellow)' : 'var(--accent-green)';
                    }
                }
                
                if (data.summary?.memory) {
                    setEl('mem-capacity', (data.summary.memory.capacity_gb || 0).toFixed(1) + ' GB');
                    setEl('mem-allocatable', (data.summary.memory.allocatable_gb || 0).toFixed(1) + ' GB');
                    setEl('mem-requests', (data.summary.memory.requests_gb || 0).toFixed(1) + ' GB');
                    setEl('mem-requests-pct', (data.summary.memory.requests_percent || 0).toFixed(1) + '% of allocatable');
                    setEl('mem-usage', (data.summary.memory.usage_gb || 0).toFixed(1) + ' GB');
                    setEl('mem-usage-pct', (data.summary.memory.usage_percent || 0).toFixed(1) + '% of allocatable');
                    
                    const memPct = data.summary.memory.usage_percent || 0;
                    const memBar = document.getElementById('mem-usage-bar');
                    if (memBar) {
                        memBar.style.width = Math.min(memPct, 100) + '%';
                        memBar.style.background = memPct > 85 ? 'var(--accent-red)' : memPct > 70 ? 'var(--accent-yellow)' : 'var(--accent-purple)';
                    }
                }
                
                let nodesHtml = '';
                for (const node of data.nodes) {
                    const cpuPct = (node.cpu_usage / node.cpu_allocatable * 100).toFixed(1);
                    const memPct = (node.memory_usage_gb / node.memory_allocatable_gb * 100).toFixed(1);
                    const nodeStatus = Math.max(parseFloat(cpuPct), parseFloat(memPct)) > 85 ? 'critical' : 
                                      Math.max(parseFloat(cpuPct), parseFloat(memPct)) > 70 ? 'warning' : 'healthy';
                    
                    nodesHtml += `<tr>
                        <td><strong>${node.name}</strong></td>
                        <td>${node.cpu_allocatable} cores</td>
                        <td>${node.cpu_usage.toFixed(2)} cores</td>
                        <td>${cpuPct}%<div class="progress-bar"><div class="progress-fill ${nodeStatus}" style="width:${Math.min(cpuPct, 100)}%"></div></div></td>
                        <td>${node.memory_allocatable_gb.toFixed(1)} GB</td>
                        <td>${node.memory_usage_gb.toFixed(1)} GB</td>
                        <td>${memPct}%<div class="progress-bar"><div class="progress-fill ${nodeStatus}" style="width:${Math.min(memPct, 100)}%"></div></div></td>
                        <td><span class="badge ${nodeStatus}">${nodeStatus}</span></td>
                    </tr>`;
                }
                document.getElementById('nodes-body').innerHTML = nodesHtml || '<tr><td colspan="8" class="empty-state">No nodes found</td></tr>';
                
                loadClusterHistory();
            } catch (err) { console.error('Error loading cluster metrics:', err); }
        }
        
        async function loadClusterHistory() {
            try {
                const res = await fetch('/api/cluster/history?hours=24');
                const data = await res.json();
                
                if (data.error || !data.history || data.history.length === 0) return;
                
                const timestamps = data.history.map(h => h.timestamp);
                const cpuRequests = data.history.map(h => h.total_cpu_request_millicores / 1000);
                const cpuUsage = data.history.map(h => h.total_cpu_usage_millicores / 1000);
                const memRequests = data.history.map(h => h.total_memory_request_mb / 1024);
                const memUsage = data.history.map(h => h.total_memory_usage_mb / 1024);
                
                const cpuCtx = document.getElementById('cluster-cpu-history-chart');
                if (cpuCtx) {
                    if (clusterCpuChart) clusterCpuChart.destroy();
                    clusterCpuChart = new Chart(cpuCtx, {
                        type: 'line',
                        data: {
                            labels: timestamps,
                            datasets: [
                                { label: 'Requests', data: cpuRequests, borderColor: '#fade2a', backgroundColor: 'rgba(250,222,42,0.1)', tension: 0.4, fill: true, pointRadius: 0, borderWidth: 2 },
                                { label: 'Usage', data: cpuUsage, borderColor: '#73bf69', backgroundColor: 'rgba(115,191,105,0.1)', tension: 0.4, fill: true, pointRadius: 0, borderWidth: 2 }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top', labels: { boxWidth: 12, font: { size: 10 } } } }, scales: { y: { beginAtZero: true }, x: { display: false } } }
                    });
                }
                
                const memCtx = document.getElementById('cluster-mem-history-chart');
                if (memCtx) {
                    if (clusterMemChart) clusterMemChart.destroy();
                    clusterMemChart = new Chart(memCtx, {
                        type: 'line',
                        data: {
                            labels: timestamps,
                            datasets: [
                                { label: 'Requests', data: memRequests, borderColor: '#fade2a', backgroundColor: 'rgba(250,222,42,0.1)', tension: 0.4, fill: true, pointRadius: 0, borderWidth: 2 },
                                { label: 'Usage', data: memUsage, borderColor: '#b877d9', backgroundColor: 'rgba(184,119,217,0.1)', tension: 0.4, fill: true, pointRadius: 0, borderWidth: 2 }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top', labels: { boxWidth: 12, font: { size: 10 } } } }, scales: { y: { beginAtZero: true }, x: { display: false } } }
                    });
                }
            } catch (err) { console.error('Error loading cluster history:', err); }
        }
        
        document.getElementById('namespace-filter').addEventListener('change', function() {
            const selectedNs = this.value;
            document.querySelectorAll('#deployments-body tr').forEach(row => {
                if (selectedNs === 'all') row.style.display = '';
                else {
                    const nsText = row.querySelector('small')?.textContent || '';
                    row.style.display = nsText === selectedNs ? '' : 'none';
                }
            });
        });

        // Cost Trends Chart
        let costTrendsChart = null;
        
        async function loadCostTrends() {
            try {
                const res = await fetch('/api/finops/cost-trends?days=30');
                const data = await res.json();
                
                if (data.error || !data.daily_summary || data.daily_summary.length === 0) {
                    document.getElementById('cost-trend-summary').textContent = 'No data';
                    return;
                }
                
                // Update summary
                const s = data.summary || {};
                document.getElementById('cost-trend-summary').textContent = 
                    `Total: $${s.total_cost?.toFixed(0) || 0} | Wasted: $${s.total_wasted?.toFixed(0) || 0} | Efficiency: ${s.efficiency?.toFixed(0) || 0}%`;
                
                const ctx = document.getElementById('cost-trends-chart');
                if (!ctx) return;
                
                if (costTrendsChart) costTrendsChart.destroy();
                
                const labels = data.daily_summary.map(d => d.date);
                const costs = data.daily_summary.map(d => d.cost);
                const wasted = data.daily_summary.map(d => d.wasted);
                
                costTrendsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Actual Cost',
                                data: data.daily_summary.map(d => d.actual),
                                backgroundColor: 'rgba(115, 191, 105, 0.8)',
                                borderColor: '#73bf69',
                                borderWidth: 1
                            },
                            {
                                label: 'Wasted',
                                data: wasted,
                                backgroundColor: 'rgba(242, 73, 92, 0.8)',
                                borderColor: '#f2495c',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top', labels: { boxWidth: 12, font: { size: 10 } } }
                        },
                        scales: {
                            x: { stacked: true, display: true, ticks: { maxRotation: 45, font: { size: 9 } } },
                            y: { stacked: true, beginAtZero: true, ticks: { callback: v => '$' + v } }
                        }
                    }
                });
            } catch (err) {
                console.error('Error loading cost trends:', err);
            }
        }
        
        // Prediction Accuracy Charts
        let predictionAccuracyChart = null;
        let dailyAccuracyChart = null;
        
        async function loadPredictionAccuracy() {
            if (!state.currentDep) {
                document.getElementById('predictions-content').innerHTML = 
                    '<div class="empty-state"><div class="empty-state-icon">üîÆ</div><div>Select a deployment first</div></div>';
                return;
            }
            
            const [ns, dep] = state.currentDep.split('/');
            
            try {
                const res = await fetch(`/api/predictions/accuracy/${dep}?hours=168`);
                const data = await res.json();
                
                if (data.error) {
                    document.getElementById('predictions-content').innerHTML = 
                        `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>${data.error}</div></div>`;
                    return;
                }
                
                // Update stats
                const stats = data.stats || {};
                document.getElementById('prediction-stats').textContent = 
                    `Accuracy: ${stats.accuracy_rate?.toFixed(0) || 0}% | Total: ${stats.total_predictions || 0} | FP: ${stats.false_positives || 0}`;
                
                // Prediction vs Actual Chart
                if (data.history && data.history.length > 0) {
                    const ctx1 = document.getElementById('prediction-accuracy-chart');
                    if (ctx1) {
                        if (predictionAccuracyChart) predictionAccuracyChart.destroy();
                        
                        const labels = data.history.map(h => new Date(h.timestamp).toLocaleDateString());
                        const predicted = data.history.map(h => h.predicted);
                        const actual = data.history.map(h => h.actual);
                        
                        predictionAccuracyChart = new Chart(ctx1, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'Predicted',
                                        data: predicted,
                                        borderColor: '#5794f2',
                                        backgroundColor: 'rgba(87, 148, 242, 0.1)',
                                        tension: 0.4,
                                        pointRadius: 2,
                                        borderWidth: 2
                                    },
                                    {
                                        label: 'Actual',
                                        data: actual,
                                        borderColor: '#73bf69',
                                        backgroundColor: 'rgba(115, 191, 105, 0.1)',
                                        tension: 0.4,
                                        pointRadius: 2,
                                        borderWidth: 2
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: true, position: 'top', labels: { boxWidth: 12, font: { size: 10 } } } },
                                scales: {
                                    x: { display: false },
                                    y: { beginAtZero: true, max: 100, title: { display: true, text: 'CPU %' } }
                                }
                            }
                        });
                    }
                }
                
                // Daily Accuracy Chart
                if (data.daily_summary && data.daily_summary.length > 0) {
                    const ctx2 = document.getElementById('daily-accuracy-chart');
                    if (ctx2) {
                        if (dailyAccuracyChart) dailyAccuracyChart.destroy();
                        
                        dailyAccuracyChart = new Chart(ctx2, {
                            type: 'bar',
                            data: {
                                labels: data.daily_summary.map(d => d.date),
                                datasets: [{
                                    label: 'Accuracy %',
                                    data: data.daily_summary.map(d => d.accuracy),
                                    backgroundColor: data.daily_summary.map(d => 
                                        d.accuracy > 80 ? 'rgba(115, 191, 105, 0.8)' :
                                        d.accuracy > 60 ? 'rgba(250, 222, 42, 0.8)' :
                                        'rgba(242, 73, 92, 0.8)'
                                    ),
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    x: { display: true, ticks: { maxRotation: 45, font: { size: 9 } } },
                                    y: { beginAtZero: true, max: 100, title: { display: true, text: 'Accuracy %' } }
                                }
                            }
                        });
                    }
                }
                
                // Prediction History List
                let html = '<div style="margin-top:16px;"><strong>Recent Validated Predictions</strong></div>';
                if (data.history && data.history.length > 0) {
                    html += '<div style="margin-top:8px;">';
                    for (const pred of data.history.slice(-20).reverse()) {
                        const accColor = pred.accuracy > 0.8 ? 'var(--accent-green)' : 
                                        pred.accuracy > 0.6 ? 'var(--accent-yellow)' : 'var(--accent-red)';
                        html += `<div class="insight-card">
                            <div class="insight-header">
                                <span class="insight-title">${pred.action || 'maintain'}</span>
                                <span style="color:${accColor};font-size:12px">${((pred.accuracy || 0) * 100).toFixed(0)}% accurate</span>
                            </div>
                            <div style="font-size:11px;color:var(--text-secondary);">
                                Predicted: ${pred.predicted?.toFixed(1) || '-'}% | Actual: ${pred.actual?.toFixed(1) || '-'}%
                            </div>
                            <div class="timeline-time">${new Date(pred.timestamp).toLocaleString()}</div>
                        </div>`;
                    }
                    html += '</div>';
                } else {
                    html += '<div class="empty-state" style="padding:20px;"><div>No validated predictions yet</div></div>';
                }
                
                document.getElementById('predictions-content').innerHTML = html;
                
            } catch (err) {
                console.error('Error loading prediction accuracy:', err);
                document.getElementById('predictions-content').innerHTML = 
                    '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>Error loading predictions</div></div>';
            }
        }
        
        // Alerts
        async function loadAlerts() {
            const container = document.getElementById('alerts-content');
            const summaryEl = document.getElementById('alerts-summary');
            
            try {
                const res = await fetch('/api/alerts/recent?hours=24');
                const data = await res.json();
                
                if (data.error) {
                    container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>${data.error}</div></div>`;
                    return;
                }
                
                // Update summary
                const s = data.summary || {};
                summaryEl.innerHTML = `
                    <span style="color:var(--accent-red)">üî¥ ${s.critical || 0}</span> ¬∑ 
                    <span style="color:var(--accent-yellow)">üü° ${s.warning || 0}</span> ¬∑ 
                    <span style="color:var(--accent-cyan)">‚ÑπÔ∏è ${s.info || 0}</span>
                `;
                
                if (!data.alerts || data.alerts.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><div>No alerts in the last 24 hours</div></div>';
                    return;
                }
                
                let html = '';
                for (const alert of data.alerts) {
                    const severityColors = {
                        'critical': 'var(--accent-red)',
                        'warning': 'var(--accent-yellow)',
                        'info': 'var(--accent-cyan)'
                    };
                    const severityIcons = {
                        'critical': 'üî¥',
                        'warning': 'üü°',
                        'info': '‚ÑπÔ∏è'
                    };
                    const sev = (alert.severity || 'info').toLowerCase();
                    
                    html += `<div class="recommendation-panel" style="border-left-color:${severityColors[sev] || 'var(--text-secondary)'};">
                        <div class="recommendation-header">
                            <div class="recommendation-title">
                                ${severityIcons[sev] || '‚ùì'} <strong>${alert.deployment}</strong>
                                <span class="badge ${sev === 'critical' ? 'critical' : sev === 'warning' ? 'warning' : 'info'}">${alert.type}</span>
                            </div>
                            <span style="font-size:11px;color:var(--text-secondary)">${new Date(alert.timestamp).toLocaleString()}</span>
                        </div>
                        <div style="font-size:12px;margin-top:8px;">${alert.description}</div>
                        ${alert.current_value !== null ? `
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:4px;">
                                Current: ${alert.current_value} | Expected: ${alert.expected_value} | Deviation: ${alert.deviation_percent}%
                            </div>
                        ` : ''}
                    </div>`;
                }
                
                container.innerHTML = html;
                
            } catch (err) {
                console.error('Error loading alerts:', err);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>Error loading alerts</div></div>';
            }
        }
        
        // HPA Analysis
        async function loadHpaAnalysis() {
            const container = document.getElementById('hpa-analysis-content');
            
            if (!state.currentDep) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üõ°Ô∏è</div><div>Select a deployment from the Deployments tab to analyze HPA behavior</div></div>';
                return;
            }
            
            const [ns, dep] = state.currentDep.split('/');
            container.innerHTML = '<div class="empty-state"><div class="spinner">‚ü≥</div><div>Analyzing HPA behavior...</div></div>';
            
            try {
                const res = await fetch(`/api/deployment/${ns}/${dep}/hpa-analysis`);
                const data = await res.json();
                
                if (data.error) {
                    container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>${data.error}</div></div>`;
                    return;
                }
                
                const riskColors = {
                    'low': 'var(--accent-green)',
                    'medium': 'var(--accent-yellow)',
                    'high': 'var(--accent-red)'
                };
                const riskIcons = {
                    'low': '‚úÖ',
                    'medium': 'üü°',
                    'high': 'üî¥'
                };
                
                const analysis = data.analysis || {};
                const hpaConfig = data.hpa_config || {};
                const scalingFreq = data.scaling_frequency || {};
                
                let html = `
                    <!-- Risk Summary -->
                    <div class="recommendation-panel" style="border-left-color:${riskColors[analysis.risk_level] || 'var(--text-secondary)'};">
                        <div class="recommendation-header">
                            <div class="recommendation-title">
                                ${riskIcons[analysis.risk_level] || '‚ùì'} Risk Level: <strong>${(analysis.risk_level || 'unknown').toUpperCase()}</strong>
                            </div>
                            <span class="badge ${analysis.risk_level === 'high' ? 'critical' : analysis.risk_level === 'medium' ? 'warning' : 'healthy'}">${data.pattern || 'unknown'} pattern</span>
                        </div>
                        <div style="font-size:12px;margin-top:8px;">${analysis.summary || 'No analysis available'}</div>
                    </div>
                    
                    <!-- Current HPA Config -->
                    <div class="grid-2" style="margin-top:16px;">
                        <div class="resource-card">
                            <div class="resource-header">
                                <div class="resource-icon cpu">‚öôÔ∏è</div>
                                <span>Current HPA Config</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">HPA Name</span>
                                <span class="metric-value">${hpaConfig.name || '-'}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Min/Max Replicas</span>
                                <span class="metric-value">${hpaConfig.min_replicas || '-'} / ${hpaConfig.max_replicas || '-'}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Target CPU</span>
                                <span class="metric-value">${hpaConfig.target_cpu_percent || '-'}%</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Current Replicas</span>
                                <span class="metric-value">${hpaConfig.current_replicas || '-'}</span>
                            </div>
                        </div>
                        
                        <div class="resource-card">
                            <div class="resource-header">
                                <div class="resource-icon memory">üìä</div>
                                <span>Scaling Frequency</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Events (24h)</span>
                                <span class="metric-value" style="color:${scalingFreq.events_24h > 20 ? 'var(--accent-red)' : 'var(--text-primary)'}">${scalingFreq.events_24h || 0}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Events (1h)</span>
                                <span class="metric-value" style="color:${scalingFreq.events_1h > 5 ? 'var(--accent-red)' : 'var(--text-primary)'}">${scalingFreq.events_1h || 0}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Flapping Detected</span>
                                <span class="metric-value">${scalingFreq.is_flapping ? '<span style="color:var(--accent-red)">‚ö†Ô∏è YES</span>' : '<span style="color:var(--accent-green)">‚úÖ NO</span>'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Behavior Config -->
                    <div class="grid-2" style="margin-top:16px;">
                        <div class="resource-card">
                            <div class="resource-header">
                                <div class="resource-icon cpu">‚¨ÜÔ∏è</div>
                                <span>Scale Up Behavior</span>
                            </div>
                            ${hpaConfig.behavior?.scale_up ? `
                                <div class="metric-row">
                                    <span class="metric-label">Stabilization Window</span>
                                    <span class="metric-value">${hpaConfig.behavior.scale_up.stabilization_window_seconds || 0}s</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Select Policy</span>
                                    <span class="metric-value">${hpaConfig.behavior.scale_up.select_policy || 'Max'}</span>
                                </div>
                                ${(hpaConfig.behavior.scale_up.policies || []).map(p => `
                                    <div class="metric-row">
                                        <span class="metric-label">Policy</span>
                                        <span class="metric-value">${p.type}: ${p.value} / ${p.period_seconds}s</span>
                                    </div>
                                `).join('')}
                            ` : '<div style="color:var(--text-secondary);font-size:12px;">Not configured (using K8s defaults)</div>'}
                        </div>
                        
                        <div class="resource-card">
                            <div class="resource-header">
                                <div class="resource-icon memory">‚¨áÔ∏è</div>
                                <span>Scale Down Behavior</span>
                            </div>
                            ${hpaConfig.behavior?.scale_down ? `
                                <div class="metric-row">
                                    <span class="metric-label">Stabilization Window</span>
                                    <span class="metric-value">${hpaConfig.behavior.scale_down.stabilization_window_seconds || 0}s</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Select Policy</span>
                                    <span class="metric-value">${hpaConfig.behavior.scale_down.select_policy || 'Min'}</span>
                                </div>
                                ${(hpaConfig.behavior.scale_down.policies || []).map(p => `
                                    <div class="metric-row">
                                        <span class="metric-label">Policy</span>
                                        <span class="metric-value">${p.type}: ${p.value} / ${p.period_seconds}s</span>
                                    </div>
                                `).join('')}
                            ` : '<div style="color:var(--text-secondary);font-size:12px;">Not configured (using K8s defaults)</div>'}
                        </div>
                    </div>
                `;
                
                // Issues
                if (analysis.issues && analysis.issues.length > 0) {
                    html += `
                        <div style="margin-top:16px;">
                            <h4 style="font-size:13px;margin-bottom:8px;color:var(--text-primary);">‚ö†Ô∏è Issues Found</h4>
                            ${analysis.issues.map(issue => `
                                <div class="recommendation-panel ${issue.severity}" style="margin-bottom:8px;">
                                    <div style="font-size:12px;">
                                        <strong>${issue.type}</strong>: ${issue.message}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Recommendations
                if (analysis.recommendations && analysis.recommendations.length > 0) {
                    html += `
                        <div style="margin-top:16px;">
                            <h4 style="font-size:13px;margin-bottom:8px;color:var(--text-primary);">üí° Recommendations</h4>
                            ${analysis.recommendations.map(rec => `
                                <div class="recommendation-panel low" style="margin-bottom:8px;">
                                    <div style="font-size:12px;">
                                        <strong>${rec.type}</strong>
                                        ${rec.current !== null ? `<br>Current: <code>${rec.current}</code> ‚Üí Recommended: <code>${rec.recommended}</code>` : ''}
                                        <br><span style="color:var(--text-secondary)">${rec.reason}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // YAML Snippet
                if (analysis.yaml_snippet) {
                    html += `
                        <div style="margin-top:16px;">
                            <h4 style="font-size:13px;margin-bottom:8px;color:var(--text-primary);">üìã Recommended HPA Config</h4>
                            <div class="yaml-snippet">${analysis.yaml_snippet}</div>
                            <button class="btn" style="margin-top:8px;" onclick="navigator.clipboard.writeText(\`${analysis.yaml_snippet.replace(/`/g, '\\`')}\`).then(() => alert('Copied to clipboard!'))">üìã Copy YAML</button>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
            } catch (err) {
                console.error('Error loading HPA analysis:', err);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>Error loading HPA analysis</div></div>';
            }
        }

        setInterval(() => {
            state.countdown--;
            document.getElementById('countdown').textContent = state.countdown;
            if (state.countdown <= 0) { state.countdown = 30; loadData(true); }
        }, 1000);

        loadData();
    </script>
</body>
</html>
