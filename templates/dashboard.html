<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Autoscaler Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --accent-cyan: #06b6d4;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: 14px;
        }
        .navbar {
            background: var(--bg-secondary);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--bg-tertiary);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { font-size: 1.2em; font-weight: bold; color: var(--accent-blue); display: flex; align-items: center; gap: 8px; }
        .nav-status { display: flex; gap: 12px; align-items: center; font-size: 0.85em; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .status-dot.healthy { background: var(--accent-green); box-shadow: 0 0 6px var(--accent-green); }
        .status-dot.error { background: var(--accent-red); box-shadow: 0 0 6px var(--accent-red); }
        .container { max-width: 1900px; margin: 0 auto; padding: 12px; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
            margin-bottom: 12px;
        }
        @media (max-width: 1600px) { .stats-grid { grid-template-columns: repeat(4, 1fr); } }
        @media (max-width: 900px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .stat-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--bg-tertiary);
        }
        .stat-label { font-size: 0.7em; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 1.4em; font-weight: bold; }
        .stat-value.blue { color: var(--accent-blue); }
        .stat-value.green { color: var(--accent-green); }
        .stat-value.yellow { color: var(--accent-yellow); }
        .stat-value.red { color: var(--accent-red); }
        .stat-value.purple { color: var(--accent-purple); }
        .stat-value.cyan { color: var(--accent-cyan); }
        .stat-sub { font-size: 0.7em; color: var(--text-secondary); margin-top: 2px; }
        
        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 6px 14px;
            background: transparent;
            border: 1px solid var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.85em;
        }
        .tab:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .tab.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 12px;
        }
        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } }
        
        .card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--bg-tertiary);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--bg-tertiary);
        }
        .card-title { font-size: 0.95em; font-weight: 600; }
        .card-btn {
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75em;
        }
        .card-btn:hover { background: var(--accent-blue); color: white; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--bg-tertiary); }
        th { color: var(--text-secondary); font-weight: 500; font-size: 0.75em; text-transform: uppercase; }
        tr:hover { background: rgba(59, 130, 246, 0.1); }
        tr.clickable { cursor: pointer; }
        
        .badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge.healthy { background: #166534; color: #86efac; }
        .badge.warning { background: #854d0e; color: #fde047; }
        .badge.critical { background: #991b1b; color: #fca5a5; }
        .badge.info { background: #1e40af; color: #93c5fd; }
        .badge.steady { background: #1e40af; color: #93c5fd; }
        .badge.bursty { background: #7c2d12; color: #fdba74; }
        .badge.growing { background: #166534; color: #86efac; }
        .badge.unknown { background: #475569; color: #94a3b8; }
        
        .chart-container { height: 160px; }
        .chart-container-lg { height: 220px; }
        
        .sidebar-card { margin-bottom: 10px; }
        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--bg-tertiary);
            font-size: 0.85em;
        }
        .metric-row:last-child { border-bottom: none; }
        .metric-label { color: var(--text-secondary); }
        .metric-value { font-weight: 600; }
        
        .progress-bar {
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }
        .progress-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }
        .progress-fill.green, .progress-fill.healthy { background: var(--accent-green); }
        .progress-fill.yellow, .progress-fill.warning { background: var(--accent-yellow); }
        .progress-fill.red, .progress-fill.critical { background: var(--accent-red); }
        .progress-fill.blue { background: var(--accent-blue); }
        
        .insight-card {
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .insight-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .insight-title { font-weight: 600; font-size: 0.9em; display: flex; align-items: center; gap: 6px; }
        .insight-value { font-size: 1.1em; font-weight: bold; }
        .insight-desc { font-size: 0.8em; color: var(--text-secondary); }
        
        .timeline-event {
            display: flex;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--bg-tertiary);
            font-size: 0.85em;
        }
        .timeline-event:last-child { border-bottom: none; }
        .timeline-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            flex-shrink: 0;
        }
        .timeline-icon.up { background: rgba(34, 197, 94, 0.2); color: var(--accent-green); }
        .timeline-icon.down { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .timeline-icon.change { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }
        .timeline-content { flex: 1; }
        .timeline-time { font-size: 0.75em; color: var(--text-secondary); }
        
        .gauge-container { text-align: center; padding: 10px; }
        .gauge { position: relative; width: 120px; height: 60px; margin: 0 auto; overflow: hidden; }
        .gauge-bg { position: absolute; width: 120px; height: 60px; border-radius: 60px 60px 0 0; background: var(--bg-tertiary); }
        .gauge-fill { position: absolute; width: 120px; height: 60px; border-radius: 60px 60px 0 0; background: var(--accent-green); transform-origin: center bottom; }
        .gauge-cover { position: absolute; width: 90px; height: 45px; border-radius: 45px 45px 0 0; background: var(--bg-secondary); top: 15px; left: 15px; }
        .gauge-value { position: absolute; bottom: 0; width: 100%; text-align: center; font-size: 1.2em; font-weight: bold; }
        .gauge-label { font-size: 0.75em; color: var(--text-secondary); margin-top: 4px; }
        
        .empty-state { text-align: center; padding: 30px 15px; color: var(--text-secondary); }
        .empty-state-icon { font-size: 1.8em; margin-bottom: 8px; }
        
        .refresh-indicator {
            position: fixed;
            bottom: 12px;
            right: 12px;
            background: var(--bg-secondary);
            padding: 6px 12px;
            border-radius: 16px;
            border: 1px solid var(--bg-tertiary);
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 600px) { .grid-2 { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">üöÄ Smart Autoscaler <span style="font-size:0.6em;color:var(--text-secondary)" id="version">v-</span></div>
        <div class="nav-status">
            <span><span class="status-dot healthy" id="prom-status"></span>Prom</span>
            <span><span class="status-dot healthy" id="k8s-status"></span>K8s</span>
            <span><span class="status-dot healthy" id="db-status"></span>DB</span>
            <span id="last-update" style="color:var(--text-secondary)">--:--</span>
        </div>
    </nav>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Deployments</div>
                <div class="stat-value blue" id="stat-deployments">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Pods</div>
                <div class="stat-value blue" id="stat-pods">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg CPU</div>
                <div class="stat-value green" id="stat-cpu">-%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Efficiency</div>
                <div class="stat-value cyan" id="stat-efficiency">-%</div>
                <div class="stat-sub" id="stat-efficiency-sub">resource utilization</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Monthly Cost</div>
                <div class="stat-value yellow" id="stat-cost">$-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Savings</div>
                <div class="stat-value green" id="stat-savings">$-</div>
                <div class="stat-sub">potential/month</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Predictions</div>
                <div class="stat-value purple" id="stat-accuracy">-%</div>
                <div class="stat-sub">accuracy</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Scale Events</div>
                <div class="stat-value red" id="stat-events">-</div>
                <div class="stat-sub">last 24h</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="deployments">üìä Deployments</button>
            <button class="tab" data-tab="cluster">üñ•Ô∏è Cluster</button>
            <button class="tab" data-tab="insights">üß† AI Insights</button>
            <button class="tab" data-tab="timeline">üìà Timeline</button>
            <button class="tab" data-tab="costs">üí∞ Costs</button>
            <button class="tab" data-tab="predictions">üîÆ Predictions</button>
            <button class="tab" data-tab="config">‚öôÔ∏è Config</button>
        </div>
        
        <!-- Namespace Filter -->
        <div style="margin-bottom:12px;display:flex;gap:8px;align-items:center;">
            <label style="color:var(--text-secondary);font-size:0.85em;">Filter by Namespace:</label>
            <select id="namespace-filter" style="background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--bg-tertiary);padding:6px 12px;border-radius:6px;font-size:0.85em;">
                <option value="all">All Namespaces</option>
            </select>
        </div>

        <div class="main-grid">
            <div class="main-content">
                <!-- Deployments Tab -->
                <div class="card tab-content" id="tab-deployments">
                    <div class="card-header">
                        <span class="card-title">Watched Deployments</span>
                        <button class="card-btn" onclick="refreshData()">üîÑ Refresh</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Deployment</th>
                                <th>Priority</th>
                                <th>CPU Usage</th>
                                <th>CPU Req</th>
                                <th>Mem Req</th>
                                <th>Pods</th>
                                <th>HPA</th>
                                <th>Pattern</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="deployments-body"></tbody>
                    </table>
                </div>

                <!-- Cluster Monitoring Tab -->
                <div class="card tab-content" id="tab-cluster" style="display:none">
                    <div class="card-header">
                        <span class="card-title">üñ•Ô∏è Cluster Monitoring</span>
                        <button class="card-btn" onclick="loadClusterMetrics()">üîÑ Refresh</button>
                    </div>
                    
                    <!-- Cluster Summary -->
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;">
                        <div class="stat-card">
                            <div class="stat-label">Nodes</div>
                            <div class="stat-value blue" id="cluster-node-count">-</div>
                            <div class="stat-sub">active nodes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Pods</div>
                            <div class="stat-value green" id="cluster-pod-count">-</div>
                            <div class="stat-sub">across cluster</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Cluster Health</div>
                            <div class="stat-value cyan" id="cluster-health">-</div>
                            <div class="stat-sub">overall status</div>
                        </div>
                    </div>
                    
                    <!-- CPU Dashboard -->
                    <div style="background:var(--bg-tertiary);padding:16px;border-radius:8px;margin-bottom:16px;">
                        <h3 style="margin-bottom:12px;color:var(--accent-blue);">üíª CPU Resources</h3>
                        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px;">
                            <div>
                                <div style="font-size:0.75em;color:var(--text-secondary);margin-bottom:4px;">Capacity</div>
                                <div style="font-size:1.3em;font-weight:bold;" id="cpu-capacity">- cores</div>
                            </div>
                            <div>
                                <div style="font-size:0.75em;color:var(--text-secondary);margin-bottom:4px;">Allocatable</div>
                                <div style="font-size:1.3em;font-weight:bold;" id="cpu-allocatable">- cores</div>
                            </div>
                            <div>
                                <div style="font-size:0.75em;color:var(--text-secondary);margin-bottom:4px;">Requested</div>
                                <div style="font-size:1.3em;font-weight:bold;color:var(--accent-yellow);" id="cpu-requests">- cores</div>
                                <div style="font-size:0.7em;color:var(--text-secondary);" id="cpu-requests-pct">-</div>
                            </div>
                            <div>
                                <div style="font-size:0.75em;color:var(--text-secondary);margin-bottom:4px;">Usage</div>
                                <div style="font-size:1.3em;font-weight:bold;color:var(--accent-green);" id="cpu-usage">- cores</div>
                                <div style="font-size:0.7em;color:var(--text-secondary);" id="cpu-usage-pct">-</div>
                            </div>
                        </div>
                        <div class="progress-bar" style="height:20px;border-radius:4px;">
                            <div id="cpu-usage-bar" class="progress-fill healthy" style="width:0%;height:100%;border-radius:4px;transition:width 0.3s;"></div>
                        </div>
                        <div style="font-size:0.7em;color:var(--text-secondary);margin-top:4px;display:flex;justify-content:space-between;">
                            <span>0%</span>
                            <span id="cpu-bar-label">CPU Usage vs Allocatable</span>
                            <span>100%</span>
                        </div>
                    </div>
                    
                    <!-- Memory Dashboard -->
                    <div style="background:var(--bg-tertiary);padding:16px;border-radius:8px;margin-bottom:16px;">
                        <h3 style="margin-bottom:12px;color:var(--accent-purple);">üß† Memory Resources</h3>
                        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px;">
                            <div>
                                <div style="font-size:0.75em;color:var(--text-secondary);margin-bottom:4px;">Capacity</div>
                                <div style="font-size:1.3em;font-weight:bold;" id="mem-capacity">- GB</div>
                            </div>
                            <div>
                                <div style="font-size:0.75em;color:var(--text-secondary);margin-bottom:4px;">Allocatable</div>
                                <div style="font-size:1.3em;font-weight:bold;" id="mem-allocatable">- GB</div>
                            </div>
                            <div>
                                <div style="font-size:0.75em;color:var(--text-secondary);margin-bottom:4px;">Requested</div>
                                <div style="font-size:1.3em;font-weight:bold;color:var(--accent-yellow);" id="mem-requests">- GB</div>
                                <div style="font-size:0.7em;color:var(--text-secondary);" id="mem-requests-pct">-</div>
                            </div>
                            <div>
                                <div style="font-size:0.75em;color:var(--text-secondary);margin-bottom:4px;">Usage</div>
                                <div style="font-size:1.3em;font-weight:bold;color:var(--accent-green);" id="mem-usage">- GB</div>
                                <div style="font-size:0.7em;color:var(--text-secondary);" id="mem-usage-pct">-</div>
                            </div>
                        </div>
                        <div class="progress-bar" style="height:20px;border-radius:4px;">
                            <div id="mem-usage-bar" class="progress-fill healthy" style="width:0%;height:100%;border-radius:4px;transition:width 0.3s;"></div>
                        </div>
                        <div style="font-size:0.7em;color:var(--text-secondary);margin-top:4px;display:flex;justify-content:space-between;">
                            <span>0%</span>
                            <span id="mem-bar-label">Memory Usage vs Allocatable</span>
                            <span>100%</span>
                        </div>
                    </div>
                    
                    <!-- Historical Charts -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
                        <div style="background:var(--bg-tertiary);padding:16px;border-radius:8px;">
                            <h3 style="margin-bottom:12px;font-size:0.9em;">CPU Trend (24h)</h3>
                            <div class="chart-container-sm">
                                <canvas id="cluster-cpu-history-chart"></canvas>
                            </div>
                        </div>
                        <div style="background:var(--bg-tertiary);padding:16px;border-radius:8px;">
                            <h3 style="margin-bottom:12px;font-size:0.9em;">Memory Trend (24h)</h3>
                            <div class="chart-container-sm">
                                <canvas id="cluster-mem-history-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Nodes Table -->
                    <div style="background:var(--bg-tertiary);padding:16px;border-radius:8px;">
                        <h3 style="margin-bottom:12px;">üì¶ Nodes Detail</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Node</th>
                                    <th>CPU Capacity</th>
                                    <th>CPU Usage</th>
                                    <th>CPU %</th>
                                    <th>Memory Capacity</th>
                                    <th>Memory Usage</th>
                                    <th>Memory %</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="nodes-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- AI Insights Tab -->
                <div class="card tab-content" id="tab-insights" style="display:none">
                    <div class="card-header">
                        <span class="card-title">üß† AI Insights</span>
                    </div>
                    <div id="insights-content"></div>
                </div>

                <!-- Timeline Tab -->
                <div class="card tab-content" id="tab-timeline" style="display:none">
                    <div class="card-header">
                        <span class="card-title">üìà Scaling Timeline</span>
                    </div>
                    <div id="timeline-content"></div>
                </div>

                <!-- Costs Tab -->
                <div class="card tab-content" id="tab-costs" style="display:none">
                    <div class="card-header">
                        <span class="card-title">üí∞ Cost Analysis</span>
                    </div>
                    <div class="chart-container-lg">
                        <canvas id="cost-chart"></canvas>
                    </div>
                    <div id="cost-summary" style="margin-top:12px"></div>
                </div>

                <!-- Predictions Tab -->
                <div class="card tab-content" id="tab-predictions" style="display:none">
                    <div class="card-header">
                        <span class="card-title">üîÆ AI Predictions</span>
                        <span id="prediction-stats" style="font-size:0.8em;color:var(--text-secondary)"></span>
                    </div>
                    <div id="predictions-content"></div>
                </div>

                <!-- Config Tab -->
                <div class="card tab-content" id="tab-config" style="display:none">
                    <div class="card-header">
                        <span class="card-title">‚öôÔ∏è Configuration</span>
                        <button class="card-btn" onclick="reloadConfig()">üîÑ Hot Reload</button>
                    </div>
                    <div id="config-content"></div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <div class="card sidebar-card">
                    <div class="card-header">
                        <span class="card-title">Resource Efficiency</span>
                    </div>
                    <div class="gauge-container">
                        <div class="gauge">
                            <div class="gauge-bg"></div>
                            <div class="gauge-fill" id="efficiency-gauge"></div>
                            <div class="gauge-cover"></div>
                            <div class="gauge-value" id="efficiency-value">-</div>
                        </div>
                        <div class="gauge-label">CPU Utilization vs Requests</div>
                    </div>
                </div>

                <div class="card sidebar-card">
                    <div class="card-header">
                        <span class="card-title">CPU Trend (1h)</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="cpu-chart"></canvas>
                    </div>
                </div>

                <div class="card sidebar-card">
                    <div class="card-header">
                        <span class="card-title">System Health</span>
                    </div>
                    <div id="health-metrics"></div>
                </div>

                <div class="card sidebar-card">
                    <div class="card-header">
                        <span class="card-title">Quick Actions</span>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:6px">
                        <button class="card-btn" style="width:100%;padding:8px" onclick="refreshData()">üîÑ Refresh All</button>
                        <button class="card-btn" style="width:100%;padding:8px" onclick="reloadConfig()">‚öôÔ∏è Reload Config</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="refresh-indicator">
        <span class="spinner">‚ü≥</span>
        <span id="countdown">30</span>s
    </div>

    <script>
        let state = { deployments: [], cpuChart: null, costChart: null, countdown: 30, currentDep: null, current: {} };
        const cache = new Map();
        const CACHE_TTL = 10000;
        
        // Auto-load cluster metrics on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Load cluster metrics immediately
            setTimeout(() => loadClusterMetrics(), 500);
        });

        async function fetchAPI(url, force = false) {
            const now = Date.now();
            if (!force && cache.has(url)) {
                const { data, time } = cache.get(url);
                if (now - time < CACHE_TTL) return data;
            }
            try {
                const res = await fetch(url);
                if (!res.ok) return null;
                const data = await res.json();
                cache.set(url, { data, time: now });
                return data;
            } catch (e) { return null; }
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).style.display = 'block';
                
                // Load tab-specific data
                if (tab.dataset.tab === 'cluster') {
                    loadClusterMetrics();
                } else if (state.currentDep) {
                    const [ns, dep] = state.currentDep.split('/');
                    if (tab.dataset.tab === 'insights') loadInsights(ns, dep, true);
                    if (tab.dataset.tab === 'timeline') loadTimeline(ns, dep, true);
                    if (tab.dataset.tab === 'costs') loadCostTrends(ns, dep, true);
                    if (tab.dataset.tab === 'predictions') loadPredictions(ns, dep, true);
                }
            });
        });

        async function loadData(force = false) {
            await Promise.all([loadOverview(force), loadDeployments(force), loadHealth(force), loadConfig(force)]);
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        async function loadOverview(force) {
            const data = await fetchAPI('/api/overview', force);
            if (!data) return;
            document.getElementById('stat-deployments').textContent = data.total_deployments || 0;
            document.getElementById('stat-cost').textContent = '$' + (data.total_monthly_cost || 0).toFixed(0);
            document.getElementById('stat-savings').textContent = '$' + (data.total_savings_potential || 0).toFixed(0);
        }

        async function loadDeployments(force) {
            const deployments = await fetchAPI('/api/deployments', force) || [];
            state.deployments = deployments;
            
            let totalPods = 0, totalCpu = 0, totalEfficiency = 0, totalEvents = 0;
            let rows = '';

            for (const dep of deployments) {
                const current = await fetchAPI(`/api/deployment/${dep.namespace}/${dep.deployment}/current`, force);
                const insights = await fetchAPI(`/api/ai/insights/${dep.deployment}`, force);
                
                if (!current) {
                    rows += `<tr><td>${dep.deployment}</td><td colspan="7" style="color:var(--text-secondary)">Loading...</td></tr>`;
                    continue;
                }

                // Set first deployment as current
                if (!state.currentDep) state.currentDep = `${dep.namespace}/${dep.deployment}`;

                totalPods += current.pod_count || 0;
                const cpuPct = (current.pod_cpu_usage || 0) * 100;
                totalCpu += cpuPct;
                
                const efficiency = insights?.efficiency?.cpu_efficiency || 0;
                totalEfficiency += efficiency;
                totalEvents += insights?.scaling_events?.length || 0;

                const cpuStatus = cpuPct > 80 ? 'critical' : cpuPct > 50 ? 'warning' : 'healthy';
                const effStatus = efficiency > 70 ? 'healthy' : efficiency > 40 ? 'warning' : 'critical';
                const pattern = current.pattern || 'unknown';
                const cpuReq = current.cpu_request || 0;
                const memReq = current.memory_request || 0;
                const priority = current.priority || 'medium';
                
                // Priority badge colors
                const priorityColors = {
                    'critical': 'critical',
                    'high': 'warning',
                    'medium': 'healthy',
                    'low': 'info',
                    'best_effort': 'info'
                };
                const priorityBadge = priorityColors[priority] || 'healthy';

                rows += `<tr class="clickable" onclick="selectDeployment('${dep.namespace}', '${dep.deployment}')">
                    <td><strong>${dep.deployment}</strong><br><small style="color:var(--text-secondary)">${dep.namespace}</small></td>
                    <td><span class="badge ${priorityBadge}">${priority}</span></td>
                    <td>
                        ${cpuPct.toFixed(1)}%
                        <div class="progress-bar"><div class="progress-fill ${cpuStatus}" style="width:${Math.min(cpuPct, 100)}%"></div></div>
                    </td>
                    <td>${cpuReq}m</td>
                    <td>${memReq}Mi</td>
                    <td>${current.pod_count || 0}</td>
                    <td>${current.hpa_target || '-'}%</td>
                    <td><span class="badge ${pattern}">${pattern}</span></td>
                    <td><span class="badge ${cpuStatus}">${cpuStatus}</span></td>
                </tr>`;

                // Load charts for first deployment
                if (deployments.indexOf(dep) === 0) {
                    loadCPUHistory(dep.namespace, dep.deployment, force);
                    updateEfficiencyGauge(efficiency);
                    
                    // Update prediction accuracy
                    if (insights?.prediction_accuracy) {
                        const acc = (insights.prediction_accuracy.accuracy || 0) * 100;
                        document.getElementById('stat-accuracy').textContent = acc.toFixed(0) + '%';
                    }
                }
            }

            document.getElementById('deployments-body').innerHTML = rows || '<tr><td colspan="9" class="empty-state">No deployments</td></tr>';
            document.getElementById('stat-pods').textContent = totalPods;
            document.getElementById('stat-cpu').textContent = deployments.length ? (totalCpu / deployments.length).toFixed(1) + '%' : '-';
            document.getElementById('stat-efficiency').textContent = deployments.length ? (totalEfficiency / deployments.length).toFixed(0) + '%' : '-';
            document.getElementById('stat-events').textContent = totalEvents;
            
            // Update namespace filter
            const namespaces = [...new Set(deployments.map(d => d.namespace))].sort();
            const namespaceFilter = document.getElementById('namespace-filter');
            const currentValue = namespaceFilter.value;
            namespaceFilter.innerHTML = '<option value="all">All Namespaces</option>';
            for (const ns of namespaces) {
                const option = document.createElement('option');
                option.value = ns;
                option.textContent = ns;
                namespaceFilter.appendChild(option);
            }
            // Restore previous selection if it still exists
            if (currentValue && (currentValue === 'all' || namespaces.includes(currentValue))) {
                namespaceFilter.value = currentValue;
            }
        }

        function selectDeployment(ns, dep) {
            state.currentDep = `${ns}/${dep}`;
            loadCPUHistory(ns, dep, true);
            loadInsights(ns, dep, true);
        }

        async function loadInsights(ns, dep, force) {
            const insights = await fetchAPI(`/api/ai/insights/${dep}`, force);
            const container = document.getElementById('insights-content');
            
            if (!insights) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üß†</div>Loading insights...</div>';
                return;
            }

            let html = '<div class="grid-2">';
            
            // Efficiency Card
            const eff = insights.efficiency || {};
            html += `<div class="insight-card">
                <div class="insight-header">
                    <span class="insight-title">üìä Resource Efficiency</span>
                    <span class="insight-value" style="color:${eff.cpu_efficiency > 70 ? 'var(--accent-green)' : 'var(--accent-yellow)'}">${(eff.cpu_efficiency || 0).toFixed(0)}%</span>
                </div>
                <div class="insight-desc">
                    CPU Usage: ${(eff.avg_cpu_usage || 0).toFixed(1)}% | Request: ${eff.avg_cpu_request || 0}m<br>
                    Based on ${eff.data_points || 0} data points
                </div>
            </div>`;

            // Auto-tuning Card
            const tuning = insights.auto_tuning || {};
            html += `<div class="insight-card">
                <div class="insight-header">
                    <span class="insight-title">üéØ Auto-Tuning</span>
                    <span class="insight-value" style="color:var(--accent-purple)">${tuning.current_optimal || '-'}%</span>
                </div>
                <div class="insight-desc">
                    Learning Rate: ${(tuning.learning_rate || 0.1).toFixed(2)}<br>
                    Samples: ${tuning.samples_collected || 0}
                </div>
            </div>`;

            // Prediction Accuracy Card
            const pred = insights.prediction_accuracy || {};
            html += `<div class="insight-card">
                <div class="insight-header">
                    <span class="insight-title">üîÆ Prediction Accuracy</span>
                    <span class="insight-value" style="color:var(--accent-cyan)">${((pred.accuracy || 0) * 100).toFixed(0)}%</span>
                </div>
                <div class="insight-desc">
                    MAE: ${(pred.mae || 0).toFixed(3)} | Validated: ${pred.validated_count || 0}<br>
                    Total Predictions: ${pred.total_predictions || 0}
                </div>
            </div>`;

            // Patterns Card
            const patterns = insights.patterns || {};
            html += `<div class="insight-card">
                <div class="insight-header">
                    <span class="insight-title">üìà Learned Patterns</span>
                </div>
                <div class="insight-desc">
                    Peak Hours: ${patterns.peak_hours?.join(', ') || 'Learning...'}<br>
                    Low Hours: ${patterns.low_hours?.join(', ') || 'Learning...'}
                </div>
            </div>`;

            html += '</div>';

            // Recent Scaling Events
            if (insights.scaling_events?.length > 0) {
                html += '<div style="margin-top:12px"><strong>Recent Scaling Events</strong></div>';
                html += '<div style="margin-top:8px">';
                for (const evt of insights.scaling_events.slice(0, 5)) {
                    const icon = evt.action === 'scale_up' ? 'üìà' : evt.action === 'scale_down' ? 'üìâ' : 'üîÑ';
                    html += `<div class="timeline-event">
                        <div class="timeline-icon ${evt.action === 'scale_up' ? 'up' : 'down'}">${icon}</div>
                        <div class="timeline-content">
                            <div><strong>${evt.action}</strong> ‚Üí ${evt.pod_count} pods (HPA: ${evt.hpa_target}%)</div>
                            <div class="timeline-time">${new Date(evt.timestamp).toLocaleString()}</div>
                        </div>
                    </div>`;
                }
                html += '</div>';
            }

            container.innerHTML = html;
            updateEfficiencyGauge(eff.cpu_efficiency || 0);
        }

        async function loadTimeline(ns, dep, force) {
            const data = await fetchAPI(`/api/scaling/timeline/${dep}`, force);
            const container = document.getElementById('timeline-content');
            
            if (!data || !data.events?.length) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìà</div>No scaling events yet</div>';
                return;
            }

            let html = `<div style="margin-bottom:10px;color:var(--text-secondary);font-size:0.85em">Total events: ${data.total_events}</div>`;
            
            for (const evt of data.events.slice(0, 20)) {
                let icon, iconClass, title, desc;
                
                if (evt.type === 'scale_up') {
                    icon = '‚Üë'; iconClass = 'up';
                    title = `Scale Up: ${evt.from_pods} ‚Üí ${evt.to_pods} pods`;
                    desc = `CPU: ${evt.cpu_usage}% | Confidence: ${((evt.confidence || 0) * 100).toFixed(0)}%`;
                } else if (evt.type === 'scale_down') {
                    icon = '‚Üì'; iconClass = 'down';
                    title = `Scale Down: ${evt.from_pods} ‚Üí ${evt.to_pods} pods`;
                    desc = `CPU: ${evt.cpu_usage}% | Confidence: ${((evt.confidence || 0) * 100).toFixed(0)}%`;
                } else {
                    icon = '‚öô'; iconClass = 'change';
                    title = `HPA Target: ${evt.from_target}% ‚Üí ${evt.to_target}%`;
                    desc = `Reason: ${evt.reason}`;
                }

                html += `<div class="timeline-event">
                    <div class="timeline-icon ${iconClass}">${icon}</div>
                    <div class="timeline-content">
                        <div><strong>${title}</strong></div>
                        <div style="font-size:0.85em;color:var(--text-secondary)">${desc}</div>
                        <div class="timeline-time">${new Date(evt.timestamp).toLocaleString()}</div>
                    </div>
                </div>`;
            }

            container.innerHTML = html;
        }

        async function loadCostTrends(ns, dep, force) {
            const data = await fetchAPI(`/api/cost/trends/${dep}`, force);
            
            if (!data || !data.trends?.length) {
                document.getElementById('cost-summary').innerHTML = '<div class="empty-state">Need more data for cost analysis</div>';
                return;
            }

            const ctx = document.getElementById('cost-chart').getContext('2d');
            if (state.costChart) state.costChart.destroy();

            state.costChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.trends.map(t => t.hour.split(' ')[1] || t.hour),
                    datasets: [
                        {
                            label: 'Total Cost',
                            data: data.trends.map(t => t.cost),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            fill: true
                        },
                        {
                            label: 'Wasted',
                            data: data.trends.map(t => t.wasted),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { boxWidth: 12, font: { size: 10 } } } },
                    scales: {
                        x: { display: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8', maxTicksLimit: 12 } },
                        y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                    }
                }
            });

            const s = data.summary;
            document.getElementById('cost-summary').innerHTML = `
                <div class="grid-2">
                    <div class="insight-card">
                        <div class="insight-header">
                            <span class="insight-title">üíµ Total Cost</span>
                            <span class="insight-value" style="color:var(--accent-yellow)">$${s.total_cost.toFixed(2)}</span>
                        </div>
                        <div class="insight-desc">${s.hours_analyzed} hours analyzed</div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-header">
                            <span class="insight-title">üóëÔ∏è Wasted</span>
                            <span class="insight-value" style="color:var(--accent-red)">$${s.total_wasted.toFixed(2)}</span>
                        </div>
                        <div class="insight-desc">Efficiency: ${s.efficiency}%</div>
                    </div>
                </div>
            `;
        }

        async function loadPredictions(ns, dep, force) {
            const data = await fetchAPI(`/api/deployment/${ns}/${dep}/predictions`, force);
            const container = document.getElementById('predictions-content');
            
            if (!data?.predictions?.length) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîÆ</div>No predictions yet</div>';
                return;
            }

            if (data.accuracy_stats) {
                const acc = data.accuracy_stats;
                document.getElementById('prediction-stats').textContent = 
                    `Accuracy: ${((acc.accuracy || 0) * 100).toFixed(0)}% | MAE: ${(acc.mae || 0).toFixed(3)}`;
            }

            let html = '';
            for (const pred of data.predictions.slice(0, 10)) {
                const conf = (pred.confidence || 0) * 100;
                const confColor = conf > 70 ? 'var(--accent-green)' : conf > 40 ? 'var(--accent-yellow)' : 'var(--accent-red)';
                
                html += `<div class="insight-card">
                    <div class="insight-header">
                        <span class="insight-title">${pred.action || 'maintain'}</span>
                        <span style="color:${confColor};font-size:0.9em">${conf.toFixed(0)}% conf</span>
                    </div>
                    <div class="insight-desc">${pred.reasoning || 'No reasoning'}</div>
                    ${pred.validated ? `<div style="margin-top:4px;font-size:0.75em;color:var(--accent-green)">‚úì Validated | Actual: ${(pred.actual_cpu || 0).toFixed(2)}</div>` : ''}
                    <div class="timeline-time">${new Date(pred.timestamp).toLocaleString()}</div>
                </div>`;
            }
            container.innerHTML = html;
        }

        async function loadCPUHistory(ns, dep, force) {
            const data = await fetchAPI(`/api/deployment/${ns}/${dep}/history?hours=1`, force);
            if (!data?.timestamps) return;

            const ctx = document.getElementById('cpu-chart').getContext('2d');
            if (state.cpuChart) state.cpuChart.destroy();
            
            state.cpuChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.timestamps.map(t => new Date(t).toLocaleTimeString()),
                    datasets: [{
                        label: 'CPU %',
                        data: data.pod_cpu_usage || [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { beginAtZero: true, max: 100, grid: { color: '#334155' }, ticks: { color: '#94a3b8', font: { size: 9 } } }
                    }
                }
            });
        }

        function updateEfficiencyGauge(value) {
            const rotation = Math.min(value, 100) * 1.8; // 180 degrees max
            document.getElementById('efficiency-gauge').style.transform = `rotate(${rotation - 180}deg)`;
            document.getElementById('efficiency-value').textContent = value.toFixed(0) + '%';
            document.getElementById('efficiency-gauge').style.background = 
                value > 70 ? 'var(--accent-green)' : value > 40 ? 'var(--accent-yellow)' : 'var(--accent-red)';
        }

        async function loadHealth(force) {
            const health = await fetchAPI('/api/health', force) || {};
            document.getElementById('prom-status').className = 'status-dot ' + (health.prometheus === 'healthy' ? 'healthy' : 'error');
            document.getElementById('k8s-status').className = 'status-dot ' + (health.kubernetes === 'healthy' ? 'healthy' : 'error');
            document.getElementById('db-status').className = 'status-dot ' + (health.database === 'healthy' ? 'healthy' : 'error');

            document.getElementById('health-metrics').innerHTML = `
                <div class="metric-row"><span class="metric-label">Prometheus</span><span class="badge ${health.prometheus === 'healthy' ? 'healthy' : 'critical'}">${health.prometheus || 'unknown'}</span></div>
                <div class="metric-row"><span class="metric-label">Kubernetes</span><span class="badge ${health.kubernetes === 'healthy' ? 'healthy' : 'critical'}">${health.kubernetes || 'unknown'}</span></div>
                <div class="metric-row"><span class="metric-label">Database</span><span class="badge ${health.database === 'healthy' ? 'healthy' : 'critical'}">${health.database || 'unknown'}</span></div>
                <div class="metric-row"><span class="metric-label">Degraded</span><span class="badge ${health.degraded ? 'warning' : 'healthy'}">${health.degraded ? 'Yes' : 'No'}</span></div>
            `;
        }

        async function loadConfig(force) {
            const config = await fetchAPI('/api/config/status', force);
            if (!config) return;
            document.getElementById('version').textContent = 'v' + (config.current_config?.version || '-');
            const c = config.current_config || {};
            document.getElementById('config-content').innerHTML = `
                <div class="metric-row"><span class="metric-label">Config Version</span><span class="metric-value">${config.config_version || '-'}</span></div>
                <div class="metric-row"><span class="metric-label">Check Interval</span><span class="metric-value">${c.check_interval || 30}s</span></div>
                <div class="metric-row"><span class="metric-label">Target Utilization</span><span class="metric-value">${c.target_node_utilization || 40}%</span></div>
                <div class="metric-row"><span class="metric-label">Dry Run</span><span class="badge ${c.dry_run ? 'warning' : 'healthy'}">${c.dry_run ? 'Yes' : 'No'}</span></div>
                <div class="metric-row"><span class="metric-label">Predictive</span><span class="badge ${c.enable_predictive ? 'healthy' : 'warning'}">${c.enable_predictive ? 'On' : 'Off'}</span></div>
                <div class="metric-row"><span class="metric-label">Auto-tuning</span><span class="badge ${c.enable_autotuning ? 'healthy' : 'warning'}">${c.enable_autotuning ? 'On' : 'Off'}</span></div>
            `;
        }

        async function reloadConfig() {
            const res = await fetch('/api/config/reload', { method: 'POST' });
            const data = await res.json();
            alert(data.success ? 'Config reloaded!' : 'Failed: ' + data.error);
            loadConfig(true);
        }

        function refreshData() { state.countdown = 30; loadData(true); }
        
        // Cluster monitoring functions
        let clusterCpuChart = null;
        let clusterMemChart = null;
        
        async function loadClusterMetrics() {
            console.log('[CLUSTER] Loading cluster metrics...');
            try {
                const res = await fetch('/api/cluster/metrics');
                if (!res.ok) {
                    console.error('[CLUSTER] API error:', res.status);
                    return;
                }
                const data = await res.json();
                console.log('[CLUSTER] Data received:', data);
                
                if (data.error) {
                    console.error('[CLUSTER] API returned error:', data.error);
                    return;
                }
                
                // Helper function to safely update element
                const setElement = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = value;
                        console.log(`[CLUSTER] Set ${id} = ${value}`);
                    } else {
                        console.warn(`[CLUSTER] Element not found: ${id}`);
                    }
                };
                
                // Update summary
                setElement('cluster-node-count', data.node_count || 0);
                
                // Use pod count from API (queried from Prometheus)
                setElement('cluster-pod-count', data.pod_count || '-');
                
                // Calculate health
                const cpuHealth = data.summary?.cpu?.usage_percent || 0;
                const memHealth = data.summary?.memory?.usage_percent || 0;
                const overallHealth = Math.max(cpuHealth, memHealth);
                const healthStatus = overallHealth > 85 ? 'Critical' : overallHealth > 70 ? 'Warning' : 'Healthy';
                const healthColor = overallHealth > 85 ? 'var(--accent-red)' : overallHealth > 70 ? 'var(--accent-yellow)' : 'var(--accent-green)';
                
                const healthEl = document.getElementById('cluster-health');
                if (healthEl) {
                    healthEl.textContent = healthStatus;
                    healthEl.style.color = healthColor;
                }
                
                // Update CPU metrics
                if (data.summary?.cpu) {
                    setElement('cpu-capacity', (data.summary.cpu.capacity || 0).toFixed(1) + ' cores');
                    setElement('cpu-allocatable', (data.summary.cpu.allocatable || 0).toFixed(1) + ' cores');
                    setElement('cpu-requests', (data.summary.cpu.requests || 0).toFixed(1) + ' cores');
                    setElement('cpu-requests-pct', (data.summary.cpu.requests_percent || 0).toFixed(1) + '% of allocatable');
                    setElement('cpu-usage', (data.summary.cpu.usage || 0).toFixed(1) + ' cores');
                    setElement('cpu-usage-pct', (data.summary.cpu.usage_percent || 0).toFixed(1) + '% of allocatable');
                    
                    const cpuUsagePct = data.summary.cpu.usage_percent || 0;
                    const cpuBar = document.getElementById('cpu-usage-bar');
                    if (cpuBar) {
                        cpuBar.style.width = Math.min(cpuUsagePct, 100) + '%';
                        cpuBar.className = 'progress-fill ' + (cpuUsagePct > 85 ? 'critical' : cpuUsagePct > 70 ? 'warning' : 'healthy');
                    }
                }
                
                // Update Memory metrics
                if (data.summary?.memory) {
                    setElement('mem-capacity', (data.summary.memory.capacity_gb || 0).toFixed(1) + ' GB');
                    setElement('mem-allocatable', (data.summary.memory.allocatable_gb || 0).toFixed(1) + ' GB');
                    setElement('mem-requests', (data.summary.memory.requests_gb || 0).toFixed(1) + ' GB');
                    setElement('mem-requests-pct', (data.summary.memory.requests_percent || 0).toFixed(1) + '% of allocatable');
                    setElement('mem-usage', (data.summary.memory.usage_gb || 0).toFixed(1) + ' GB');
                    setElement('mem-usage-pct', (data.summary.memory.usage_percent || 0).toFixed(1) + '% of allocatable');
                    
                    const memUsagePct = data.summary.memory.usage_percent || 0;
                    const memBar = document.getElementById('mem-usage-bar');
                    if (memBar) {
                        memBar.style.width = Math.min(memUsagePct, 100) + '%';
                        memBar.className = 'progress-fill ' + (memUsagePct > 85 ? 'critical' : memUsagePct > 70 ? 'warning' : 'healthy');
                    }
                }
                
                // Update nodes table
                let nodesHtml = '';
                for (const node of data.nodes) {
                    const cpuPct = (node.cpu_usage / node.cpu_allocatable * 100).toFixed(1);
                    const memPct = (node.memory_usage_gb / node.memory_allocatable_gb * 100).toFixed(1);
                    const nodeStatus = Math.max(parseFloat(cpuPct), parseFloat(memPct)) > 85 ? 'critical' : 
                                      Math.max(parseFloat(cpuPct), parseFloat(memPct)) > 70 ? 'warning' : 'healthy';
                    
                    nodesHtml += `<tr>
                        <td><strong>${node.name}</strong></td>
                        <td>${node.cpu_allocatable} cores</td>
                        <td>${node.cpu_usage.toFixed(2)} cores</td>
                        <td>
                            ${cpuPct}%
                            <div class="progress-bar"><div class="progress-fill ${nodeStatus}" style="width:${Math.min(cpuPct, 100)}%"></div></div>
                        </td>
                        <td>${node.memory_allocatable_gb.toFixed(1)} GB</td>
                        <td>${node.memory_usage_gb.toFixed(1)} GB</td>
                        <td>
                            ${memPct}%
                            <div class="progress-bar"><div class="progress-fill ${nodeStatus}" style="width:${Math.min(memPct, 100)}%"></div></div>
                        </td>
                        <td><span class="badge ${nodeStatus}">${nodeStatus}</span></td>
                    </tr>`;
                }
                document.getElementById('nodes-body').innerHTML = nodesHtml || '<tr><td colspan="8" class="empty-state">No nodes found</td></tr>';
                
                // Update namespace filter
                const namespaceFilter = document.getElementById('namespace-filter');
                const currentValue = namespaceFilter.value;
                namespaceFilter.innerHTML = '<option value="all">All Namespaces</option>';
                for (const ns of data.namespaces) {
                    namespaceFilter.innerHTML += `<option value="${ns}">${ns}</option>`;
                }
                namespaceFilter.value = currentValue;
                
                // Load historical data
                loadClusterHistory();
                
            } catch (err) {
                console.error('Error loading cluster metrics:', err);
            }
        }
        
        async function loadClusterHistory() {
            try {
                const res = await fetch('/api/cluster/history?hours=24');
                const data = await res.json();
                
                if (data.error || !data.history || data.history.length === 0) {
                    return;
                }
                
                const timestamps = data.history.map(h => h.timestamp);
                const cpuRequests = data.history.map(h => h.total_cpu_request_millicores / 1000);
                const cpuUsage = data.history.map(h => h.total_cpu_usage_millicores / 1000);
                const nodeUtil = data.history.map(h => h.avg_node_utilization);
                
                // CPU History Chart
                const cpuCtx = document.getElementById('cluster-cpu-history-chart');
                if (cpuCtx) {
                    if (clusterCpuChart) clusterCpuChart.destroy();
                    clusterCpuChart = new Chart(cpuCtx, {
                        type: 'line',
                        data: {
                            labels: timestamps,
                            datasets: [
                                {
                                    label: 'CPU Requests (cores)',
                                    data: cpuRequests,
                                    borderColor: 'rgb(251, 191, 36)',
                                    backgroundColor: 'rgba(251, 191, 36, 0.1)',
                                    tension: 0.4,
                                    fill: true,
                                    pointRadius: 0,
                                    borderWidth: 2
                                },
                                {
                                    label: 'CPU Usage (cores)',
                                    data: cpuUsage,
                                    borderColor: 'rgb(34, 197, 94)',
                                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                    tension: 0.4,
                                    fill: true,
                                    pointRadius: 0,
                                    borderWidth: 2
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: true, position: 'top' } },
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'Cores' } },
                                x: { display: false }
                            },
                            interaction: { intersect: false, mode: 'index' }
                        }
                    });
                }
                
                // Memory History Chart (using node utilization as proxy)
                const memCtx = document.getElementById('cluster-mem-history-chart');
                if (memCtx) {
                    if (clusterMemChart) clusterMemChart.destroy();
                    clusterMemChart = new Chart(memCtx, {
                        type: 'line',
                        data: {
                            labels: timestamps,
                            datasets: [
                                {
                                    label: 'Avg Node Utilization %',
                                    data: nodeUtil,
                                    borderColor: 'rgb(139, 92, 246)',
                                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                    tension: 0.4,
                                    fill: true,
                                    pointRadius: 0,
                                    borderWidth: 2
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: true, position: 'top' } },
                            scales: {
                                y: { beginAtZero: true, max: 100, title: { display: true, text: '%' } },
                                x: { display: false }
                            },
                            interaction: { intersect: false, mode: 'index' }
                        }
                    });
                }
                
            } catch (err) {
                console.error('Error loading cluster history:', err);
            }
        }
        
        // Namespace filter handler
        document.getElementById('namespace-filter').addEventListener('change', function() {
            const selectedNs = this.value;
            const rows = document.querySelectorAll('#deployments-body tr');
            
            rows.forEach(row => {
                if (selectedNs === 'all') {
                    row.style.display = '';
                } else {
                    const nsText = row.querySelector('small')?.textContent || '';
                    row.style.display = nsText === selectedNs ? '' : 'none';
                }
            });
        });

        setInterval(() => {
            state.countdown--;
            document.getElementById('countdown').textContent = state.countdown;
            if (state.countdown <= 0) { state.countdown = 30; loadData(true); }
        }, 1000);

        loadData();
    </script>
</body>
</html>
