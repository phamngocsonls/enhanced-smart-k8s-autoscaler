<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Autoscaler Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }
        .navbar {
            background: #1e293b;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #334155;
        }
        .logo { font-size: 1.5em; font-weight: bold; color: #60a5fa; }
        .nav-status { display: flex; gap: 20px; align-items: center; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-dot.healthy { background: #22c55e; }
        .status-dot.degraded { background: #f59e0b; }
        .status-dot.error { background: #ef4444; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .stat-card {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #334155;
        }
        .stat-label { font-size: 0.8em; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; }
        .stat-value { font-size: 1.8em; font-weight: bold; }
        .stat-value.blue { color: #60a5fa; }
        .stat-value.green { color: #22c55e; }
        .stat-value.yellow { color: #f59e0b; }
        .stat-value.red { color: #ef4444; }
        .stat-change { font-size: 0.75em; margin-top: 5px; }
        .stat-change.up { color: #22c55e; }
        .stat-change.down { color: #ef4444; }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #334155;
            padding-bottom: 10px;
        }
        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .tab:hover { background: #334155; color: #e2e8f0; }
        .tab.active { background: #3b82f6; color: white; }
        
        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        @media (max-width: 1024px) { .main-grid { grid-template-columns: 1fr; } }
        
        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #334155;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #334155;
        }
        .card-title { font-size: 1.1em; font-weight: 600; }
        
        /* Deployments Table */
        .deployments-table { width: 100%; border-collapse: collapse; }
        .deployments-table th, .deployments-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }
        .deployments-table th { color: #94a3b8; font-weight: 500; font-size: 0.85em; }
        .deployments-table tr:hover { background: #334155; }
        
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }
        .badge.healthy { background: #166534; color: #86efac; }
        .badge.warning { background: #854d0e; color: #fde047; }
        .badge.critical { background: #991b1b; color: #fca5a5; }
        .badge.steady { background: #1e40af; color: #93c5fd; }
        .badge.bursty { background: #7c2d12; color: #fdba74; }
        .badge.growing { background: #166534; color: #86efac; }
        
        /* Recommendations */
        .recommendation {
            background: #334155;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #3b82f6;
        }
        .recommendation.high { border-left-color: #ef4444; }
        .recommendation.medium { border-left-color: #f59e0b; }
        .recommendation.low { border-left-color: #22c55e; }
        .recommendation-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .recommendation-title { font-weight: 600; }
        .recommendation-savings { color: #22c55e; font-weight: bold; }
        .recommendation-desc { font-size: 0.9em; color: #94a3b8; }
        
        /* Charts */
        .chart-container { height: 250px; margin-top: 15px; }
        
        /* Health Panel */
        .health-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #334155;
        }
        .health-item:last-child { border-bottom: none; }
        
        /* Search & Filter */
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-input {
            flex: 1;
            padding: 10px 15px;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 0.95em;
        }
        .search-input:focus { outline: none; border-color: #3b82f6; }
        .filter-btn {
            padding: 10px 20px;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 8px;
            color: #e2e8f0;
            cursor: pointer;
        }
        .filter-btn:hover { background: #475569; }
        
        /* Loading & Error */
        .loading { text-align: center; padding: 40px; color: #94a3b8; }
        .spinner { animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error { background: #7f1d1d; color: #fca5a5; padding: 15px; border-radius: 8px; margin: 10px 0; }
        
        /* Auto-refresh indicator */
        .refresh-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1e293b;
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid #334155;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">üöÄ Smart Autoscaler</div>
        <div class="nav-status">
            <span><span class="status-dot healthy" id="prometheus-status"></span>Prometheus</span>
            <span><span class="status-dot healthy" id="k8s-status"></span>Kubernetes</span>
            <span id="last-update">Last update: --</span>
        </div>
    </nav>

    <div class="container">
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Deployments</div>
                <div class="stat-value blue" id="total-deployments">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Monthly Cost</div>
                <div class="stat-value yellow" id="total-cost">$-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Savings Potential</div>
                <div class="stat-value green" id="total-savings">$-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Efficiency</div>
                <div class="stat-value blue" id="efficiency">-%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Anomalies (24h)</div>
                <div class="stat-value red" id="anomalies">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Confidence</div>
                <div class="stat-value blue" id="confidence">-%</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('deployments')">üìä Deployments</button>
            <button class="tab" onclick="showTab('recommendations')">üí° Recommendations</button>
            <button class="tab" onclick="showTab('patterns')">üìà Patterns</button>
            <button class="tab" onclick="showTab('health')">üè• Health</button>
        </div>

        <!-- Search -->
        <div class="search-bar">
            <input type="text" class="search-input" id="search" placeholder="Search deployments..." onkeyup="filterDeployments()">
            <button class="filter-btn" onclick="refreshData()">üîÑ Refresh</button>
        </div>

        <!-- Main Content -->
        <div class="main-grid">
            <!-- Deployments Tab -->
            <div class="card" id="tab-deployments">
                <div class="card-header">
                    <span class="card-title">Watched Deployments</span>
                    <span id="deployment-count">0 deployments</span>
                </div>
                <table class="deployments-table">
                    <thead>
                        <tr>
                            <th>Deployment</th>
                            <th>Namespace</th>
                            <th>CPU</th>
                            <th>Pods</th>
                            <th>Pattern</th>
                            <th>Status</th>
                            <th>Cost/mo</th>
                        </tr>
                    </thead>
                    <tbody id="deployments-body">
                        <tr><td colspan="7" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Recommendations Tab -->
            <div class="card" id="tab-recommendations" style="display:none;">
                <div class="card-header">
                    <span class="card-title">Cost Optimization Recommendations</span>
                </div>
                <div id="recommendations-list">
                    <div class="loading">Loading recommendations...</div>
                </div>
            </div>

            <!-- Patterns Tab -->
            <div class="card" id="tab-patterns" style="display:none;">
                <div class="card-header">
                    <span class="card-title">Workload Patterns</span>
                </div>
                <div class="chart-container">
                    <canvas id="patterns-chart"></canvas>
                </div>
            </div>

            <!-- Health Tab -->
            <div class="card" id="tab-health" style="display:none;">
                <div class="card-header">
                    <span class="card-title">System Health</span>
                </div>
                <div id="health-list"></div>
            </div>

            <!-- Side Panel -->
            <div>
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <span class="card-title">Quick Stats</span>
                    </div>
                    <div class="health-item">
                        <span>Total Pods</span>
                        <span id="total-pods">-</span>
                    </div>
                    <div class="health-item">
                        <span>Avg CPU Usage</span>
                        <span id="avg-cpu">-%</span>
                    </div>
                    <div class="health-item">
                        <span>Scale Events (1h)</span>
                        <span id="scale-events">-</span>
                    </div>
                    <div class="health-item">
                        <span>Learning Rate</span>
                        <span id="learning-rate">-</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">CPU Trend (24h)</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="cpu-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="refresh-indicator">
        <span class="spinner">‚ü≥</span>
        <span>Auto-refresh: <span id="countdown">60</span>s</span>
    </div>

    <script>
        // Cache for API responses
        const cache = {
            data: {},
            ttl: 30000, // 30 seconds
            set(key, value) {
                this.data[key] = { value, timestamp: Date.now() };
            },
            get(key) {
                const item = this.data[key];
                if (!item) return null;
                if (Date.now() - item.timestamp > this.ttl) {
                    delete this.data[key];
                    return null;
                }
                return item.value;
            }
        };

        // Fetch with cache
        async function fetchWithCache(url, forceRefresh = false) {
            if (!forceRefresh) {
                const cached = cache.get(url);
                if (cached) return cached;
            }
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            cache.set(url, data);
            return data;
        }

        let cpuChart = null;
        let patternsChart = null;
        let countdown = 60;

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('[id^="tab-"]').forEach(t => t.style.display = 'none');
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).style.display = 'block';
        }

        // Filter deployments
        function filterDeployments() {
            const search = document.getElementById('search').value.toLowerCase();
            document.querySelectorAll('#deployments-body tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // Load all data
        async function loadData(forceRefresh = false) {
            try {
                // Load overview
                const overview = await fetchWithCache('/api/overview', forceRefresh).catch(() => ({
                    total_deployments: 0, total_monthly_cost: 0, total_savings_potential: 0,
                    efficiency_score: 0, recent_anomalies_24h: 0, avg_prediction_confidence: 0
                }));
                
                document.getElementById('total-deployments').textContent = overview.total_deployments || 0;
                document.getElementById('total-cost').textContent = '$' + (overview.total_monthly_cost || 0).toFixed(0);
                document.getElementById('total-savings').textContent = '$' + (overview.total_savings_potential || 0).toFixed(0);
                document.getElementById('efficiency').textContent = (overview.efficiency_score || 0) + '%';
                document.getElementById('anomalies').textContent = overview.recent_anomalies_24h || 0;
                document.getElementById('confidence').textContent = ((overview.avg_prediction_confidence || 0) * 100).toFixed(0) + '%';

                // Load deployments
                const deployments = await fetchWithCache('/api/deployments', forceRefresh).catch(() => []);
                await renderDeployments(deployments, forceRefresh);

                // Load health
                await loadHealth(forceRefresh);

                // Update timestamp
                document.getElementById('last-update').textContent = 'Last update: ' + new Date().toLocaleTimeString();

            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function renderDeployments(deployments, forceRefresh) {
            const tbody = document.getElementById('deployments-body');
            if (!deployments.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#94a3b8;">No deployments found</td></tr>';
                return;
            }

            let totalPods = 0;
            let totalCpu = 0;
            let rows = '';

            for (const dep of deployments) {
                try {
                    const current = await fetchWithCache(
                        `/api/deployment/${dep.namespace}/${dep.deployment}/current`, 
                        forceRefresh
                    ).catch(() => null);

                    if (!current) {
                        rows += `<tr>
                            <td>${dep.deployment}</td>
                            <td>${dep.namespace}</td>
                            <td colspan="5" style="color:#94a3b8;">Collecting data...</td>
                        </tr>`;
                        continue;
                    }

                    totalPods += current.pod_count || 0;
                    totalCpu += current.node_utilization || 0;

                    const status = current.node_utilization > 80 ? 'critical' : 
                                  current.node_utilization > 65 ? 'warning' : 'healthy';
                    const pattern = current.pattern || 'unknown';

                    rows += `<tr>
                        <td><strong>${dep.deployment}</strong></td>
                        <td>${dep.namespace}</td>
                        <td>${(current.node_utilization || 0).toFixed(1)}%</td>
                        <td>${current.pod_count || 0}</td>
                        <td><span class="badge ${pattern.toLowerCase()}">${pattern}</span></td>
                        <td><span class="badge ${status}">${status}</span></td>
                        <td>$${(current.monthly_cost || 0).toFixed(0)}</td>
                    </tr>`;
                } catch (e) {
                    console.error('Error loading deployment:', dep.deployment, e);
                }
            }

            tbody.innerHTML = rows;
            document.getElementById('deployment-count').textContent = `${deployments.length} deployments`;
            document.getElementById('total-pods').textContent = totalPods;
            document.getElementById('avg-cpu').textContent = deployments.length ? 
                (totalCpu / deployments.length).toFixed(1) + '%' : '-';
        }

        async function loadHealth(forceRefresh) {
            try {
                const health = await fetchWithCache('/api/health', forceRefresh).catch(() => ({
                    prometheus: 'unknown', kubernetes: 'unknown', database: 'unknown'
                }));

                // Update status dots
                const promStatus = document.getElementById('prometheus-status');
                const k8sStatus = document.getElementById('k8s-status');
                
                promStatus.className = 'status-dot ' + (health.prometheus === 'healthy' ? 'healthy' : 'error');
                k8sStatus.className = 'status-dot ' + (health.kubernetes === 'healthy' ? 'healthy' : 'error');

                // Health panel
                document.getElementById('health-list').innerHTML = `
                    <div class="health-item">
                        <span>Prometheus</span>
                        <span class="badge ${health.prometheus === 'healthy' ? 'healthy' : 'critical'}">${health.prometheus}</span>
                    </div>
                    <div class="health-item">
                        <span>Kubernetes API</span>
                        <span class="badge ${health.kubernetes === 'healthy' ? 'healthy' : 'critical'}">${health.kubernetes}</span>
                    </div>
                    <div class="health-item">
                        <span>Database</span>
                        <span class="badge ${health.database === 'healthy' ? 'healthy' : 'critical'}">${health.database}</span>
                    </div>
                    <div class="health-item">
                        <span>Degraded Mode</span>
                        <span class="badge ${health.degraded ? 'warning' : 'healthy'}">${health.degraded ? 'Active' : 'Inactive'}</span>
                    </div>
                `;
            } catch (e) {
                console.error('Error loading health:', e);
            }
        }

        function refreshData() {
            countdown = 60;
            loadData(true);
        }

        // Countdown timer
        setInterval(() => {
            countdown--;
            document.getElementById('countdown').textContent = countdown;
            if (countdown <= 0) {
                countdown = 60;
                loadData(true);
            }
        }, 1000);

        // Initial load
        loadData();
    </script>
</body>
</html>
