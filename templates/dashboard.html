<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Autoscaler Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            /* Grafana-inspired color palette */
            --bg-canvas: #111217;
            --bg-primary: #181b1f;
            --bg-secondary: #22252b;
            --bg-tertiary: #2c3039;
            --bg-hover: #31363f;
            --border-weak: #2c3039;
            --border-medium: #3d424d;
            --text-primary: #d8d9da;
            --text-secondary: #8e8e8e;
            --text-disabled: #6e6e6e;
            --accent-blue: #3d71d9;
            --accent-green: #73bf69;
            --accent-yellow: #fade2a;
            --accent-orange: #ff9830;
            --accent-red: #f2495c;
            --accent-purple: #b877d9;
            --accent-cyan: #5794f2;
            --gradient-blue: linear-gradient(180deg, rgba(61,113,217,0.15) 0%, transparent 100%);
            --gradient-green: linear-gradient(180deg, rgba(115,191,105,0.15) 0%, transparent 100%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-canvas);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: 13px;
            line-height: 1.5;
        }
        
        /* Grafana-style Header */
        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-weak);
            padding: 0 16px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
        }
        .logo-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo-icon svg {
            width: 16px;
            height: 16px;
            fill: white;
        }
        .version-badge {
            background: var(--bg-tertiary);
            color: var(--accent-cyan);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        .header-center {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--bg-secondary);
            border-radius: 4px;
            font-size: 11px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-dot.healthy { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); }
        .status-dot.warning { background: var(--accent-yellow); box-shadow: 0 0 8px var(--accent-yellow); }
        .status-dot.error { background: var(--accent-red); box-shadow: 0 0 8px var(--accent-red); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        .time-display {
            color: var(--text-secondary);
            font-size: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        /* Main Container */
        .container {
            max-width: 1920px;
            margin: 0 auto;
            padding: 16px;
        }
        
        /* Stats Row - Grafana style */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        @media (max-width: 1200px) { .stats-row { grid-template-columns: repeat(5, 1fr); } }
        @media (max-width: 900px) { .stats-row { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 600px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
        
        .stat-panel {
            background: var(--bg-primary);
            border: 1px solid var(--border-weak);
            border-radius: 4px;
            padding: 12px 16px;
            position: relative;
            overflow: hidden;
        }
        .stat-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
        }
        .stat-panel.blue::before { background: var(--accent-blue); }
        .stat-panel.green::before { background: var(--accent-green); }
        .stat-panel.yellow::before { background: var(--accent-yellow); }
        .stat-panel.red::before { background: var(--accent-red); }
        .stat-panel.purple::before { background: var(--accent-purple); }
        .stat-panel.cyan::before { background: var(--accent-cyan); }
        .stat-panel.orange::before { background: var(--accent-orange); }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 500;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        .stat-value.blue { color: var(--accent-blue); }
        .stat-value.green { color: var(--accent-green); }
        .stat-value.yellow { color: var(--accent-yellow); }
        .stat-value.red { color: var(--accent-red); }
        .stat-value.purple { color: var(--accent-purple); }
        .stat-value.cyan { color: var(--accent-cyan); }
        .stat-value.orange { color: var(--accent-orange); }
        .stat-sub {
            font-size: 10px;
            color: var(--text-disabled);
            margin-top: 2px;
        }
        
        /* Tab Navigation - Grafana style */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border-weak);
            padding-bottom: 0;
        }
        .tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
            opacity: 0.7;
        }
        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }
        .tab:hover svg {
            opacity: 1;
        }
        .tab.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
        }
        .tab.active svg {
            opacity: 1;
        }
        
        /* Panel - Grafana style */
        .panel {
            background: var(--bg-primary);
            border: 1px solid var(--border-weak);
            border-radius: 4px;
            margin-bottom: 16px;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-weak);
            min-height: 40px;
        }
        .panel-title {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .panel-title-icon {
            font-size: 14px;
        }
        .panel-title svg {
            width: 16px;
            height: 16px;
            fill: var(--accent-cyan);
        }
        .panel-actions {
            display: flex;
            gap: 8px;
        }
        .panel-body {
            padding: 16px;
        }
        
        /* Buttons - Grafana style */
        .btn {
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-medium);
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-blue);
        }
        .btn-primary {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
        .btn-primary:hover {
            background: #4d81e9;
        }
        
        /* Alert boxes */
        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin: 16px 0;
            border-left: 4px solid;
        }
        .alert-error {
            background: rgba(229, 62, 62, 0.1);
            border-left-color: #e53e3e;
            color: #fc8181;
        }
        .alert-warning {
            background: rgba(237, 137, 54, 0.1);
            border-left-color: #ed8936;
            color: #f6ad55;
        }
        .alert-info {
            background: rgba(49, 130, 206, 0.1);
            border-left-color: #3182ce;
            color: #63b3ed;
        }
        
        /* Table - Grafana style */
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-weak);
        }
        th {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-secondary);
        }
        tr:hover {
            background: var(--bg-hover);
        }
        tr.clickable {
            cursor: pointer;
        }
        
        /* Badge - Grafana style */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .badge.healthy { background: rgba(115,191,105,0.15); color: var(--accent-green); }
        .badge.warning { background: rgba(250,222,42,0.15); color: var(--accent-yellow); }
        .badge.critical { background: rgba(242,73,92,0.15); color: var(--accent-red); }
        .badge.info { background: rgba(87,148,242,0.15); color: var(--accent-cyan); }
        .badge.steady { background: rgba(61,113,217,0.15); color: var(--accent-blue); }
        .badge.bursty { background: rgba(255,152,48,0.15); color: var(--accent-orange); }
        .badge.growing { background: rgba(115,191,105,0.15); color: var(--accent-green); }
        .badge.periodic { background: rgba(184,119,217,0.15); color: var(--accent-purple); }
        .badge.unknown { background: var(--bg-tertiary); color: var(--text-secondary); }
        
        /* Progress Bar - Grafana style */
        .progress-bar {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }
        .progress-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        .progress-fill.healthy { background: var(--accent-green); }
        .progress-fill.warning { background: var(--accent-yellow); }
        .progress-fill.critical { background: var(--accent-red); }
        .progress-fill.blue { background: var(--accent-blue); }
        
        /* Chart Container */
        .chart-container { height: 180px; }
        .chart-container-lg { height: 250px; }
        .chart-container-sm { height: 140px; }
        
        /* Grid Layouts */
        .main-grid {
            display: block;
        }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        @media (max-width: 900px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } }
        
        /* Metric Display */
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-weak);
        }
        .metric-row:last-child { border-bottom: none; }
        .metric-label { color: var(--text-secondary); font-size: 12px; }
        .metric-value { font-weight: 500; font-family: 'Monaco', 'Menlo', monospace; }
        
        /* Resource Card - Grafana style */
        .resource-card {
            background: var(--bg-secondary);
            border-radius: 4px;
            padding: 16px;
        }
        .resource-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 500;
        }
        .resource-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .resource-icon.cpu { background: rgba(87,148,242,0.2); color: var(--accent-cyan); }
        .resource-icon.memory { background: rgba(184,119,217,0.2); color: var(--accent-purple); }
        
        .resource-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        .resource-stat-label {
            font-size: 10px;
            color: var(--text-disabled);
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        .resource-stat-value {
            font-size: 16px;
            font-weight: 500;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        /* Big Progress Bar */
        .big-progress {
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .big-progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 11px;
            font-weight: 500;
            color: white;
        }
        .big-progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-disabled);
            margin-top: 4px;
        }
        
        /* Insight Card */
        .insight-card {
            background: var(--bg-secondary);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .insight-title {
            font-weight: 500;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .insight-value {
            font-size: 18px;
            font-weight: 600;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        .insight-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        /* Timeline */
        .timeline-event {
            display: flex;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-weak);
        }
        .timeline-event:last-child { border-bottom: none; }
        .timeline-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        .timeline-icon.up { background: rgba(115,191,105,0.2); color: var(--accent-green); }
        .timeline-icon.down { background: rgba(242,73,92,0.2); color: var(--accent-red); }
        .timeline-icon.change { background: rgba(87,148,242,0.2); color: var(--accent-cyan); }
        .timeline-content { flex: 1; }
        .timeline-time {
            font-size: 11px;
            color: var(--text-disabled);
            margin-top: 2px;
        }
        
        /* Gauge */
        .gauge-container { text-align: center; padding: 12px; }
        .gauge {
            position: relative;
            width: 120px;
            height: 60px;
            margin: 0 auto;
            overflow: hidden;
        }
        .gauge-bg {
            position: absolute;
            width: 120px;
            height: 60px;
            border-radius: 60px 60px 0 0;
            background: var(--bg-tertiary);
        }
        .gauge-fill {
            position: absolute;
            width: 120px;
            height: 60px;
            border-radius: 60px 60px 0 0;
            background: var(--accent-green);
            transform-origin: center bottom;
        }
        .gauge-cover {
            position: absolute;
            width: 90px;
            height: 45px;
            border-radius: 45px 45px 0 0;
            background: var(--bg-primary);
            top: 15px;
            left: 15px;
        }
        .gauge-value {
            position: absolute;
            bottom: 0;
            width: 100%;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        .gauge-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 6px;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        .empty-state-icon {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--border-weak);
            border-top: 3px solid var(--accent-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Refresh Indicator */
        .refresh-indicator {
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: var(--bg-secondary);
            padding: 8px 14px;
            border-radius: 20px;
            border: 1px solid var(--border-weak);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .spinner {
            animation: spin 1s linear infinite;
            color: var(--accent-cyan);
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Namespace Filter */
        .filter-bar {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
        }
        .filter-select {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        .filter-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        .filter-label {
            color: var(--text-secondary);
            font-size: 12px;
        }
        
        /* Recommendation Panel */
        .recommendation-panel {
            background: var(--bg-secondary);
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 3px solid var(--accent-green);
        }
        .recommendation-panel.high { border-left-color: var(--accent-red); }
        .recommendation-panel.medium { border-left-color: var(--accent-yellow); }
        .recommendation-panel.low { border-left-color: var(--accent-cyan); }
        
        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .recommendation-title {
            font-weight: 600;
            font-size: 14px;
        }
        .recommendation-savings {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-green);
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .recommendation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 12px;
        }
        .recommendation-col h4 {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .recommendation-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
        }
        .recommendation-item .label { color: var(--text-secondary); }
        .recommendation-item .value { font-family: 'Monaco', 'Menlo', monospace; }
        .recommendation-item .value.new { color: var(--accent-green); }
        .recommendation-item .value.old { color: var(--text-disabled); text-decoration: line-through; }
        
        .recommendation-warning {
            background: rgba(250,222,42,0.1);
            border: 1px solid rgba(250,222,42,0.3);
            border-radius: 4px;
            padding: 10px 12px;
            font-size: 11px;
            color: var(--accent-yellow);
            margin-top: 12px;
        }
        
        .yaml-snippet {
            background: var(--bg-canvas);
            border-radius: 4px;
            padding: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            overflow-x: auto;
            white-space: pre;
            color: var(--text-secondary);
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5zm0 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm-1-10v5l4 2 1-1.5-3-1.5V10h-2z"/>
                    </svg>
                </div>
                <span>Smart Autoscaler</span>
                <span class="version-badge" id="version">v0.0.32</span>
            </div>
        </div>
        <div class="header-center">
            <div class="status-indicator">
                <span class="status-dot healthy" id="prom-status"></span>
                <span>Prometheus</span>
            </div>
            <div class="status-indicator">
                <span class="status-dot healthy" id="k8s-status"></span>
                <span>Kubernetes</span>
            </div>
            <div class="status-indicator">
                <span class="status-dot healthy" id="db-status"></span>
                <span>Database</span>
            </div>
            <div class="status-indicator" id="autopilot-indicator" title="Autopilot Mode">
                <span class="status-dot" id="autopilot-status" style="background: var(--text-disabled);"></span>
                <span id="autopilot-label">Autopilot: OFF</span>
            </div>
        </div>
        <div class="header-right">
            <span class="time-display" id="last-update">--:--:--</span>
            <button class="btn" onclick="refreshData()">‚ü≥ Refresh</button>
        </div>
    </header>

    <div class="container">
        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-panel blue">
                <div class="stat-label">Deployments / Pods</div>
                <div class="stat-value blue"><span id="stat-deployments">-</span> / <span id="stat-pods">-</span></div>
                <div class="stat-sub">watched / running</div>
            </div>
            <div class="stat-panel green">
                <div class="stat-label">CPU / Efficiency</div>
                <div class="stat-value green"><span id="stat-cpu">-</span>% / <span id="stat-efficiency">-</span>%</div>
                <div class="stat-sub">utilization / resource</div>
            </div>
            <div class="stat-panel yellow">
                <div class="stat-label">Cost / Savings</div>
                <div class="stat-value yellow">$<span id="stat-cost">-</span> / $<span id="stat-savings">-</span></div>
                <div class="stat-sub">monthly / potential</div>
            </div>
            <div class="stat-panel cyan">
                <div class="stat-label">Predictions</div>
                <div class="stat-value cyan" id="stat-accuracy">-%</div>
                <div class="stat-sub">accuracy</div>
            </div>
            <div class="stat-panel orange">
                <div class="stat-label">Scale Events</div>
                <div class="stat-value orange" id="stat-events">-</div>
                <div class="stat-sub">last 24h</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="deployments">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                Deployments
            </button>
            <button class="tab" data-tab="cluster">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 13H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1v-6c0-.55-.45-1-1-1zM7 19c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM20 3H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1zM7 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                Cluster
            </button>
            <button class="tab" data-tab="node-efficiency">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 3v18h18V3H3zm16 16H5V5h14v14zM11 7h2v2h-2zM7 7h2v2H7zm8 0h2v2h-2zm-8 4h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2zm-8 4h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/></svg>
                Node Efficiency
            </button>
            <button class="tab" data-tab="finops">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
                FinOps
            </button>
            <button class="tab" data-tab="cost-reports">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/></svg>
                Cost & Reports
            </button>
            <button class="tab" data-tab="insights">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                AI Insights
            </button>
            <button class="tab" data-tab="timeline">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M23 8c0 1.1-.9 2-2 2-.18 0-.35-.02-.51-.07l-3.56 3.55c.05.16.07.34.07.52 0 1.1-.9 2-2 2s-2-.9-2-2c0-.18.02-.36.07-.52l-2.55-2.55c-.16.05-.34.07-.52.07s-.36-.02-.52-.07l-4.55 4.56c.05.16.07.33.07.51 0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2c.18 0 .35.02.51.07l4.56-4.55C8.02 9.36 8 9.18 8 9c0-1.1.9-2 2-2s2 .9 2 2c0 .18-.02.36-.07.52l2.55 2.55c.16-.05.34-.07.52-.07s.36.02.52.07l3.55-3.56C19.02 8.35 19 8.18 19 8c0-1.1.9-2 2-2s2 .9 2 2z"/></svg>
                Timeline
            </button>
            <button class="tab" data-tab="predictions">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
                Predictions
            </button>
            <button class="tab" data-tab="prescale">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4V7zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                Pre-Scale
            </button>
            <button class="tab" data-tab="alerts">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                Alerts
            </button>
            <button class="tab" data-tab="hpa-analysis">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                HPA Analysis
            </button>
            <button class="tab" data-tab="autopilot">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                Autopilot
            </button>
            <button class="tab" data-tab="config">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                Config
            </button>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <span class="filter-label">Namespace:</span>
            <select id="namespace-filter" class="filter-select">
                <option value="all">All Namespaces</option>
            </select>
        </div>

        <div class="main-grid">
            <div class="main-content">
                <!-- Deployments Tab -->
                <div class="panel tab-content" id="tab-deployments">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üìä</span> Watched Deployments</span>
                        <div class="panel-actions">
                            <button class="btn" onclick="refreshData()">‚ü≥ Refresh</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Deployment</th>
                                    <th>Priority</th>
                                    <th>Autopilot</th>
                                    <th>CPU Usage</th>
                                    <th>CPU Req</th>
                                    <th>Mem Req</th>
                                    <th>Pods</th>
                                    <th>HPA Target</th>
                                    <th>Pattern</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="deployments-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Cluster Tab -->
                <div class="panel tab-content" id="tab-cluster" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üñ•Ô∏è</span> Cluster Monitoring</span>
                        <div class="panel-actions">
                            <span id="cloud-provider-badge" class="badge info" style="margin-right:12px;">Detecting...</span>
                            <button class="btn" onclick="loadClusterMetrics()">‚ü≥ Refresh</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <!-- Cluster Summary -->
                        <div class="grid-4" style="margin-bottom:16px;">
                            <div class="stat-panel blue">
                                <div class="stat-label">Nodes</div>
                                <div class="stat-value blue" id="cluster-node-count">-</div>
                                <div class="stat-sub">active nodes</div>
                            </div>
                            <div class="stat-panel green">
                                <div class="stat-label">Total Pods</div>
                                <div class="stat-value green" id="cluster-pod-count">-</div>
                                <div class="stat-sub">across cluster</div>
                            </div>
                            <div class="stat-panel cyan">
                                <div class="stat-label">Kubernetes</div>
                                <div class="stat-value cyan" id="k8s-version" style="font-size:16px;">-</div>
                                <div class="stat-sub" id="k8s-platform">detecting...</div>
                            </div>
                            <div class="stat-panel purple">
                                <div class="stat-label">Cloud Provider</div>
                                <div class="stat-value purple" id="cloud-provider-name" style="font-size:16px;">-</div>
                                <div class="stat-sub" id="cloud-provider-region">detecting...</div>
                            </div>
                        </div>
                        
                        <!-- Cluster Health -->
                        <div class="insight-card" style="margin-bottom:16px;">
                            <div class="insight-header">
                                <span class="insight-title">üè• Cluster Health</span>
                                <span class="badge" id="cluster-health-badge">-</span>
                            </div>
                            <div class="insight-desc" id="cluster-health-desc">Analyzing cluster status...</div>
                        </div>
                        
                        <!-- CPU Resources -->
                        <div class="resource-card" style="margin-bottom:16px;">
                            <div class="resource-header">
                                <div class="resource-icon cpu">üíª</div>
                                <span>CPU Resources</span>
                            </div>
                            <div class="resource-stats">
                                <div>
                                    <div class="resource-stat-label">Capacity</div>
                                    <div class="resource-stat-value" id="cpu-capacity">- cores</div>
                                </div>
                                <div>
                                    <div class="resource-stat-label">Allocatable</div>
                                    <div class="resource-stat-value" id="cpu-allocatable">- cores</div>
                                </div>
                                <div>
                                    <div class="resource-stat-label">Requested</div>
                                    <div class="resource-stat-value" style="color:var(--accent-yellow)" id="cpu-requests">- cores</div>
                                    <div style="font-size:10px;color:var(--text-disabled)" id="cpu-requests-pct">-</div>
                                </div>
                                <div>
                                    <div class="resource-stat-label">Usage</div>
                                    <div class="resource-stat-value" style="color:var(--accent-green)" id="cpu-usage">- cores</div>
                                    <div style="font-size:10px;color:var(--text-disabled)" id="cpu-usage-pct">-</div>
                                </div>
                            </div>
                            <div class="big-progress">
                                <div id="cpu-usage-bar" class="big-progress-fill" style="width:0%;background:var(--accent-green);"></div>
                            </div>
                            <div class="big-progress-label">
                                <span>0%</span>
                                <span>CPU Usage vs Allocatable</span>
                                <span>100%</span>
                            </div>
                        </div>
                        
                        <!-- Memory Resources -->
                        <div class="resource-card" style="margin-bottom:16px;">
                            <div class="resource-header">
                                <div class="resource-icon memory">üß†</div>
                                <span>Memory Resources</span>
                            </div>
                            <div class="resource-stats">
                                <div>
                                    <div class="resource-stat-label">Capacity</div>
                                    <div class="resource-stat-value" id="mem-capacity">- GB</div>
                                </div>
                                <div>
                                    <div class="resource-stat-label">Allocatable</div>
                                    <div class="resource-stat-value" id="mem-allocatable">- GB</div>
                                </div>
                                <div>
                                    <div class="resource-stat-label">Requested</div>
                                    <div class="resource-stat-value" style="color:var(--accent-yellow)" id="mem-requests">- GB</div>
                                    <div style="font-size:10px;color:var(--text-disabled)" id="mem-requests-pct">-</div>
                                </div>
                                <div>
                                    <div class="resource-stat-label">Usage</div>
                                    <div class="resource-stat-value" style="color:var(--accent-purple)" id="mem-usage">- GB</div>
                                    <div style="font-size:10px;color:var(--text-disabled)" id="mem-usage-pct">-</div>
                                </div>
                            </div>
                            <div class="big-progress">
                                <div id="mem-usage-bar" class="big-progress-fill" style="width:0%;background:var(--accent-purple);"></div>
                            </div>
                            <div class="big-progress-label">
                                <span>0%</span>
                                <span>Memory Usage vs Allocatable</span>
                                <span>100%</span>
                            </div>
                        </div>
                        
                        <!-- Trend Charts -->
                        <div class="grid-2" style="margin-bottom:16px;">
                            <div class="resource-card">
                                <div class="resource-header">CPU Trend (24h)</div>
                                <div class="chart-container-sm">
                                    <canvas id="cluster-cpu-history-chart"></canvas>
                                </div>
                            </div>
                            <div class="resource-card">
                                <div class="resource-header">Memory Trend (24h)</div>
                                <div class="chart-container-sm">
                                    <canvas id="cluster-mem-history-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Nodes Table -->
                        <div class="resource-card">
                            <div class="resource-header">üì¶ Nodes Detail</div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Node</th>
                                            <th>CPU Capacity</th>
                                            <th>CPU Usage</th>
                                            <th>CPU %</th>
                                            <th>Memory Capacity</th>
                                            <th>Memory Usage</th>
                                            <th>Memory %</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="nodes-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Node Efficiency Tab -->
                <div class="panel tab-content" id="tab-node-efficiency" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width:18px;height:18px;fill:var(--accent-cyan)"><path d="M3 3v18h18V3H3zm16 16H5V5h14v14zM11 7h2v2h-2zM7 7h2v2H7zm8 0h2v2h-2zm-8 4h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2zm-8 4h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/></svg>
                            Node Efficiency Analysis
                        </span>
                        <div class="panel-actions">
                            <button class="btn" onclick="loadNodeEfficiency()">‚ü≥ Refresh</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <!-- Efficiency Score -->
                        <div class="grid-4" style="margin-bottom:16px;">
                            <div class="stat-panel cyan">
                                <div class="stat-label">Bin-Packing Score</div>
                                <div class="stat-value cyan" id="binpacking-score">-</div>
                                <div class="stat-sub">out of 100</div>
                            </div>
                            <div class="stat-panel blue">
                                <div class="stat-label">Total Nodes</div>
                                <div class="stat-value blue" id="node-total-count">-</div>
                                <div class="stat-sub">in cluster</div>
                            </div>
                            <div class="stat-panel yellow">
                                <div class="stat-label">Underutilized</div>
                                <div class="stat-value yellow" id="node-underutilized">-</div>
                                <div class="stat-sub">nodes <30%</div>
                            </div>
                            <div class="stat-panel red">
                                <div class="stat-label">Overutilized</div>
                                <div class="stat-value red" id="node-overutilized">-</div>
                                <div class="stat-sub">nodes >85%</div>
                            </div>
                        </div>

                        <!-- Resource Waste -->
                        <div class="grid-2" style="margin-bottom:16px;">
                            <div class="resource-card">
                                <div class="resource-header">
                                    <div class="resource-icon cpu">üíª</div>
                                    <span>CPU Waste Analysis</span>
                                </div>
                                <div class="resource-stats">
                                    <div>
                                        <div class="resource-stat-label">Requested</div>
                                        <div class="resource-stat-value" id="node-cpu-requests">- cores</div>
                                    </div>
                                    <div>
                                        <div class="resource-stat-label">Actually Used</div>
                                        <div class="resource-stat-value" style="color:var(--accent-green)" id="node-cpu-usage">- cores</div>
                                    </div>
                                    <div>
                                        <div class="resource-stat-label">Wasted</div>
                                        <div class="resource-stat-value" style="color:var(--accent-red)" id="node-cpu-wasted">- cores</div>
                                    </div>
                                </div>
                                <div class="big-progress">
                                    <div id="node-cpu-util-bar" class="big-progress-fill" style="width:0%;background:var(--accent-green);"></div>
                                </div>
                                <div class="big-progress-label">
                                    <span>Actual Utilization</span>
                                    <span id="node-cpu-util-pct">0%</span>
                                </div>
                            </div>

                            <div class="resource-card">
                                <div class="resource-header">
                                    <div class="resource-icon memory">üß†</div>
                                    <span>Memory Waste Analysis</span>
                                </div>
                                <div class="resource-stats">
                                    <div>
                                        <div class="resource-stat-label">Requested</div>
                                        <div class="resource-stat-value" id="node-mem-requests">- GB</div>
                                    </div>
                                    <div>
                                        <div class="resource-stat-label">Actually Used</div>
                                        <div class="resource-stat-value" style="color:var(--accent-purple)" id="node-mem-usage">- GB</div>
                                    </div>
                                    <div>
                                        <div class="resource-stat-label">Wasted</div>
                                        <div class="resource-stat-value" style="color:var(--accent-red)" id="node-mem-wasted">- GB</div>
                                    </div>
                                </div>
                                <div class="big-progress">
                                    <div id="node-mem-util-bar" class="big-progress-fill" style="width:0%;background:var(--accent-purple);"></div>
                                </div>
                                <div class="big-progress-label">
                                    <span>Actual Utilization</span>
                                    <span id="node-mem-util-pct">0%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Recommendations -->
                        <div class="panel" style="margin-bottom:16px;">
                            <div class="panel-header">
                                <span class="panel-title">üí° Optimization Recommendations</span>
                            </div>
                            <div class="panel-body">
                                <div id="node-recommendations" style="display:flex;flex-direction:column;gap:8px;">
                                    <div style="color:var(--text-secondary);text-align:center;padding:20px;">
                                        Loading recommendations...
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Node Breakdown Table -->
                        <div class="panel">
                            <div class="panel-header">
                                <span class="panel-title">üìä Node Breakdown</span>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Node Name</th>
                                            <th>Type</th>
                                            <th>CPU Alloc</th>
                                            <th>CPU Usage</th>
                                            <th>CPU Util%</th>
                                            <th>Mem Alloc</th>
                                            <th>Mem Usage</th>
                                            <th>Mem Util%</th>
                                            <th>Pods</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="node-breakdown-body">
                                        <tr>
                                            <td colspan="10" style="text-align:center;color:var(--text-secondary);padding:20px;">
                                                Loading node data...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FinOps Tab -->
                <div class="panel tab-content" id="tab-finops" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üí∞</span> FinOps Resource Right-Sizing + Real-time</span>
                        <div class="panel-actions">
                            <span id="finops-summary-stats" style="font-size:11px;color:var(--text-secondary);margin-right:12px;"></span>
                            <button class="btn" onclick="loadFinOpsSummary()">‚ü≥ Refresh</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <!-- Info Banner -->
                        <div style="background:var(--bg-secondary);border-left:3px solid var(--accent-cyan);padding:12px;margin-bottom:16px;border-radius:4px;">
                            <div style="font-size:12px;line-height:1.6;color:var(--text-secondary);">
                                <strong style="color:var(--text-primary);">üí° Resource Right-Sizing + Real-time Waste Tracking</strong><br/>
                                Combines historical analysis (P95 + buffer) with <strong>live Prometheus data</strong> to show both optimization recommendations AND current waste.
                                Each workload shows real-time cost/waste from Prometheus alongside right-sizing suggestions.
                            </div>
                        </div>
                        <!-- Cost Trends Chart -->
                        <div class="resource-card" style="margin-bottom:16px;">
                            <div class="resource-header">
                                <span>üìä Cost Trends (30 days)</span>
                                <span id="cost-trend-summary" style="font-size:11px;color:var(--text-secondary);"></span>
                            </div>
                            <div class="chart-container">
                                <canvas id="cost-trends-chart"></canvas>
                            </div>
                        </div>
                        <!-- Recommendations List -->
                        <div id="finops-content">
                            <div class="empty-state">
                                <div class="empty-state-icon">üí∞</div>
                                <div>Loading recommendations...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Insights Tab -->
                <div class="panel tab-content" id="tab-insights" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üß†</span> AI Insights</span>
                    </div>
                    <div class="panel-body" id="insights-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">üß†</div>
                            <div>Loading insights...</div>
                        </div>
                    </div>
                </div>

                <!-- Timeline Tab -->
                <div class="panel tab-content" id="tab-timeline" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üìà</span> Scaling Timeline</span>
                    </div>
                    <div class="panel-body" id="timeline-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìà</div>
                            <div>No scaling events yet</div>
                        </div>
                    </div>
                </div>

                <!-- Predictions Tab -->
                <div class="panel tab-content" id="tab-predictions" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üîÆ</span> AI Predictions</span>
                        <div class="panel-actions">
                            <span id="prediction-stats" style="font-size:11px;color:var(--text-secondary);margin-right:12px;"></span>
                            <button class="btn" onclick="loadPredictionAccuracy()">‚ü≥ Refresh</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <!-- Prediction Accuracy Chart -->
                        <div class="grid-2" style="margin-bottom:16px;">
                            <div class="resource-card">
                                <div class="resource-header">üìä Prediction vs Actual (7 days)</div>
                                <div class="chart-container">
                                    <canvas id="prediction-accuracy-chart"></canvas>
                                </div>
                            </div>
                            <div class="resource-card">
                                <div class="resource-header">üìà Daily Accuracy Trend</div>
                                <div class="chart-container">
                                    <canvas id="daily-accuracy-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <!-- Prediction History -->
                        <div id="predictions-content">
                            <div class="empty-state">
                                <div class="empty-state-icon">üîÆ</div>
                                <div>Select a deployment to view predictions</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pre-Scale Tab -->
                <div class="panel tab-content" id="tab-prescale" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üöÄ</span> Pre-Scale Management</span>
                        <div class="panel-actions">
                            <span id="prescale-stats" style="font-size:11px;color:var(--text-secondary);margin-right:12px;"></span>
                            <button class="btn" onclick="loadPrescaleData()">‚ü≥ Refresh</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <!-- Pre-Scale Summary -->
                        <div class="grid-4" style="margin-bottom:16px;">
                            <div class="stat-panel green">
                                <div class="stat-label">Normal</div>
                                <div class="stat-value green" id="prescale-normal">-</div>
                            </div>
                            <div class="stat-panel yellow">
                                <div class="stat-label">Pre-Scaling</div>
                                <div class="stat-value yellow" id="prescale-active">-</div>
                            </div>
                            <div class="stat-panel cyan">
                                <div class="stat-label">Success Rate</div>
                                <div class="stat-value cyan" id="prescale-success">-%</div>
                            </div>
                            <div class="stat-panel purple">
                                <div class="stat-label">Total Actions</div>
                                <div class="stat-value purple" id="prescale-total">-</div>
                            </div>
                        </div>
                        
                        <!-- Pre-Scale Profiles Table -->
                        <div class="resource-card" style="margin-bottom:16px;">
                            <div class="resource-header">üìã Pre-Scale Profiles</div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Deployment</th>
                                            <th>State</th>
                                            <th>Original Min</th>
                                            <th>Current Min</th>
                                            <th>Predicted CPU</th>
                                            <th>Confidence</th>
                                            <th>Rollback At</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="prescale-profiles-body">
                                        <tr>
                                            <td colspan="8" style="text-align:center;color:var(--text-secondary);">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Pre-Scale Info -->
                        <div class="alert alert-info">
                            <strong>How Pre-Scale Works:</strong><br>
                            1. ML models predict CPU spike in 15-60 minutes<br>
                            2. Original HPA minReplicas is stored<br>
                            3. minReplicas is increased to force immediate scale-up<br>
                            4. Pods are ready BEFORE traffic arrives<br>
                            5. Auto-rollback after peak passes or timeout
                        </div>
                    </div>
                </div>

                <!-- Alerts Tab -->
                <div class="panel tab-content" id="tab-alerts" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üîî</span> Alerts & Notifications</span>
                        <div class="panel-actions">
                            <span id="alerts-summary" style="font-size:11px;color:var(--text-secondary);margin-right:12px;"></span>
                            <button class="btn" onclick="loadAlerts()">‚ü≥ Refresh</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <!-- Notification Providers Section -->
                        <div style="margin-bottom:20px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                <h4 style="font-size:13px;font-weight:500;display:flex;align-items:center;gap:8px;">
                                    <span>üì°</span> Notification Providers
                                </h4>
                                <button class="btn btn-primary" onclick="showAddProviderDialog()">+ Add Provider</button>
                            </div>
                            <div id="notification-providers-content">
                                <div class="empty-state" style="padding:20px;">
                                    <div class="spinner">‚ü≥</div>
                                    <div>Loading providers...</div>
                                </div>
                            </div>
                        </div>
                        
                        <hr style="border:none;border-top:1px solid var(--border-weak);margin:20px 0;">
                        
                        <!-- Alert Types Legend -->
                        <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px;padding:12px;background:var(--bg-secondary);border-radius:4px;">
                            <div style="font-size:11px;color:var(--text-secondary);">
                                <strong>Alert Types:</strong>
                            </div>
                            <div style="font-size:11px;"><span style="color:var(--accent-red)">‚óè</span> cpu_spike - Unusual CPU increase</div>
                            <div style="font-size:11px;"><span style="color:var(--accent-yellow)">‚óè</span> scaling_thrashing - Too many scale events</div>
                            <div style="font-size:11px;"><span style="color:var(--accent-purple)">‚óè</span> high_memory - Memory near limit</div>
                            <div style="font-size:11px;"><span style="color:var(--accent-cyan)">‚óè</span> low_efficiency - Wasted resources</div>
                            <div style="font-size:11px;"><span style="color:var(--accent-orange)">‚óè</span> hpa_flapping - HPA config issue</div>
                            <div style="font-size:11px;"><span style="color:var(--text-secondary)">‚óè</span> low_confidence - Unreliable predictions</div>
                        </div>
                        
                        <div id="alerts-content">
                            <div class="empty-state">
                                <div class="empty-state-icon">üîî</div>
                                <div>Loading alerts...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- HPA Analysis Panel (shown when deployment selected) -->
                <div class="panel tab-content" id="tab-hpa-analysis" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üõ°Ô∏è</span> HPA Behavior Analysis</span>
                        <div class="panel-actions">
                            <button class="btn" onclick="loadHpaAnalysis()">‚ü≥ Refresh</button>
                        </div>
                    </div>
                    <div class="panel-body" id="hpa-analysis-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">üõ°Ô∏è</div>
                            <div>Select a deployment to analyze HPA behavior</div>
                        </div>
                    </div>
                </div>

                <!-- Cost & Reports Tab (Merged - Real-time Prometheus-based) -->
                <div class="panel tab-content" id="tab-cost-reports" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">üí∞</span> Cost & Reports (Real-time)</span>
                        <div class="panel-actions">
                            <button class="btn" onclick="loadCostReports()">‚ü≥ Refresh</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <!-- Cost Summary Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-label">Hourly Cost</div>
                                <div class="stat-value" id="rt-hourly-cost">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Daily Cost</div>
                                <div class="stat-value" id="rt-daily-cost">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Monthly Cost</div>
                                <div class="stat-value" id="rt-monthly-cost">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Monthly Waste</div>
                                <div class="stat-value" id="rt-monthly-waste" style="color: #f85149;">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Waste %</div>
                                <div class="stat-value" id="rt-waste-percent" style="color: #d29922;">-</div>
                            </div>
                        </div>

                        <!-- Cluster Summary -->
                        <div style="background: #1c1f26; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                            <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #e6edf3;">üñ•Ô∏è Cluster Summary</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;" id="cluster-cost-summary">
                                <div><span style="color: #8b949e;">Nodes:</span> <span id="cs-nodes">-</span></div>
                                <div><span style="color: #8b949e;">Total vCPU:</span> <span id="cs-vcpu">-</span></div>
                                <div><span style="color: #8b949e;">Total Memory:</span> <span id="cs-memory">-</span></div>
                                <div><span style="color: #8b949e;">CPU Requests:</span> <span id="cs-cpu-req">-</span></div>
                                <div><span style="color: #8b949e;">CPU Util:</span> <span id="cs-cpu-util">-</span></div>
                                <div><span style="color: #8b949e;">Mem Util:</span> <span id="cs-mem-util">-</span></div>
                            </div>
                        </div>

                        <!-- 30-Day Cluster Cost History -->
                        <div style="background: #1c1f26; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 style="margin: 0; font-size: 14px; color: #e6edf3;">üìà Cluster Cost History (30 Days)</h3>
                                <span id="cluster-cost-history-summary" style="font-size: 11px; color: #8b949e;"></span>
                            </div>
                            <div class="chart-container" style="height: 200px;">
                                <canvas id="cluster-cost-history-chart"></canvas>
                            </div>
                            <div id="cluster-cost-history-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #30363d;">
                                <div><span style="color: #8b949e;">30-Day Total:</span> <span id="cch-total">-</span></div>
                                <div><span style="color: #8b949e;">30-Day Waste:</span> <span id="cch-waste" style="color: #f85149;">-</span></div>
                                <div><span style="color: #8b949e;">Avg Daily:</span> <span id="cch-avg-daily">-</span></div>
                                <div><span style="color: #8b949e;">Efficiency:</span> <span id="cch-efficiency" style="color: #3fb950;">-</span></div>
                            </div>
                        </div>

                        <!-- Daily Report Alerting Config -->
                        <div style="background: #1c1f26; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                            <h3 style="margin: 0 0 16px 0; font-size: 14px; color: #e6edf3;">üì¨ Daily Cost Report Alerts</h3>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="alert-enabled" onchange="toggleAlertEnabled()" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span>Enable daily cost report to Slack/webhook</span>
                                </label>
                                
                                <div id="alert-config" style="display: none; padding-left: 26px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                        <div>
                                            <label style="display: block; font-size: 12px; color: #8b949e; margin-bottom: 4px;">Alert Time (HH:MM)</label>
                                            <input type="time" id="alert-time" value="09:00" style="width: 100%; padding: 8px; background: #0d1117; border: 1px solid #30363d; border-radius: 4px; color: #e6edf3;">
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 12px; color: #8b949e; margin-bottom: 4px;">Status</label>
                                            <div id="alert-status" style="padding: 8px; background: #0d1117; border-radius: 4px; font-size: 12px;">Not configured</div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-size: 12px; color: #8b949e; margin-bottom: 4px;">Slack Webhook URL</label>
                                        <input type="text" id="slack-webhook" placeholder="https://hooks.slack.com/services/..." style="width: 100%; padding: 8px; background: #0d1117; border: 1px solid #30363d; border-radius: 4px; color: #e6edf3;">
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-size: 12px; color: #8b949e; margin-bottom: 4px;">Generic Webhook URL (optional)</label>
                                        <input type="text" id="generic-webhook" placeholder="https://your-webhook-endpoint.com/..." style="width: 100%; padding: 8px; background: #0d1117; border: 1px solid #30363d; border-radius: 4px; color: #e6edf3;">
                                    </div>
                                    
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-primary" onclick="saveAlertConfig()">üíæ Save</button>
                                        <button class="btn" onclick="testAlert()">üß™ Test</button>
                                        <button class="btn" onclick="sendReportNow()">üì§ Send Now</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Workload Costs Table -->
                        <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #e6edf3;">üìä Workload Costs (Real-time from Prometheus)</h3>
                        <div id="realtime-costs-table" style="overflow-x: auto;">
                            <div class="loading-spinner">
                                <div class="spinner-icon">‚ü≥</div>
                                <div>Loading real-time costs...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Autopilot Tab -->
                <div class="panel tab-content" id="tab-autopilot" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">ü§ñ</span> Autopilot - Automatic Resource Tuning</span>
                        <div class="panel-actions">
                            <button class="btn" onclick="loadAutopilotData(true)">‚ü≥ Refresh</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <!-- Autopilot Status -->
                        <div class="grid-3" style="margin-bottom: 16px;">
                            <div class="stat-panel green">
                                <div class="stat-label">Status</div>
                                <div class="stat-value green" id="autopilot-mode-status">-</div>
                                <div class="stat-sub" id="autopilot-mode-level">-</div>
                            </div>
                            <div class="stat-panel cyan">
                                <div class="stat-label">Recommendations</div>
                                <div class="stat-value cyan" id="autopilot-rec-count">0</div>
                                <div class="stat-sub" id="autopilot-pending">0 pending</div>
                            </div>
                            <div class="stat-panel purple">
                                <div class="stat-label">Actions Applied</div>
                                <div class="stat-value purple" id="autopilot-action-count">0</div>
                                <div class="stat-sub" id="autopilot-rollbacks">0 rollbacks</div>
                            </div>
                        </div>

                        <!-- Autopilot Config -->
                        <div class="insight-card" style="margin-bottom: 16px;">
                            <div class="insight-header">
                                <span class="insight-title">‚öôÔ∏è Configuration</span>
                            </div>
                            <div class="grid-4" style="margin-top: 12px;" id="autopilot-config">
                                <div>
                                    <div class="resource-stat-label">Min Observation</div>
                                    <div class="resource-stat-value" id="ap-min-obs">7 days</div>
                                </div>
                                <div>
                                    <div class="resource-stat-label">Min Confidence</div>
                                    <div class="resource-stat-value" id="ap-min-conf">80%</div>
                                </div>
                                <div>
                                    <div class="resource-stat-label">Max Change</div>
                                    <div class="resource-stat-value" id="ap-max-change">30%</div>
                                </div>
                                <div>
                                    <div class="resource-stat-label">Cooldown</div>
                                    <div class="resource-stat-value" id="ap-cooldown">24h</div>
                                </div>
                            </div>
                        </div>

                        <!-- Recommendations Table -->
                        <h4 style="margin: 16px 0 8px; color: var(--text-secondary);">üìã Current Recommendations</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Deployment</th>
                                        <th>Current CPU</th>
                                        <th>Recommended CPU</th>
                                        <th>Current Memory</th>
                                        <th>Recommended Memory</th>
                                        <th>Confidence</th>
                                        <th>Savings</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="autopilot-recommendations">
                                    <tr><td colspan="9" class="empty-state">No recommendations yet</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Actions History -->
                        <h4 style="margin: 24px 0 8px; color: var(--text-secondary);">üìú Recent Actions</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Deployment</th>
                                        <th>Action</th>
                                        <th>Change</th>
                                        <th>Reason</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="autopilot-actions">
                                    <tr><td colspan="6" class="empty-state">No actions yet</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Cooldown Status -->
                        <div id="autopilot-cooldowns" style="margin-top: 16px;"></div>
                    </div>
                </div>

                <!-- Config Tab -->
                <div class="panel tab-content" id="tab-config" style="display:none">
                    <div class="panel-header">
                        <span class="panel-title"><span class="panel-title-icon">‚öôÔ∏è</span> Configuration</span>
                        <div class="panel-actions">
                            <button class="btn btn-primary" onclick="reloadConfig()">üîÑ Hot Reload</button>
                        </div>
                    </div>
                    <div class="panel-body" id="config-content"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="refresh-indicator">
        <span class="spinner">‚ü≥</span>
        <span id="countdown">30</span>s
    </div>

    <script>
        let state = { deployments: [], cpuChart: null, costChart: null, countdown: 30, currentDep: null, current: {} };
        const cache = new Map();
        const CACHE_TTL = 10000;
        
        // Chart.js global config for Grafana style
        Chart.defaults.color = '#8e8e8e';
        Chart.defaults.borderColor = '#2c3039';
        Chart.defaults.font.family = "'Inter', sans-serif";
        
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => loadClusterMetrics(), 500);
        });

        async function fetchAPI(url, force = false) {
            const now = Date.now();
            if (!force && cache.has(url)) {
                const { data, time } = cache.get(url);
                if (now - time < CACHE_TTL) return data;
            }
            try {
                const res = await fetch(url);
                if (!res.ok) return null;
                const data = await res.json();
                cache.set(url, { data, time: now });
                return data;
            } catch (e) { return null; }
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).style.display = 'block';
                
                if (tab.dataset.tab === 'cluster') loadClusterMetrics();
                else if (tab.dataset.tab === 'node-efficiency') loadNodeEfficiency();
                else if (tab.dataset.tab === 'finops') { loadFinOpsSummary(); loadCostTrends(); }
                else if (tab.dataset.tab === 'cost-reports') loadCostReports();
                else if (tab.dataset.tab === 'alerts') { loadAlerts(); loadNotificationProviders(); }
                else if (tab.dataset.tab === 'hpa-analysis') loadHpaAnalysis();
                else if (tab.dataset.tab === 'predictions') loadPredictionAccuracy();
                else if (tab.dataset.tab === 'autopilot') loadAutopilotData();
                else if (tab.dataset.tab === 'prescale') loadPrescaleData();
                else if (state.currentDep) {
                    const [ns, dep] = state.currentDep.split('/');
                    if (tab.dataset.tab === 'insights') loadInsights(ns, dep, true);
                    if (tab.dataset.tab === 'timeline') loadTimeline(ns, dep, true);
                }
            });
        });

        async function loadData(force = false) {
            await Promise.all([loadOverview(force), loadDeployments(force), loadHealth(force), loadConfig(force)]);
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        async function loadOverview(force) {
            const data = await fetchAPI('/api/overview', force);
            if (!data) return;
            document.getElementById('stat-deployments').textContent = data.total_deployments || 0;
            document.getElementById('stat-cost').textContent = (data.total_monthly_cost || 0).toFixed(0);
            document.getElementById('stat-savings').textContent = (data.total_savings_potential || 0).toFixed(0);
        }

        async function loadDeployments(force) {
            const deployments = await fetchAPI('/api/deployments', force) || [];
            state.deployments = deployments;
            
            let totalPods = 0, totalCpu = 0, totalEfficiency = 0, totalEvents = 0;
            let rows = '';

            for (const dep of deployments) {
                const [current, insights, autopilotStatus] = await Promise.all([
                    fetchAPI(`/api/deployment/${dep.namespace}/${dep.deployment}/current`, force),
                    fetchAPI(`/api/ai/insights/${dep.deployment}`, force),
                    fetchAPI(`/api/autopilot/deployment/${dep.namespace}/${dep.deployment}`, force)
                ]);
                
                if (!current) {
                    rows += `<tr><td>${dep.deployment}</td><td colspan="9" style="color:var(--text-secondary)">Loading...</td></tr>`;
                    continue;
                }

                if (!state.currentDep) state.currentDep = `${dep.namespace}/${dep.deployment}`;

                totalPods += current.pod_count || 0;
                const cpuPct = (current.pod_cpu_usage || 0) * 100;
                totalCpu += cpuPct;
                
                const efficiency = insights?.efficiency?.cpu_efficiency || 0;
                totalEfficiency += efficiency;
                totalEvents += insights?.scaling_events?.length || 0;

                const cpuStatus = cpuPct > 80 ? 'critical' : cpuPct > 50 ? 'warning' : 'healthy';
                const pattern = current.pattern || 'unknown';
                const cpuReq = current.cpu_request || 0;
                const memReq = current.memory_request || 0;
                const priority = current.priority || 'medium';
                
                const priorityColors = {
                    'critical': 'critical', 'high': 'warning', 'medium': 'healthy',
                    'low': 'info', 'best_effort': 'info'
                };
                
                // Autopilot status badge
                let autopilotBadge = '<span class="badge unknown">OFF</span>';
                if (autopilotStatus?.enabled) {
                    if (autopilotStatus.has_recommendation) {
                        autopilotBadge = `<span class="badge healthy" title="${autopilotStatus.recommendation?.cpu || ''}">‚úì REC</span>`;
                    } else {
                        autopilotBadge = '<span class="badge info">ON</span>';
                    }
                }

                rows += `<tr class="clickable" onclick="selectDeployment('${dep.namespace}', '${dep.deployment}')">
                    <td><strong>${dep.deployment}</strong><br><small style="color:var(--text-secondary)">${dep.namespace}</small></td>
                    <td><span class="badge ${priorityColors[priority] || 'healthy'}">${priority}</span></td>
                    <td>${autopilotBadge}</td>
                    <td>
                        ${cpuPct.toFixed(1)}%
                        <div class="progress-bar"><div class="progress-fill ${cpuStatus}" style="width:${Math.min(cpuPct, 100)}%"></div></div>
                    </td>
                    <td>${cpuReq}m</td>
                    <td>${memReq}Mi</td>
                    <td>${current.pod_count || 0}</td>
                    <td>${current.hpa_target || '-'}%</td>
                    <td><span class="badge ${pattern}">${pattern}</span></td>
                    <td><span class="badge ${cpuStatus}">${cpuStatus}</span></td>
                </tr>`;

                if (deployments.indexOf(dep) === 0) {
                    loadCPUHistory(dep.namespace, dep.deployment, force);
                    updateEfficiencyGauge(efficiency);
                    if (insights?.prediction_accuracy) {
                        const acc = (insights.prediction_accuracy.accuracy || 0) * 100;
                        document.getElementById('stat-accuracy').textContent = acc.toFixed(0) + '%';
                    }
            }
            }

            document.getElementById('deployments-body').innerHTML = rows || '<tr><td colspan="10" class="empty-state">No deployments</td></tr>';
            document.getElementById('stat-pods').textContent = totalPods;
            document.getElementById('stat-cpu').textContent = deployments.length ? (totalCpu / deployments.length).toFixed(1) : '-';
            document.getElementById('stat-efficiency').textContent = deployments.length ? (totalEfficiency / deployments.length).toFixed(0) : '-';
            document.getElementById('stat-events').textContent = totalEvents;
            
            const namespaces = [...new Set(deployments.map(d => d.namespace))].sort();
            const namespaceFilter = document.getElementById('namespace-filter');
            const currentValue = namespaceFilter.value;
            namespaceFilter.innerHTML = '<option value="all">All Namespaces</option>';
            for (const ns of namespaces) {
                namespaceFilter.innerHTML += `<option value="${ns}">${ns}</option>`;
            }
            if (currentValue && (currentValue === 'all' || namespaces.includes(currentValue))) {
                namespaceFilter.value = currentValue;
            }
        }

        function selectDeployment(ns, dep) {
            state.currentDep = `${ns}/${dep}`;
            loadCPUHistory(ns, dep, true);
            loadInsights(ns, dep, true);
        }

        function populateFinOpsSelect() {
            // Deprecated - now using loadFinOpsSummary
        }

        async function loadFinOpsSummary() {
            const container = document.getElementById('finops-content');
            const statsEl = document.getElementById('finops-summary-stats');
            
            container.innerHTML = '<div class="empty-state"><div class="spinner">‚ü≥</div><div>Loading recommendations with real-time data...</div></div>';
            
            try {
                // Use enriched API that includes real-time waste data
                const res = await fetch('/api/finops/enriched');
                const data = await res.json();
                
                if (data.error) {
                    container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>${data.error}</div></div>`;
                    return;
                }
                
                // Update summary stats with real-time waste
                const s = data.summary || {};
                if (statsEl) {
                    let statsHtml = `
                        <span style="color:var(--accent-red)">üî¥ ${s.high_priority || 0}</span> ¬∑ 
                        <span style="color:var(--accent-yellow)">üü° ${s.medium_priority || 0}</span> ¬∑ 
                        <span style="color:var(--accent-cyan)">üîµ ${s.low_priority || 0}</span> ¬∑ 
                        <span style="color:var(--accent-green)">‚úÖ ${s.optimal || 0}</span>`;
                    if (s.memory_leaks_detected > 0) {
                        statsHtml += ` ¬∑ <span style="color:var(--accent-red)">‚ö†Ô∏è ${s.memory_leaks_detected} leaks</span>`;
                    }
                    if (s.has_realtime_data && s.total_realtime_waste_monthly > 0) {
                        statsHtml += ` ¬∑ <span style="color:var(--accent-orange)">üî• $${s.total_realtime_waste_monthly.toFixed(0)}/mo waste</span>`;
                    }
                    statsEl.innerHTML = statsHtml;
                }
                
                if (!data.recommendations || data.recommendations.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div>No deployments found</div></div>';
                    return;
                }
                
                let html = '';
                
                // Combined savings + waste banner
                if (s.total_monthly_savings > 0 || s.total_realtime_waste_monthly > 0) {
                    html += `<div class="recommendation-panel" style="border-left-color:var(--accent-green);margin-bottom:16px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-size:12px;color:var(--text-secondary);">Total Potential Monthly Savings</div>
                                <div style="font-size:24px;font-weight:600;color:var(--accent-green);font-family:'Monaco','Menlo',monospace;">$${s.total_monthly_savings.toFixed(2)}</div>
                            </div>
                            <div style="text-align:right;font-size:11px;color:var(--text-secondary);">
                                ${s.high_priority + s.medium_priority} deployments need attention<br>
                                ${s.optimal} deployments are optimal
                            </div>
                        </div>
                    </div>`;
                }
                
                // Render each recommendation with real-time data
                for (const rec of data.recommendations) {
                    const level = rec.recommendation_level || 'unknown';
                    const levelIcons = { high: 'üî¥', medium: 'üü°', low: 'üîµ', optimal: '‚úÖ', unknown: '‚ùì' };
                    const levelBorders = { high: 'high', medium: 'medium', low: 'low', optimal: '', unknown: '' };
                    
                    // Memory leak warning
                    let memoryLeakHtml = '';
                    if (rec.memory_leak && rec.memory_leak.is_leak_detected) {
                        const leak = rec.memory_leak;
                        memoryLeakHtml = `
                            <div class="recommendation-warning" style="background:rgba(242,73,92,0.1);border-color:rgba(242,73,92,0.3);color:var(--accent-red);">
                                <strong>‚ö†Ô∏è Memory Leak Detected (${leak.leak_severity})</strong><br>
                                <span style="font-size:10px;">
                                    ${leak.reasons ? leak.reasons.join(' ¬∑ ') : ''}
                                    ${leak.time_to_oom_hours ? ` ¬∑ Est. OOM in ${leak.time_to_oom_hours.toFixed(1)}h` : ''}
                                </span>
                            </div>`;
                    }
                    
                    // Real-time waste badge from Prometheus
                    let realtimeBadge = '';
                    if (rec.realtime) {
                        const rt = rec.realtime;
                        const wasteColor = rt.waste_percent > 50 ? 'var(--accent-red)' : rt.waste_percent > 30 ? 'var(--accent-orange)' : 'var(--accent-yellow)';
                        realtimeBadge = `
                            <div style="background:var(--bg-tertiary);border-radius:4px;padding:8px 12px;margin-top:8px;">
                                <div style="font-size:10px;color:var(--text-secondary);margin-bottom:4px;">üì° Real-time (Prometheus)</div>
                                <div style="display:flex;gap:16px;font-size:11px;flex-wrap:wrap;">
                                    <span>Cost: <strong style="color:var(--accent-cyan)">$${rt.cost_monthly.toFixed(2)}/mo</strong></span>
                                    <span>Waste: <strong style="color:${wasteColor}">$${rt.waste_monthly.toFixed(2)}/mo (${rt.waste_percent}%)</strong></span>
                                    <span>CPU: <strong>${rt.cpu_usage.toFixed(3)}/${rt.cpu_request.toFixed(3)}</strong> (${rt.cpu_utilization_percent}%)</span>
                                    <span>Pods: <strong>${rt.pod_count}</strong></span>
                                </div>
                            </div>`;
                    }
                    
                    if (rec.error) {
                        html += `
                            <div class="recommendation-panel" style="border-left-color:var(--text-secondary);">
                                <div class="recommendation-header">
                                    <div class="recommendation-title">
                                        ${levelIcons[level]} <strong>${rec.deployment}</strong>
                                        <span style="font-size:11px;color:var(--text-secondary);margin-left:8px;">${rec.namespace}</span>
                                    </div>
                                    <span class="badge unknown">Pending</span>
                                </div>
                                <div style="font-size:12px;color:var(--text-secondary);">${rec.recommendation_text}</div>
                                ${realtimeBadge}
                                <div style="font-size:10px;color:var(--text-disabled);margin-top:4px;">Updated: ${new Date(rec.updated_at).toLocaleString()}</div>
                            </div>`;
                        continue;
                    }
                    
                    const savings = rec.savings ? (rec.savings.monthly_savings_usd || 0) : 0;
                    const current = rec.current || {};
                    const recommended = rec.recommended || {};
                    const usage = rec.usage_stats || {};
                    
                    html += `
                        <div class="recommendation-panel ${levelBorders[level]}">
                            <div class="recommendation-header">
                                <div class="recommendation-title">
                                    ${levelIcons[level]} <strong>${rec.deployment}</strong>
                                    <span style="font-size:11px;color:var(--text-secondary);margin-left:8px;">${rec.namespace}</span>
                                </div>
                                <div style="text-align:right;">
                                    ${savings > 0 ? `<div class="recommendation-savings">Save $${savings.toFixed(2)}/mo</div>` : '<span class="badge healthy">Optimal</span>'}
                                </div>
                            </div>
                            
                            <div style="font-size:12px;margin-bottom:12px;">${rec.recommendation_text}</div>
                            
                            <div class="recommendation-grid">
                                <div class="recommendation-col">
                                    <h4>Current</h4>
                                    <div class="recommendation-item">
                                        <span class="label">CPU</span>
                                        <span class="value ${level !== 'optimal' ? 'old' : ''}">${current.cpu_request_millicores || '-'}m</span>
                                    </div>
                                    <div class="recommendation-item">
                                        <span class="label">Memory</span>
                                        <span class="value ${level !== 'optimal' ? 'old' : ''}">${current.memory_request_mb || '-'}Mi</span>
                                    </div>
                                    <div class="recommendation-item">
                                        <span class="label">HPA Target</span>
                                        <span class="value">${current.hpa_target_percent || '-'}%</span>
                                    </div>
                                </div>
                                <div class="recommendation-col">
                                    <h4>Recommended</h4>
                                    <div class="recommendation-item">
                                        <span class="label">CPU</span>
                                        <span class="value ${level !== 'optimal' ? 'new' : ''}">${recommended.cpu_request_millicores || '-'}m</span>
                                    </div>
                                    <div class="recommendation-item">
                                        <span class="label">Memory</span>
                                        <span class="value ${level !== 'optimal' ? 'new' : ''}">${recommended.memory_request_mb || '-'}Mi</span>
                                    </div>
                                    <div class="recommendation-item">
                                        <span class="label">HPA Target</span>
                                        <span class="value">${recommended.hpa_target_percent ? recommended.hpa_target_percent.toFixed(0) : '-'}%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display:flex;gap:16px;margin-top:8px;font-size:11px;color:var(--text-secondary);">
                                <span>Avg CPU: <strong style="color:var(--accent-cyan)">${usage.cpu_avg_millicores ? usage.cpu_avg_millicores.toFixed(0) : '-'}m</strong></span>
                                <span>P95 CPU: <strong style="color:var(--accent-yellow)">${usage.cpu_p95_millicores ? usage.cpu_p95_millicores.toFixed(0) : '-'}m</strong></span>
                                <span>Utilization: <strong style="color:var(--accent-green)">${current.cpu_utilization_percent ? current.cpu_utilization_percent.toFixed(0) : '-'}%</strong></span>
                                <span>Samples: ${rec.data_points_analyzed || '-'}</span>
                            </div>
                            
                            ${realtimeBadge}
                            ${memoryLeakHtml}
                            
                            <div style="font-size:10px;color:var(--text-disabled);margin-top:8px;">Updated: ${new Date(rec.updated_at).toLocaleString()}</div>
                        </div>`;
                }
                
                container.innerHTML = html;
            } catch (err) {
                console.error('Error loading FinOps summary:', err);
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>Error loading recommendations</div></div>`;
            }
        }

        async function loadFinOpsRecommendations() {
            const select = document.getElementById('finops-deployment-select');
            const value = select.value;
            const container = document.getElementById('finops-content');
            
            if (!value) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∞</div><div>Select a deployment to view resource recommendations</div></div>';
                return;
            }
            
            const [ns, dep] = value.split('/');
            container.innerHTML = '<div class="empty-state"><div class="spinner">‚ü≥</div><div>Loading recommendations...</div></div>';
            
            const data = await fetchAPI(`/api/deployment/${ns}/${dep}/recommendations`, true);
            
            if (!data || data.error) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìä</div><div>${data?.error || 'No recommendations available'}</div><div style="margin-top:8px;font-size:11px;color:var(--text-disabled)">${data?.suggestion || 'Need more historical data'}</div></div>`;
                return;
            }
            
            const levelColors = { high: 'high', medium: 'medium', low: 'low', optimal: '' };
            const levelIcons = { high: 'üî¥', medium: 'üü°', low: 'üîµ', optimal: '‚úÖ' };
            
            let html = `
                <div class="recommendation-panel ${levelColors[data.recommendation_level] || ''}">
                    <div class="recommendation-header">
                        <div class="recommendation-title">${levelIcons[data.recommendation_level] || ''} ${data.recommendation_text}</div>
                        <div class="recommendation-savings">Save $${data.savings?.monthly_savings_usd?.toFixed(2) || 0}/mo</div>
                    </div>
                    
                    <div class="recommendation-grid">
                        <div class="recommendation-col">
                            <h4>Current Configuration</h4>
                            <div class="recommendation-item">
                                <span class="label">CPU Request</span>
                                <span class="value old">${data.current?.cpu_request_millicores}m</span>
                            </div>
                            <div class="recommendation-item">
                                <span class="label">Memory Request</span>
                                <span class="value old">${data.current?.memory_request_mb}Mi</span>
                            </div>
                            <div class="recommendation-item">
                                <span class="label">HPA Target</span>
                                <span class="value old">${data.current?.hpa_target_percent}%</span>
                            </div>
                            <div class="recommendation-item">
                                <span class="label">Monthly Cost</span>
                                <span class="value">$${data.current?.monthly_cost_usd?.toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="recommendation-col">
                            <h4>Recommended Configuration</h4>
                            <div class="recommendation-item">
                                <span class="label">CPU Request</span>
                                <span class="value new">${data.recommended?.cpu_request_millicores}m</span>
                            </div>
                            <div class="recommendation-item">
                                <span class="label">Memory Request</span>
                                <span class="value new">${data.recommended?.memory_request_mb}Mi</span>
                            </div>
                            <div class="recommendation-item">
                                <span class="label">HPA Target</span>
                                <span class="value new">${data.recommended?.hpa_target_percent?.toFixed(0)}%</span>
                            </div>
                            <div class="recommendation-item">
                                <span class="label">Monthly Cost</span>
                                <span class="value new">$${data.recommended?.monthly_cost_usd?.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top:16px;">
                        <h4 style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px;">Usage Statistics (${data.data_points_analyzed} samples)</h4>
                        <div class="grid-4">
                            <div class="insight-card">
                                <div class="insight-title">Avg CPU</div>
                                <div class="insight-value" style="color:var(--accent-cyan)">${data.usage_stats?.cpu_avg_millicores?.toFixed(0)}m</div>
                            </div>
                            <div class="insight-card">
                                <div class="insight-title">P95 CPU</div>
                                <div class="insight-value" style="color:var(--accent-yellow)">${data.usage_stats?.cpu_p95_millicores?.toFixed(0)}m</div>
                            </div>
                            <div class="insight-card">
                                <div class="insight-title">Max CPU</div>
                                <div class="insight-value" style="color:var(--accent-red)">${data.usage_stats?.cpu_max_millicores?.toFixed(0)}m</div>
                            </div>
                            <div class="insight-card">
                                <div class="insight-title">Utilization</div>
                                <div class="insight-value" style="color:var(--accent-green)">${data.current?.cpu_utilization_percent?.toFixed(0)}%</div>
                            </div>
                        </div>
                    </div>`;
            
            // Warnings
            if (data.warnings && data.warnings.length > 0) {
                for (const warning of data.warnings) {
                    html += `<div class="recommendation-warning">${warning}</div>`;
                }
            }
            
            // YAML Snippet
            if (data.implementation?.yaml_snippet) {
                html += `
                    <div style="margin-top:16px;">
                        <h4 style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px;">YAML Configuration</h4>
                        <div class="yaml-snippet">${data.implementation.yaml_snippet}</div>
                    </div>`;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        async function loadInsights(ns, dep, force) {
            const insights = await fetchAPI(`/api/ai/insights/${dep}`, force);
            const container = document.getElementById('insights-content');
            
            if (!insights) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üß†</div>Loading insights...</div>';
                return;
            }

            // Check if GenAI is enabled
            if (insights.genai_enabled === false) {
                const helpHtml = `
                    <div class="recommendation-panel" style="border-left-color:var(--accent-cyan);margin-bottom:16px;">
                        <div class="recommendation-header">
                            <div class="recommendation-title">üí° GenAI Features Available</div>
                        </div>
                        <div style="font-size:12px;margin-top:8px;line-height:1.6;">
                            <p style="margin-bottom:8px;">Enable AI-powered insights and natural language explanations for scaling events.</p>
                            <p style="margin-bottom:8px;"><strong>Supported Providers:</strong></p>
                            <ul style="margin-left:20px;margin-bottom:8px;">
                                <li>OpenAI (GPT-4, GPT-3.5)</li>
                                <li>Google Gemini</li>
                                <li>Anthropic Claude</li>
                            </ul>
                            <p style="margin-bottom:8px;"><strong>To Enable:</strong></p>
                            <ol style="margin-left:20px;">
                                <li>Set <code style="background:var(--bg-canvas);padding:2px 6px;border-radius:3px;">ENABLE_GENAI=true</code></li>
                                <li>Configure one API key:
                                    <ul style="margin-left:20px;margin-top:4px;">
                                        <li><code style="background:var(--bg-canvas);padding:2px 6px;border-radius:3px;">OPENAI_API_KEY=sk-...</code></li>
                                        <li><code style="background:var(--bg-canvas);padding:2px 6px;border-radius:3px;">GEMINI_API_KEY=AIza...</code></li>
                                        <li><code style="background:var(--bg-canvas);padding:2px 6px;border-radius:3px;">ANTHROPIC_API_KEY=sk-ant-...</code></li>
                                    </ul>
                                </li>
                                <li>Restart the autoscaler</li>
                            </ol>
                            <p style="margin-top:8px;color:var(--text-secondary);font-size:11px;">See <code>.env.example</code> for detailed configuration examples.</p>
                        </div>
                    </div>
                `;
                
                let html = helpHtml + '<div class="grid-2">';
                
                // Show other insights even without GenAI
                const eff = insights.efficiency || {};
                html += `<div class="insight-card">
                    <div class="insight-header">
                        <span class="insight-title">üìä Resource Efficiency</span>
                        <span class="insight-value" style="color:${eff.cpu_efficiency > 70 ? 'var(--accent-green)' : 'var(--accent-yellow)'}">${(eff.cpu_efficiency || 0).toFixed(0)}%</span>
                    </div>
                    <div class="insight-desc">
                        CPU Usage: ${(eff.avg_cpu_usage || 0).toFixed(1)}% | Request: ${eff.avg_cpu_request || 0}m<br>
                        Based on ${eff.data_points || 0} data points
                    </div>
                </div>`;

                const tuning = insights.auto_tuning || {};
                html += `<div class="insight-card">
                    <div class="insight-header">
                        <span class="insight-title">üéØ Auto-Tuning</span>
                        <span class="insight-value" style="color:var(--accent-purple)">${tuning.current_optimal || '-'}%</span>
                    </div>
                    <div class="insight-desc">
                        Learning Rate: ${(tuning.learning_rate || 0.1).toFixed(2)}<br>
                        Samples: ${tuning.samples_collected || 0}
                    </div>
                </div>`;

                const pred = insights.prediction_accuracy || {};
                html += `<div class="insight-card">
                    <div class="insight-header">
                        <span class="insight-title">üîÆ Prediction Accuracy</span>
                        <span class="insight-value" style="color:var(--accent-cyan)">${((pred.accuracy || 0) * 100).toFixed(0)}%</span>
                    </div>
                    <div class="insight-desc">
                        MAE: ${(pred.mae || 0).toFixed(3)} | Validated: ${pred.validated_count || 0}<br>
                        Total Predictions: ${pred.total_predictions || 0}
                    </div>
                </div>`;

                const patterns = insights.patterns || {};
                html += `<div class="insight-card">
                    <div class="insight-header">
                        <span class="insight-title">üìà Learned Patterns</span>
                    </div>
                    <div class="insight-desc">
                        Peak Hours: ${patterns.peak_hours?.join(', ') || 'Learning...'}<br>
                        Low Hours: ${patterns.low_hours?.join(', ') || 'Learning...'}
                    </div>
                </div>`;

                html += '</div>';

                if (insights.scaling_events?.length > 0) {
                    html += '<div style="margin-top:16px"><strong>Recent Scaling Events</strong></div>';
                    html += '<div style="margin-top:8px">';
                    for (const evt of insights.scaling_events.slice(0, 5)) {
                        const icon = evt.action === 'scale_up' ? '‚Üë' : evt.action === 'scale_down' ? '‚Üì' : '‚Üî';
                        const iconClass = evt.action === 'scale_up' ? 'up' : evt.action === 'scale_down' ? 'down' : '';
                        const nsInfo = evt.namespace ? `${evt.namespace}/` : '';
                        const depName = evt.deployment || '';
                        
                        html += `<div class="timeline-event" style="cursor:pointer" onclick="showEventDetails('${evt.namespace}', '${evt.deployment}', '${evt.timestamp}', '${evt.action}', ${evt.pod_count}, ${evt.hpa_target})">
                            <div class="timeline-icon ${iconClass}">${icon}</div>
                            <div class="timeline-content">
                                <div><strong>${evt.action.replace('_', ' ')}</strong> ‚Üí ${evt.pod_count} pods (HPA: ${evt.hpa_target}%)</div>
                                <div class="timeline-time">
                                    <span style="color:var(--accent-cyan)">${nsInfo}${depName}</span> ¬∑ 
                                    ${new Date(evt.timestamp).toLocaleString()}
                                </div>
                            </div>
                        </div>`;
                    }
                    html += '</div>';
                }

                container.innerHTML = html;
                updateEfficiencyGauge(eff.cpu_efficiency || 0);
                return;
            }

            // GenAI is enabled - show provider info
            let html = '';
            if (insights.genai_provider) {
                html += `<div style="margin-bottom:12px;padding:8px 12px;background:var(--bg-secondary);border-radius:4px;font-size:11px;color:var(--accent-green);">
                    ‚úÖ GenAI Enabled (Provider: ${insights.genai_provider})
                </div>`;
            }
            
            html += '<div class="grid-2">';
            
            const eff = insights.efficiency || {};
            html += `<div class="insight-card">
                <div class="insight-header">
                    <span class="insight-title">üìä Resource Efficiency</span>
                    <span class="insight-value" style="color:${eff.cpu_efficiency > 70 ? 'var(--accent-green)' : 'var(--accent-yellow)'}">${(eff.cpu_efficiency || 0).toFixed(0)}%</span>
                </div>
                <div class="insight-desc">
                    CPU Usage: ${(eff.avg_cpu_usage || 0).toFixed(1)}% | Request: ${eff.avg_cpu_request || 0}m<br>
                    Based on ${eff.data_points || 0} data points
                </div>
            </div>`;

            const tuning = insights.auto_tuning || {};
            html += `<div class="insight-card">
                <div class="insight-header">
                    <span class="insight-title">üéØ Auto-Tuning</span>
                    <span class="insight-value" style="color:var(--accent-purple)">${tuning.current_optimal || '-'}%</span>
                </div>
                <div class="insight-desc">
                    Learning Rate: ${(tuning.learning_rate || 0.1).toFixed(2)}<br>
                    Samples: ${tuning.samples_collected || 0}
                </div>
            </div>`;

            const pred = insights.prediction_accuracy || {};
            html += `<div class="insight-card">
                <div class="insight-header">
                    <span class="insight-title">üîÆ Prediction Accuracy</span>
                    <span class="insight-value" style="color:var(--accent-cyan)">${((pred.accuracy || 0) * 100).toFixed(0)}%</span>
                </div>
                <div class="insight-desc">
                    MAE: ${(pred.mae || 0).toFixed(3)} | Validated: ${pred.validated_count || 0}<br>
                    Total Predictions: ${pred.total_predictions || 0}
                </div>
            </div>`;

            const patterns = insights.patterns || {};
            html += `<div class="insight-card">
                <div class="insight-header">
                    <span class="insight-title">üìà Learned Patterns</span>
                </div>
                <div class="insight-desc">
                    Peak Hours: ${patterns.peak_hours?.join(', ') || 'Learning...'}<br>
                    Low Hours: ${patterns.low_hours?.join(', ') || 'Learning...'}
                </div>
            </div>`;

            html += '</div>';

            if (insights.scaling_events?.length > 0) {
                html += '<div style="margin-top:16px"><strong>Recent Scaling Events</strong></div>';
                html += '<div style="margin-top:8px">';
                for (const evt of insights.scaling_events.slice(0, 5)) {
                    const icon = evt.action === 'scale_up' ? '‚Üë' : evt.action === 'scale_down' ? '‚Üì' : '‚Üî';
                    const iconClass = evt.action === 'scale_up' ? 'up' : evt.action === 'scale_down' ? 'down' : '';
                    const nsInfo = evt.namespace ? `${evt.namespace}/` : '';
                    const depName = evt.deployment || '';
                    const eventId = `${evt.namespace}-${evt.deployment}-${evt.timestamp}`.replace(/[^a-zA-Z0-9-]/g, '-');
                    
                    html += `<div class="timeline-event" style="cursor:pointer" onclick="showEventDetails('${evt.namespace}', '${evt.deployment}', '${evt.timestamp}', '${evt.action}', ${evt.pod_count}, ${evt.hpa_target})">
                        <div class="timeline-icon ${iconClass}">${icon}</div>
                        <div class="timeline-content">
                            <div><strong>${evt.action.replace('_', ' ')}</strong> ‚Üí ${evt.pod_count} pods (HPA: ${evt.hpa_target}%)</div>
                            <div class="timeline-time">
                                <span style="color:var(--accent-cyan)">${nsInfo}${depName}</span> ¬∑ 
                                ${new Date(evt.timestamp).toLocaleString()}
                            </div>
                        </div>
                    </div>`;
                }
                html += '</div>';
            }

            container.innerHTML = html;
            updateEfficiencyGauge(eff.cpu_efficiency || 0);
        }

        async function loadTimeline(ns, dep, force) {
            const data = await fetchAPI(`/api/scaling/timeline/${dep}`, force);
            const container = document.getElementById('timeline-content');
            
            if (!data || !data.events?.length) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìà</div>No scaling events yet</div>';
                return;
            }

            const nsInfo = data.namespace ? `${data.namespace}/` : '';
            let html = `<div style="margin-bottom:12px;color:var(--text-secondary);font-size:12px">${nsInfo}${data.deployment} ¬∑ Total events: ${data.total_events}</div>`;
            
            for (const evt of data.events.slice(0, 20)) {
                let icon, iconClass, title, desc;
                
                if (evt.type === 'scale_up') {
                    icon = '‚Üë'; iconClass = 'up';
                    title = `Scale Up: ${evt.from_pods} ‚Üí ${evt.to_pods} pods`;
                    desc = `CPU: ${evt.cpu_usage}% | Confidence: ${((evt.confidence || 0) * 100).toFixed(0)}%`;
                } else if (evt.type === 'scale_down') {
                    icon = '‚Üì'; iconClass = 'down';
                    title = `Scale Down: ${evt.from_pods} ‚Üí ${evt.to_pods} pods`;
                    desc = `CPU: ${evt.cpu_usage}% | Confidence: ${((evt.confidence || 0) * 100).toFixed(0)}%`;
                } else {
                    icon = '‚öô'; iconClass = 'change';
                    title = `HPA Target: ${evt.from_target}% ‚Üí ${evt.to_target}%`;
                    desc = `Reason: ${evt.reason}`;
                }

                html += `<div class="timeline-event">
                    <div class="timeline-icon ${iconClass}">${icon}</div>
                    <div class="timeline-content">
                        <div><strong>${title}</strong></div>
                        <div style="font-size:11px;color:var(--text-secondary)">${desc}</div>
                        <div class="timeline-time">${new Date(evt.timestamp).toLocaleString()}</div>
                    </div>
                </div>`;
            }

            container.innerHTML = html;
        }

        async function loadPredictions(ns, dep, force) {
            const data = await fetchAPI(`/api/deployment/${ns}/${dep}/predictions`, force);
            const container = document.getElementById('predictions-content');
            
            if (!data?.predictions?.length) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîÆ</div>No predictions yet</div>';
                return;
            }

            if (data.accuracy_stats) {
                const acc = data.accuracy_stats;
                document.getElementById('prediction-stats').textContent = 
                    `Accuracy: ${((acc.accuracy || 0) * 100).toFixed(0)}% | MAE: ${(acc.mae || 0).toFixed(3)}`;
            }

            let html = '';
            for (const pred of data.predictions.slice(0, 10)) {
                const conf = (pred.confidence || 0) * 100;
                const confColor = conf > 70 ? 'var(--accent-green)' : conf > 40 ? 'var(--accent-yellow)' : 'var(--accent-red)';
                
                html += `<div class="insight-card">
                    <div class="insight-header">
                        <span class="insight-title">${pred.action || 'maintain'}</span>
                        <span style="color:${confColor};font-size:12px">${conf.toFixed(0)}% conf</span>
                    </div>
                    <div class="insight-desc">${pred.reasoning || 'No reasoning'}</div>
                    ${pred.validated ? `<div style="margin-top:4px;font-size:10px;color:var(--accent-green)">‚úì Validated | Actual: ${(pred.actual_cpu || 0).toFixed(2)}</div>` : ''}
                    <div class="timeline-time">${new Date(pred.timestamp).toLocaleString()}</div>
                </div>`;
            }
            container.innerHTML = html;
        }

        async function loadCPUHistory(ns, dep, force) {
            // CPU chart removed from sidebar - function kept for compatibility
            return;
        }

        function updateEfficiencyGauge(value) {
            // Efficiency gauge removed from sidebar - function kept for compatibility
            return;
        }

        async function loadHealth(force) {
            const health = await fetchAPI('/api/health', force) || {};
            document.getElementById('prom-status').className = 'status-dot ' + (health.prometheus === 'healthy' ? 'healthy' : 'error');
            document.getElementById('k8s-status').className = 'status-dot ' + (health.kubernetes === 'healthy' ? 'healthy' : 'error');
            document.getElementById('db-status').className = 'status-dot ' + (health.database === 'healthy' ? 'healthy' : 'error');
            
            // Load autopilot status
            await loadAutopilotStatus(force);
        }
        
        async function loadAutopilotStatus(force) {
            try {
                const autopilot = await fetchAPI('/api/autopilot/status', force);
                if (!autopilot) {
                    document.getElementById('autopilot-status').style.background = 'var(--text-disabled)';
                    document.getElementById('autopilot-label').textContent = 'Autopilot: N/A';
                    return;
                }
                
                const statusDot = document.getElementById('autopilot-status');
                const statusLabel = document.getElementById('autopilot-label');
                const indicator = document.getElementById('autopilot-indicator');
                
                if (!autopilot.enabled) {
                    statusDot.style.background = 'var(--text-disabled)';
                    statusDot.className = 'status-dot';
                    statusLabel.textContent = 'Autopilot: OFF';
                    indicator.title = 'Autopilot Mode is disabled';
                } else {
                    const level = autopilot.level || 'RECOMMEND';
                    const stats = autopilot.statistics || {};
                    
                    if (level === 'AUTOPILOT') {
                        statusDot.className = 'status-dot healthy';
                        statusDot.style.background = '';
                        statusLabel.textContent = 'Autopilot: AUTO';
                        indicator.title = `Autopilot Mode: AUTO-APPLY\nRecommendations: ${stats.total_recommendations || 0}\nActions: ${stats.total_actions || 0}`;
                    } else if (level === 'RECOMMEND') {
                        statusDot.className = 'status-dot warning';
                        statusDot.style.background = '';
                        statusLabel.textContent = 'Autopilot: REC';
                        indicator.title = `Autopilot Mode: RECOMMEND\nPending: ${stats.pending_recommendations || 0}\nRecommendations: ${stats.total_recommendations || 0}`;
                    } else if (level === 'OBSERVE') {
                        statusDot.style.background = 'var(--accent-cyan)';
                        statusDot.className = 'status-dot';
                        statusLabel.textContent = 'Autopilot: OBS';
                        indicator.title = 'Autopilot Mode: OBSERVE ONLY';
                    } else {
                        statusDot.style.background = 'var(--text-disabled)';
                        statusDot.className = 'status-dot';
                        statusLabel.textContent = 'Autopilot: OFF';
                        indicator.title = 'Autopilot Mode is disabled';
                    }
                }
            } catch (e) {
                console.log('Autopilot status not available:', e);
                document.getElementById('autopilot-status').style.background = 'var(--text-disabled)';
                document.getElementById('autopilot-label').textContent = 'Autopilot: N/A';
            }
        }

        async function loadAutopilotData(force) {
            try {
                const [status, recommendations, actions] = await Promise.all([
                    fetchAPI('/api/autopilot/status', force),
                    fetchAPI('/api/autopilot/recommendations', force),
                    fetchAPI('/api/autopilot/actions', force)
                ]);
                
                if (!status) return;
                
                // Update status cards
                const modeStatus = document.getElementById('autopilot-mode-status');
                const modeLevel = document.getElementById('autopilot-mode-level');
                if (status.enabled) {
                    modeStatus.textContent = 'ENABLED';
                    modeStatus.style.color = 'var(--accent-green)';
                    modeLevel.textContent = `Level: ${status.level}`;
                } else {
                    modeStatus.textContent = 'DISABLED';
                    modeStatus.style.color = 'var(--text-disabled)';
                    modeLevel.textContent = 'Not active';
                }
                
                const stats = status.statistics || {};
                document.getElementById('autopilot-rec-count').textContent = stats.total_recommendations || 0;
                document.getElementById('autopilot-pending').textContent = `${stats.pending_recommendations || 0} pending`;
                document.getElementById('autopilot-action-count').textContent = stats.total_actions || 0;
                document.getElementById('autopilot-rollbacks').textContent = `${stats.rollbacks || 0} rollbacks`;
                
                // Update config
                const config = status.config || {};
                document.getElementById('ap-min-obs').textContent = `${config.min_observation_days || 7} days`;
                document.getElementById('ap-min-conf').textContent = `${((config.min_confidence || 0.8) * 100).toFixed(0)}%`;
                document.getElementById('ap-max-change').textContent = `${config.max_change_percent || 30}%`;
                document.getElementById('ap-cooldown').textContent = `${config.cooldown_hours || 24}h`;
                
                // Update recommendations table
                const recBody = document.getElementById('autopilot-recommendations');
                if (recommendations && recommendations.length > 0) {
                    recBody.innerHTML = recommendations.map(r => `
                        <tr>
                            <td><strong>${r.namespace}/${r.deployment}</strong></td>
                            <td>${r.current_cpu_request}m</td>
                            <td style="color: ${r.recommended_cpu_request < r.current_cpu_request ? 'var(--accent-green)' : 'var(--accent-yellow)'}">${r.recommended_cpu_request}m</td>
                            <td>${r.current_memory_request}Mi</td>
                            <td style="color: ${r.recommended_memory_request < r.current_memory_request ? 'var(--accent-green)' : 'var(--accent-yellow)'}">${r.recommended_memory_request}Mi</td>
                            <td><span class="badge ${r.confidence >= 0.8 ? 'healthy' : 'warning'}">${(r.confidence * 100).toFixed(0)}%</span></td>
                            <td style="color: var(--accent-green)">${r.savings_percent > 0 ? '+' : ''}${r.savings_percent.toFixed(1)}%</td>
                            <td><span class="badge ${r.is_safe ? 'healthy' : 'warning'}">${r.is_safe ? 'Safe' : r.safety_reason}</span></td>
                            <td>
                                ${r.applied_at ? '<span class="badge info">Applied</span>' : 
                                  r.is_safe ? `<button class="btn btn-primary" onclick="applyAutopilotRec('${r.namespace}', '${r.deployment}')">Apply</button>` : 
                                  '<span class="badge unknown">Blocked</span>'}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    recBody.innerHTML = '<tr><td colspan="9" class="empty-state">No recommendations yet. Need at least 7 days of observation data.</td></tr>';
                }
                
                // Update actions table
                const actBody = document.getElementById('autopilot-actions');
                if (actions && actions.length > 0) {
                    actBody.innerHTML = actions.map(a => {
                        const time = new Date(a.applied_at).toLocaleString();
                        const isRollback = a.action_type === 'rollback';
                        const unit = a.action_type.includes('memory') ? 'Mi' : 'm';
                        return `
                            <tr>
                                <td>${time}</td>
                                <td>${a.namespace}/${a.deployment}</td>
                                <td><span class="badge ${isRollback ? 'warning' : 'info'}">${a.action_type}</span></td>
                                <td>${a.old_value}${unit} ‚Üí ${a.new_value}${unit}</td>
                                <td>${a.reason}</td>
                                <td>${a.rolled_back ? '<span class="badge warning">Rolled Back</span>' : '<span class="badge healthy">Active</span>'}</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    actBody.innerHTML = '<tr><td colspan="6" class="empty-state">No actions yet</td></tr>';
                }
                
                // Update cooldowns
                const cooldowns = status.deployments_in_cooldown || [];
                const cooldownDiv = document.getElementById('autopilot-cooldowns');
                if (cooldowns.length > 0) {
                    cooldownDiv.innerHTML = `
                        <div class="alert alert-info">
                            <strong>‚è≥ Deployments in Cooldown:</strong><br>
                            ${cooldowns.map(c => `${c.key}: ${c.hours_remaining.toFixed(1)}h remaining`).join('<br>')}
                        </div>
                    `;
                } else {
                    cooldownDiv.innerHTML = '';
                }
                
            } catch (e) {
                console.error('Failed to load autopilot data:', e);
            }
        }
        
        async function applyAutopilotRec(namespace, deployment) {
            if (!confirm(`Apply autopilot recommendation to ${namespace}/${deployment}?`)) return;
            
            try {
                const response = await fetch(`/api/autopilot/${namespace}/${deployment}/apply`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Recommendation applied successfully!');
                    loadAutopilotData(true);
                } else {
                    alert('‚ùå Failed to apply: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }
        
        async function rollbackAutopilot(namespace, deployment) {
            const reason = prompt(`Rollback ${namespace}/${deployment}? Enter reason:`);
            if (!reason) return;
            
            try {
                const response = await fetch(`/api/autopilot/${namespace}/${deployment}/rollback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Rollback successful!');
                    loadAutopilotData(true);
                } else {
                    alert('‚ùå Failed to rollback: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        async function loadConfig(force) {
            const config = await fetchAPI('/api/config/status', force);
            if (!config) return;
            
            // Update version in header
            const version = config.current_config?.version || '0.0.18';
            document.getElementById('version').textContent = 'v' + version;
            
            const c = config.current_config || {};
            document.getElementById('config-content').innerHTML = `
                <div class="metric-row"><span class="metric-label">App Version</span><span class="metric-value" style="color:var(--accent-cyan)">v${version}</span></div>
                <div class="metric-row"><span class="metric-label">Config Version</span><span class="metric-value">${config.config_version || '-'}</span></div>
                <div class="metric-row"><span class="metric-label">Check Interval</span><span class="metric-value">${c.check_interval || 30}s</span></div>
                <div class="metric-row"><span class="metric-label">Target Utilization</span><span class="metric-value">${c.target_node_utilization || 30}%</span></div>
                <div class="metric-row"><span class="metric-label">Dry Run</span><span class="badge ${c.dry_run ? 'warning' : 'healthy'}">${c.dry_run ? 'Yes' : 'No'}</span></div>
                <div class="metric-row"><span class="metric-label">Predictive</span><span class="badge ${c.enable_predictive ? 'healthy' : 'warning'}">${c.enable_predictive ? 'On' : 'Off'}</span></div>
                <div class="metric-row"><span class="metric-label">Auto-tuning</span><span class="badge ${c.enable_autotuning ? 'healthy' : 'warning'}">${c.enable_autotuning ? 'On' : 'Off'}</span></div>
            `;
        }

        async function reloadConfig() {
            const res = await fetch('/api/config/reload', { method: 'POST' });
            const data = await res.json();
            alert(data.success ? 'Config reloaded!' : 'Failed: ' + data.error);
            loadConfig(true);
        }

        // ============================================
        // Cost & Reports Functions (Real-time Prometheus-based)
        // ============================================
        

        // Store workload data for sorting
        let costReportData = [];
        let costReportSortColumn = 'cost_monthly';
        let costReportSortAsc = false;
        
        async function loadCostReports() {
            const tableEl = document.getElementById('realtime-costs-table');
            tableEl.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner-icon">‚ü≥</div>
                    <div>Loading real-time costs from Prometheus...</div>
                </div>
            `;
            
            try {
                // Load real-time costs
                const data = await fetchAPI('/api/cost/realtime', true);
                
                if (!data || data.error) {
                    tableEl.innerHTML = `<div class="alert alert-error">Error: ${data?.error || 'Failed to load costs'}</div>`;
                    return;
                }
                
                // Store data for sorting
                costReportData = data.workloads || [];
                
                // Update summary cards
                document.getElementById('rt-hourly-cost').textContent = '$' + data.summary.total_hourly_cost.toFixed(4);
                document.getElementById('rt-daily-cost').textContent = '$' + data.summary.total_daily_cost.toFixed(2);
                document.getElementById('rt-monthly-cost').textContent = '$' + data.summary.total_monthly_cost.toFixed(2);
                document.getElementById('rt-monthly-waste').textContent = '$' + data.summary.total_monthly_waste.toFixed(2);
                document.getElementById('rt-waste-percent').textContent = data.summary.waste_percentage + '%';
                
                // Load cluster summary
                const cluster = await fetchAPI('/api/cost/realtime/cluster', true);
                if (cluster && !cluster.error) {
                    document.getElementById('cs-nodes').textContent = cluster.cluster.total_nodes;
                    document.getElementById('cs-vcpu').textContent = cluster.cluster.total_vcpu;
                    document.getElementById('cs-memory').textContent = cluster.cluster.total_memory_gb.toFixed(1) + ' GB';
                    document.getElementById('cs-cpu-req').textContent = cluster.cluster.total_cpu_requests.toFixed(2);
                    document.getElementById('cs-cpu-util').textContent = cluster.cluster.cpu_utilization_percent + '%';
                    document.getElementById('cs-mem-util').textContent = cluster.cluster.memory_utilization_percent + '%';
                }
                
                // Render table
                renderCostReportTable(data.summary, data.timestamp);
                
            } catch (e) {
                tableEl.innerHTML = `<div class="alert alert-error">Error: ${e.message}</div>`;
            }
            
            // Load alerting config
            loadAlertingConfig();
            
            // Load cluster cost history
            loadClusterCostHistory();
        }
        
        function sortCostReport(column) {
            if (costReportSortColumn === column) {
                costReportSortAsc = !costReportSortAsc;
            } else {
                costReportSortColumn = column;
                costReportSortAsc = false;
            }
            renderCostReportTable();
        }
        
        function renderCostReportTable(summary, timestamp) {
            const tableEl = document.getElementById('realtime-costs-table');
            
            if (!costReportData || costReportData.length === 0) {
                tableEl.innerHTML = '<div class="empty-state">No workload data available</div>';
                return;
            }
            
            // Sort data
            const sortedData = [...costReportData].sort((a, b) => {
                let aVal = a[costReportSortColumn] || 0;
                let bVal = b[costReportSortColumn] || 0;
                if (typeof aVal === 'string') {
                    return costReportSortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                return costReportSortAsc ? aVal - bVal : bVal - aVal;
            });
            
            // Get optimal targets
            const targets = summary?.optimal_targets || {cpu_percent: 25, memory_percent: 65};
            
            // Build sortable header
            const sortIcon = (col) => costReportSortColumn === col ? (costReportSortAsc ? ' ‚ñ≤' : ' ‚ñº') : '';
            const thStyle = 'padding: 6px 4px; border-bottom: 1px solid #30363d; cursor: pointer; white-space: nowrap; font-size: 11px;';
            
            let html = `
                <div style="margin-bottom: 8px; padding: 6px 8px; background: #1c1f26; border-radius: 4px; font-size: 10px; color: #8b949e;">
                    <strong>Optimal Targets:</strong> CPU ‚â•${targets.cpu_percent}% | Memory ‚â•${targets.memory_percent}% 
                    <span style="color: #3fb950;">‚óè = optimal (no waste)</span>
                    <span style="margin-left: 12px;">Click column headers to sort</span>
                </div>
                <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 11px; min-width: 900px;">
                    <thead>
                        <tr style="background: #1c1f26; text-align: left;">
                            <th style="${thStyle}" onclick="sortCostReport('workload_name')">Workload${sortIcon('workload_name')}</th>
                            <th style="${thStyle}" onclick="sortCostReport('workload_kind')">Type${sortIcon('workload_kind')}</th>
                            <th style="${thStyle}" onclick="sortCostReport('pod_count')">Pods${sortIcon('pod_count')}</th>
                            <th style="${thStyle}" onclick="sortCostReport('cpu_request')">CPU Req${sortIcon('cpu_request')}</th>
                            <th style="${thStyle}" onclick="sortCostReport('cpu_usage')">CPU Use${sortIcon('cpu_usage')}</th>
                            <th style="${thStyle}" onclick="sortCostReport('cpu_utilization_percent')">CPU %${sortIcon('cpu_utilization_percent')}</th>
                            <th style="${thStyle}" onclick="sortCostReport('memory_request_gb')">Mem Req${sortIcon('memory_request_gb')}</th>
                            <th style="${thStyle}" onclick="sortCostReport('memory_usage_gb')">Mem Use${sortIcon('memory_usage_gb')}</th>
                            <th style="${thStyle}" onclick="sortCostReport('memory_utilization_percent')">Mem %${sortIcon('memory_utilization_percent')}</th>
                            <th style="${thStyle}" onclick="sortCostReport('cost_monthly')">Cost/Mo${sortIcon('cost_monthly')}</th>
                            <th style="${thStyle}" onclick="sortCostReport('waste_monthly')">Waste/Mo${sortIcon('waste_monthly')}</th>
                            <th style="${thStyle}">Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const w of sortedData.slice(0, 100)) {
                const cpuColor = (w.cpu_status === 'optimal' || w.cpu_utilization_percent >= 25) ? '#3fb950' : (w.cpu_utilization_percent < 10 ? '#f85149' : '#d29922');
                const memColor = (w.memory_status === 'optimal' || w.memory_utilization_percent >= 65) ? '#3fb950' : (w.memory_utilization_percent < 30 ? '#f85149' : '#d29922');
                const isOptimal = w.is_optimal || (w.cpu_utilization_percent >= 25 || w.memory_utilization_percent >= 65);
                const statusBadge = isOptimal
                    ? '<span style="background: #238636; color: white; padding: 1px 4px; border-radius: 3px; font-size: 9px;">OK</span>'
                    : '<span style="background: #9e6a03; color: white; padding: 1px 4px; border-radius: 3px; font-size: 9px;">LOW</span>';
                const typeIcon = w.workload_kind === 'Deployment' ? 'üöÄ' : (w.workload_kind === 'StatefulSet' ? 'üì¶' : (w.workload_kind === 'DaemonSet' ? 'üîÑ' : '‚ùì'));
                const wasteColor = w.waste_monthly > 0 ? '#f85149' : '#3fb950';
                const workloadName = w.workload_name || w.pod?.substring(0, 25) || 'unknown';
                
                html += `
                    <tr style="border-bottom: 1px solid #21262d;">
                        <td style="padding: 4px;">${w.namespace}/<strong>${workloadName}</strong></td>
                        <td style="padding: 4px;">${typeIcon} ${w.workload_kind || 'Pod'}</td>
                        <td style="padding: 4px; text-align: center;">${w.pod_count || 1}</td>
                        <td style="padding: 4px;">${(w.cpu_request || 0).toFixed(3)}</td>
                        <td style="padding: 4px;">${(w.cpu_usage || 0).toFixed(3)}</td>
                        <td style="padding: 4px; color: ${cpuColor};">${w.cpu_utilization_percent || 0}%</td>
                        <td style="padding: 4px;">${((w.memory_request_gb || 0) * 1024).toFixed(0)}Mi</td>
                        <td style="padding: 4px;">${((w.memory_usage_gb || 0) * 1024).toFixed(0)}Mi</td>
                        <td style="padding: 4px; color: ${memColor};">${w.memory_utilization_percent || 0}%</td>
                        <td style="padding: 4px;">$${(w.cost_monthly || 0).toFixed(2)}</td>
                        <td style="padding: 4px; color: ${wasteColor};">$${(w.waste_monthly || 0).toFixed(2)}</td>
                        <td style="padding: 4px;">${statusBadge}</td>
                    </tr>
                `;
            }
            
            html += '</tbody></table></div>';
            
            const optimalCount = sortedData.filter(w => w.is_optimal || (w.cpu_utilization_percent >= 25 || w.memory_utilization_percent >= 65)).length;
            const ts = timestamp || new Date().toISOString();
            html += `<div style="margin-top: 8px; font-size: 10px; color: #8b949e;">
                Updated: ${ts.substring(0, 19)} | ${optimalCount}/${sortedData.length} optimal | 
                <a href="#" onclick="document.querySelector('[data-tab=finops]').click(); return false;" style="color: var(--accent-cyan);">FinOps ‚Üí</a>
            </div>`;
            tableEl.innerHTML = html;
        }
        
        let clusterCostHistoryChart = null;
        
        async function loadClusterCostHistory() {
            try {
                const res = await fetch('/api/finops/cost-trends?days=30');
                const data = await res.json();
                
                if (data.error || !data.daily_summary) {
                    document.getElementById('cluster-cost-history-summary').textContent = 'No historical data';
                    return;
                }
                
                const summary = data.summary || {};
                const dailyData = data.daily_summary || [];
                
                // Update summary stats
                document.getElementById('cch-total').textContent = '$' + (summary.total_cost || 0).toFixed(2);
                document.getElementById('cch-waste').textContent = '$' + (summary.total_wasted || 0).toFixed(2);
                document.getElementById('cch-avg-daily').textContent = '$' + (dailyData.length > 0 ? (summary.total_cost / dailyData.length).toFixed(2) : '0.00');
                document.getElementById('cch-efficiency').textContent = (summary.efficiency || 0).toFixed(1) + '%';
                
                document.getElementById('cluster-cost-history-summary').textContent = 
                    `${dailyData.length} days | Monthly projection: $${summary.monthly_projection || 0}`;
                
                // Draw chart
                const ctx = document.getElementById('cluster-cost-history-chart');
                if (!ctx) return;
                
                if (clusterCostHistoryChart) {
                    clusterCostHistoryChart.destroy();
                }
                
                clusterCostHistoryChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dailyData.map(d => d.date.substring(5)), // MM-DD format
                        datasets: [
                            {
                                label: 'Total Cost',
                                data: dailyData.map(d => d.cost),
                                borderColor: '#3d71d9',
                                backgroundColor: 'rgba(61, 113, 217, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Actual Usage',
                                data: dailyData.map(d => d.actual),
                                borderColor: '#73bf69',
                                backgroundColor: 'rgba(115, 191, 105, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Waste',
                                data: dailyData.map(d => d.wasted),
                                borderColor: '#f2495c',
                                backgroundColor: 'rgba(242, 73, 92, 0.1)',
                                fill: true,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { boxWidth: 12, padding: 8, font: { size: 10 } }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': $' + context.raw.toFixed(2);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: '#2c3039' },
                                ticks: { font: { size: 9 }, maxRotation: 45 }
                            },
                            y: {
                                grid: { color: '#2c3039' },
                                ticks: {
                                    font: { size: 10 },
                                    callback: function(value) { return '$' + value; }
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Failed to load cluster cost history:', e);
                document.getElementById('cluster-cost-history-summary').textContent = 'Error loading data';
            }
        }
        
        async function loadAlertingConfig() {
            try {
                const data = await fetchAPI('/api/cost/alerting/config', true);
                if (data && !data.error) {
                    document.getElementById('alert-enabled').checked = data.enabled;
                    document.getElementById('alert-config').style.display = data.enabled ? 'block' : 'none';
                    document.getElementById('alert-time').value = data.alert_time || '09:00';
                    
                    const status = data.scheduler_running ? '‚úÖ Scheduler running' : '‚è∏Ô∏è Scheduler stopped';
                    const lastAlert = data.last_alert_date ? `Last: ${data.last_alert_date}` : 'No alerts sent yet';
                    document.getElementById('alert-status').innerHTML = `${status}<br><small>${lastAlert}</small>`;
                }
            } catch (e) {
                console.error('Failed to load alerting config:', e);
            }
        }
        
        function toggleAlertEnabled() {
            const enabled = document.getElementById('alert-enabled').checked;
            document.getElementById('alert-config').style.display = enabled ? 'block' : 'none';
        }
        
        async function saveAlertConfig() {
            const config = {
                enabled: document.getElementById('alert-enabled').checked,
                alert_time: document.getElementById('alert-time').value,
                slack_webhook_url: document.getElementById('slack-webhook').value,
                webhook_url: document.getElementById('generic-webhook').value
            };
            
            try {
                const res = await fetch('/api/cost/alerting/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('‚úÖ Alert configuration saved!');
                    loadAlertingConfig();
                } else {
                    alert('‚ùå Failed to save: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }
        
        async function testAlert() {
            try {
                const res = await fetch('/api/cost/alerting/test', { method: 'POST' });
                const data = await res.json();
                
                let msg = 'üß™ Test Alert Results:\n';
                msg += data.slack_sent ? '‚úÖ Slack: Sent\n' : '‚ùå Slack: Not sent\n';
                msg += data.webhook_sent ? '‚úÖ Webhook: Sent\n' : '‚ùå Webhook: Not sent\n';
                
                if (!data.slack_sent && !data.webhook_sent) {
                    msg += '\n‚ö†Ô∏è Configure webhook URLs above first!';
                }
                
                alert(msg);
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }
        
        async function sendReportNow() {
            if (!confirm('Send daily cost report now?')) return;
            
            try {
                const res = await fetch('/api/cost/alerting/send-now', { method: 'POST' });
                const data = await res.json();
                
                let msg = 'üì§ Report Send Results:\n';
                msg += data.report_generated ? '‚úÖ Report generated\n' : '‚ùå Report failed\n';
                msg += data.slack_sent ? '‚úÖ Slack: Sent\n' : '‚ùå Slack: Not sent\n';
                msg += data.webhook_sent ? '‚úÖ Webhook: Sent\n' : '‚ùå Webhook: Not sent\n';
                
                if (data.report) {
                    msg += `\nüìä Summary:\n`;
                    msg += `Daily Cost: $${data.report.costs.daily}\n`;
                    msg += `Monthly Cost: $${data.report.costs.monthly}\n`;
                    msg += `Monthly Waste: $${data.report.waste.monthly}`;
                }
                
                alert(msg);
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        function refreshData() { state.countdown = 30; loadData(true); }
        
        // Cluster monitoring
        let clusterCpuChart = null;
        let clusterMemChart = null;
        
        async function loadClusterMetrics() {
            try {
                const res = await fetch('/api/cluster/metrics');
                if (!res.ok) return;
                const data = await res.json();
                if (data.error) return;
                
                const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
                
                setEl('cluster-node-count', data.node_count || 0);
                setEl('cluster-pod-count', data.pod_count || '-');

                // Kubernetes Version Display
                if (data.kubernetes_version) {
                    const k8s = data.kubernetes_version;
                    setEl('k8s-version', k8s.git_version || k8s.version || 'Unknown');
                    setEl('k8s-platform', k8s.platform || (k8s.detected ? 'Platform unknown' : 'Not detected'));
                }

                // Cloud Provider Display
                if (data.cloud_provider) {
                    const cp = data.cloud_provider;
                    setEl('cloud-provider-name', cp.provider || 'Unknown');
                    setEl('cloud-provider-region', cp.region_name !== 'N/A' ? cp.region_name : (cp.detected ? 'Region unknown' : 'Not detected'));
                    
                    const badge = document.getElementById('cloud-provider-badge');
                    if (badge) {
                        badge.textContent = cp.display || 'Unknown';
                        // Color based on provider
                        if (cp.provider === 'GCP') {
                            badge.style.background = 'rgba(66, 133, 244, 0.2)';
                            badge.style.color = '#4285f4';
                        } else if (cp.provider === 'AWS') {
                            badge.style.background = 'rgba(255, 153, 0, 0.2)';
                            badge.style.color = '#ff9900';
                        } else if (cp.provider === 'Azure') {
                            badge.style.background = 'rgba(0, 120, 212, 0.2)';
                            badge.style.color = '#0078d4';
                        } else if (cp.provider === 'Local') {
                            badge.style.background = 'rgba(115, 191, 105, 0.2)';
                            badge.style.color = 'var(--accent-green)';
                        } else {
                            badge.style.background = 'rgba(142, 142, 142, 0.2)';
                            badge.style.color = 'var(--text-secondary)';
                        }
                    }
                }
                
                const cpuHealth = data.summary?.cpu?.usage_percent || 0;
                const memHealth = data.summary?.memory?.usage_percent || 0;
                const overallHealth = Math.max(cpuHealth, memHealth);
                const healthStatus = overallHealth > 85 ? 'Critical' : overallHealth > 70 ? 'Warning' : 'Healthy';
                const healthColor = overallHealth > 85 ? 'var(--accent-red)' : overallHealth > 70 ? 'var(--accent-yellow)' : 'var(--accent-green)';
                
                const healthEl = document.getElementById('cluster-health');
                if (healthEl) { healthEl.textContent = healthStatus; healthEl.style.color = healthColor; }
                
                if (data.summary?.cpu) {
                    setEl('cpu-capacity', (data.summary.cpu.capacity || 0).toFixed(1) + ' cores');
                    setEl('cpu-allocatable', (data.summary.cpu.allocatable || 0).toFixed(1) + ' cores');
                    setEl('cpu-requests', (data.summary.cpu.requests || 0).toFixed(1) + ' cores');
                    setEl('cpu-requests-pct', (data.summary.cpu.requests_percent || 0).toFixed(1) + '% of allocatable');
                    setEl('cpu-usage', (data.summary.cpu.usage || 0).toFixed(1) + ' cores');
                    setEl('cpu-usage-pct', (data.summary.cpu.usage_percent || 0).toFixed(1) + '% of allocatable');
                    
                    const cpuPct = data.summary.cpu.usage_percent || 0;
                    const cpuBar = document.getElementById('cpu-usage-bar');
                    if (cpuBar) {
                        cpuBar.style.width = Math.min(cpuPct, 100) + '%';
                        cpuBar.style.background = cpuPct > 85 ? 'var(--accent-red)' : cpuPct > 70 ? 'var(--accent-yellow)' : 'var(--accent-green)';
                    }
                }
                
                if (data.summary?.memory) {
                    setEl('mem-capacity', (data.summary.memory.capacity_gb || 0).toFixed(1) + ' GB');
                    setEl('mem-allocatable', (data.summary.memory.allocatable_gb || 0).toFixed(1) + ' GB');
                    setEl('mem-requests', (data.summary.memory.requests_gb || 0).toFixed(1) + ' GB');
                    setEl('mem-requests-pct', (data.summary.memory.requests_percent || 0).toFixed(1) + '% of allocatable');
                    setEl('mem-usage', (data.summary.memory.usage_gb || 0).toFixed(1) + ' GB');
                    setEl('mem-usage-pct', (data.summary.memory.usage_percent || 0).toFixed(1) + '% of allocatable');
                    
                    const memPct = data.summary.memory.usage_percent || 0;
                    const memBar = document.getElementById('mem-usage-bar');
                    if (memBar) {
                        memBar.style.width = Math.min(memPct, 100) + '%';
                        memBar.style.background = memPct > 85 ? 'var(--accent-red)' : memPct > 70 ? 'var(--accent-yellow)' : 'var(--accent-purple)';
                    }
                }
                
                let nodesHtml = '';
                for (const node of data.nodes) {
                    const cpuPct = (node.cpu_usage / node.cpu_allocatable * 100).toFixed(1);
                    const memPct = (node.memory_usage_gb / node.memory_allocatable_gb * 100).toFixed(1);
                    const nodeStatus = Math.max(parseFloat(cpuPct), parseFloat(memPct)) > 85 ? 'critical' : 
                                      Math.max(parseFloat(cpuPct), parseFloat(memPct)) > 70 ? 'warning' : 'healthy';
                    
                    nodesHtml += `<tr>
                        <td><strong>${node.name}</strong></td>
                        <td>${node.cpu_allocatable} cores</td>
                        <td>${node.cpu_usage.toFixed(2)} cores</td>
                        <td>${cpuPct}%<div class="progress-bar"><div class="progress-fill ${nodeStatus}" style="width:${Math.min(cpuPct, 100)}%"></div></div></td>
                        <td>${node.memory_allocatable_gb.toFixed(1)} GB</td>
                        <td>${node.memory_usage_gb.toFixed(1)} GB</td>
                        <td>${memPct}%<div class="progress-bar"><div class="progress-fill ${nodeStatus}" style="width:${Math.min(memPct, 100)}%"></div></div></td>
                        <td><span class="badge ${nodeStatus}">${nodeStatus}</span></td>
                    </tr>`;
                }
                document.getElementById('nodes-body').innerHTML = nodesHtml || '<tr><td colspan="8" class="empty-state">No nodes found</td></tr>';
                
                loadClusterHistory();
            } catch (err) { console.error('Error loading cluster metrics:', err); }
        }
        
        async function loadClusterHistory() {
            try {
                const res = await fetch('/api/cluster/history?hours=24');
                const data = await res.json();
                
                if (data.error || !data.history || data.history.length === 0) return;
                
                const timestamps = data.history.map(h => h.timestamp);
                const cpuRequests = data.history.map(h => h.total_cpu_request_millicores / 1000);
                const cpuUsage = data.history.map(h => h.total_cpu_usage_millicores / 1000);
                const memRequests = data.history.map(h => h.total_memory_request_mb / 1024);
                const memUsage = data.history.map(h => h.total_memory_usage_mb / 1024);
                
                const cpuCtx = document.getElementById('cluster-cpu-history-chart');
                if (cpuCtx) {
                    if (clusterCpuChart) clusterCpuChart.destroy();
                    clusterCpuChart = new Chart(cpuCtx, {
                        type: 'line',
                        data: {
                            labels: timestamps,
                            datasets: [
                                { label: 'Requests', data: cpuRequests, borderColor: '#fade2a', backgroundColor: 'rgba(250,222,42,0.1)', tension: 0.4, fill: true, pointRadius: 0, borderWidth: 2 },
                                { label: 'Usage', data: cpuUsage, borderColor: '#73bf69', backgroundColor: 'rgba(115,191,105,0.1)', tension: 0.4, fill: true, pointRadius: 0, borderWidth: 2 }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top', labels: { boxWidth: 12, font: { size: 10 } } } }, scales: { y: { beginAtZero: true }, x: { display: false } } }
                    });
                }
                
                const memCtx = document.getElementById('cluster-mem-history-chart');
                if (memCtx) {
                    if (clusterMemChart) clusterMemChart.destroy();
                    clusterMemChart = new Chart(memCtx, {
                        type: 'line',
                        data: {
                            labels: timestamps,
                            datasets: [
                                { label: 'Requests', data: memRequests, borderColor: '#fade2a', backgroundColor: 'rgba(250,222,42,0.1)', tension: 0.4, fill: true, pointRadius: 0, borderWidth: 2 },
                                { label: 'Usage', data: memUsage, borderColor: '#b877d9', backgroundColor: 'rgba(184,119,217,0.1)', tension: 0.4, fill: true, pointRadius: 0, borderWidth: 2 }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top', labels: { boxWidth: 12, font: { size: 10 } } } }, scales: { y: { beginAtZero: true }, x: { display: false } } }
                    });
                }
            } catch (err) { console.error('Error loading cluster history:', err); }
        }
        
        // Node Efficiency Analysis
        async function loadNodeEfficiency() {
            try {
                const res = await fetch('/api/cluster/node-efficiency');
                if (!res.ok) {
                    console.error('Failed to load node efficiency');
                    showNodeEfficiencyError('Unable to load node efficiency data. Please check if metrics-server is installed.');
                    return;
                }
                const data = await res.json();
                
                if (data.error) {
                    console.error('Node efficiency error:', data.error);
                    showNodeEfficiencyError(data.error, data.suggestion);
                    return;
                }
                
                const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
                
                // Update summary stats
                setEl('binpacking-score', data.bin_packing_efficiency?.toFixed(0) || '-');
                setEl('node-total-count', data.total_nodes || '-');
                setEl('node-underutilized', data.underutilized_nodes?.length || 0);
                setEl('node-overutilized', data.overutilized_nodes?.length || 0);
                
                // Update CPU waste
                setEl('node-cpu-requests', data.total_cpu_requests?.toFixed(1) || '-');
                setEl('node-cpu-usage', data.total_cpu_usage?.toFixed(1) || '-');
                setEl('node-cpu-wasted', data.wasted_cpu_requests?.toFixed(1) || '-');
                setEl('node-cpu-util-pct', data.cpu_actual_utilization?.toFixed(1) + '%' || '-');
                
                const cpuUtilBar = document.getElementById('node-cpu-util-bar');
                if (cpuUtilBar) {
                    const cpuPct = data.cpu_actual_utilization || 0;
                    cpuUtilBar.style.width = Math.min(cpuPct, 100) + '%';
                    cpuUtilBar.style.background = cpuPct > 85 ? 'var(--accent-red)' : cpuPct > 70 ? 'var(--accent-yellow)' : 'var(--accent-green)';
                }
                
                // Update Memory waste
                setEl('node-mem-requests', data.total_memory_requests?.toFixed(1) || '-');
                setEl('node-mem-usage', data.total_memory_usage?.toFixed(1) || '-');
                setEl('node-mem-wasted', data.wasted_memory_requests?.toFixed(1) || '-');
                setEl('node-mem-util-pct', data.memory_actual_utilization?.toFixed(1) + '%' || '-');
                
                const memUtilBar = document.getElementById('node-mem-util-bar');
                if (memUtilBar) {
                    const memPct = data.memory_actual_utilization || 0;
                    memUtilBar.style.width = Math.min(memPct, 100) + '%';
                    memUtilBar.style.background = memPct > 85 ? 'var(--accent-red)' : memPct > 70 ? 'var(--accent-yellow)' : 'var(--accent-purple)';
                }
                
                // Update recommendations
                const recsContainer = document.getElementById('node-recommendations');
                if (recsContainer && data.recommendations) {
                    let recsHtml = '';
                    for (const rec of data.recommendations) {
                        const icon = rec.startsWith('‚úÖ') ? '‚úÖ' : rec.startsWith('üí°') ? 'üí°' : rec.startsWith('‚ö†Ô∏è') ? '‚ö†Ô∏è' : rec.startsWith('üîª') ? 'üîª' : rec.startsWith('üî∫') ? 'üî∫' : rec.startsWith('üì¶') ? 'üì¶' : 'üí°';
                        const color = rec.startsWith('‚úÖ') ? 'var(--accent-green)' : rec.startsWith('‚ö†Ô∏è') ? 'var(--accent-yellow)' : rec.startsWith('üî∫') ? 'var(--accent-red)' : 'var(--text-primary)';
                        recsHtml += `<div style="padding:12px;background:var(--bg-secondary);border-radius:4px;border-left:3px solid ${color};">
                            <div style="font-size:13px;line-height:1.6;">${rec}</div>
                        </div>`;
                    }
                    recsContainer.innerHTML = recsHtml || '<div style="color:var(--text-secondary);text-align:center;padding:20px;">No recommendations available</div>';
                }
                
                // Update node breakdown table
                const tbody = document.getElementById('node-breakdown-body');
                if (tbody && data.node_breakdown) {
                    let html = '';
                    for (const node of data.node_breakdown) {
                        const cpuUtil = node.cpu_allocatable > 0 ? (node.cpu_usage / node.cpu_allocatable * 100) : 0;
                        const memUtil = node.memory_allocatable > 0 ? (node.memory_usage / node.memory_allocatable * 100) : 0;
                        const avgUtil = (cpuUtil + memUtil) / 2;
                        
                        const status = avgUtil < 30 ? 'warning' : avgUtil > 85 ? 'critical' : 'healthy';
                        const statusText = avgUtil < 30 ? 'Underutilized' : avgUtil > 85 ? 'Overutilized' : 'Optimal';
                        
                        html += `<tr>
                            <td><strong>${node.name}</strong></td>
                            <td><span class="badge info">${node.node_type}</span></td>
                            <td>${node.cpu_allocatable?.toFixed(1)} cores</td>
                            <td>${node.cpu_usage?.toFixed(2)} cores</td>
                            <td>${cpuUtil.toFixed(1)}%<div class="progress-bar"><div class="progress-fill ${status}" style="width:${Math.min(cpuUtil, 100)}%"></div></div></td>
                            <td>${node.memory_allocatable?.toFixed(1)} GB</td>
                            <td>${node.memory_usage?.toFixed(1)} GB</td>
                            <td>${memUtil.toFixed(1)}%<div class="progress-bar"><div class="progress-fill ${status}" style="width:${Math.min(memUtil, 100)}%"></div></div></td>
                            <td>${node.pod_count} / ${node.pod_capacity}</td>
                            <td><span class="badge ${status}">${statusText}</span></td>
                        </tr>`;
                    }
                    tbody.innerHTML = html || '<tr><td colspan="10" style="text-align:center;color:var(--text-secondary);padding:20px;">No node data available</td></tr>';
                }
            } catch (err) {
                console.error('Error loading node efficiency:', err);
                showNodeEfficiencyError('Failed to connect to API. Please check if the service is running.');
            }
        }
        
        function showNodeEfficiencyError(error, suggestion) {
            // Show error in recommendations
            const recsContainer = document.getElementById('node-recommendations');
            if (recsContainer) {
                recsContainer.innerHTML = `
                    <div style="padding:20px;background:var(--bg-secondary);border-radius:4px;border-left:3px solid var(--accent-red);text-align:center;">
                        <div style="font-size:48px;margin-bottom:12px;">‚ö†Ô∏è</div>
                        <div style="font-size:14px;font-weight:500;margin-bottom:8px;color:var(--accent-red);">Unable to Load Node Efficiency Data</div>
                        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;">${error}</div>
                        ${suggestion ? `<div style="font-size:12px;color:var(--text-primary);background:var(--bg-tertiary);padding:12px;border-radius:4px;margin-top:12px;">
                            <strong>üí° Suggestion:</strong> ${suggestion}
                        </div>` : ''}
                        <div style="font-size:11px;color:var(--text-disabled);margin-top:16px;">
                            <strong>Common Issues:</strong><br/>
                            ‚Ä¢ metrics-server not installed in cluster<br/>
                            ‚Ä¢ Insufficient RBAC permissions to list nodes<br/>
                            ‚Ä¢ Network connectivity issues
                        </div>
                    </div>
                `;
            }
            
            // Show error in node breakdown table
            const tbody = document.getElementById('node-breakdown-body');
            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:30px;">
                    <div style="color:var(--accent-red);font-size:14px;margin-bottom:8px;">‚ö†Ô∏è ${error}</div>
                    <div style="color:var(--text-secondary);font-size:12px;">${suggestion || 'Please check the logs for more details'}</div>
                </td></tr>`;
            }
        }
        
        document.getElementById('namespace-filter').addEventListener('change', function() {
            const selectedNs = this.value;
            document.querySelectorAll('#deployments-body tr').forEach(row => {
                if (selectedNs === 'all') row.style.display = '';
                else {
                    const nsText = row.querySelector('small')?.textContent || '';
                    row.style.display = nsText === selectedNs ? '' : 'none';
                }
            });
        });

        // Cost Trends Chart
        let costTrendsChart = null;
        
        async function loadCostTrends() {
            try {
                const res = await fetch('/api/finops/cost-trends?days=30');
                const data = await res.json();
                
                if (data.error || !data.daily_summary || data.daily_summary.length === 0) {
                    document.getElementById('cost-trend-summary').textContent = 'No data';
                    return;
                }
                
                // Update summary
                const s = data.summary || {};
                document.getElementById('cost-trend-summary').textContent = 
                    `Total: $${s.total_cost?.toFixed(0) || 0} | Wasted: $${s.total_wasted?.toFixed(0) || 0} | Efficiency: ${s.efficiency?.toFixed(0) || 0}%`;
                
                const ctx = document.getElementById('cost-trends-chart');
                if (!ctx) return;
                
                if (costTrendsChart) costTrendsChart.destroy();
                
                const labels = data.daily_summary.map(d => d.date);
                const costs = data.daily_summary.map(d => d.cost);
                const wasted = data.daily_summary.map(d => d.wasted);
                
                costTrendsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Actual Cost',
                                data: data.daily_summary.map(d => d.actual),
                                backgroundColor: 'rgba(115, 191, 105, 0.8)',
                                borderColor: '#73bf69',
                                borderWidth: 1
                            },
                            {
                                label: 'Wasted',
                                data: wasted,
                                backgroundColor: 'rgba(242, 73, 92, 0.8)',
                                borderColor: '#f2495c',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top', labels: { boxWidth: 12, font: { size: 10 } } }
                        },
                        scales: {
                            x: { stacked: true, display: true, ticks: { maxRotation: 45, font: { size: 9 } } },
                            y: { stacked: true, beginAtZero: true, ticks: { callback: v => '$' + v } }
                        }
                    }
                });
            } catch (err) {
                console.error('Error loading cost trends:', err);
            }
        }
        
        // Prediction Accuracy Charts
        let predictionAccuracyChart = null;
        let dailyAccuracyChart = null;
        
        async function loadPredictionAccuracy() {
            if (!state.currentDep) {
                document.getElementById('predictions-content').innerHTML = 
                    '<div class="empty-state"><div class="empty-state-icon">üîÆ</div><div>Select a deployment first</div></div>';
                return;
            }
            
            const [ns, dep] = state.currentDep.split('/');
            
            try {
                const res = await fetch(`/api/predictions/accuracy/${dep}?hours=168`);
                const data = await res.json();
                
                if (data.error) {
                    document.getElementById('predictions-content').innerHTML = 
                        `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>${data.error}</div></div>`;
                    return;
                }
                
                // Update stats
                const stats = data.stats || {};
                document.getElementById('prediction-stats').textContent = 
                    `Accuracy: ${stats.accuracy_rate?.toFixed(0) || 0}% | Total: ${stats.total_predictions || 0} | FP: ${stats.false_positives || 0}`;
                
                // Prediction vs Actual Chart
                if (data.history && data.history.length > 0) {
                    const ctx1 = document.getElementById('prediction-accuracy-chart');
                    if (ctx1) {
                        if (predictionAccuracyChart) predictionAccuracyChart.destroy();
                        
                        const labels = data.history.map(h => new Date(h.timestamp).toLocaleDateString());
                        const predicted = data.history.map(h => h.predicted);
                        const actual = data.history.map(h => h.actual);
                        
                        predictionAccuracyChart = new Chart(ctx1, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'Predicted',
                                        data: predicted,
                                        borderColor: '#5794f2',
                                        backgroundColor: 'rgba(87, 148, 242, 0.1)',
                                        tension: 0.4,
                                        pointRadius: 0,
                                        borderWidth: 2,
                                        fill: true
                                    },
                                    {
                                        label: 'Actual',
                                        data: actual,
                                        borderColor: '#73bf69',
                                        backgroundColor: 'rgba(115, 191, 105, 0.1)',
                                        tension: 0.4,
                                        pointRadius: 0,
                                        borderWidth: 2,
                                        fill: true
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: true, position: 'top', labels: { boxWidth: 12, font: { size: 10 } } } },
                                scales: {
                                    x: { display: false },
                                    y: { beginAtZero: true, max: 100, title: { display: true, text: 'CPU %' } }
                                }
                            }
                        });
                    }
                }
                
                // Daily Accuracy Chart
                if (data.daily_summary && data.daily_summary.length > 0) {
                    const ctx2 = document.getElementById('daily-accuracy-chart');
                    if (ctx2) {
                        if (dailyAccuracyChart) dailyAccuracyChart.destroy();
                        
                        dailyAccuracyChart = new Chart(ctx2, {
                            type: 'bar',
                            data: {
                                labels: data.daily_summary.map(d => d.date),
                                datasets: [{
                                    label: 'Accuracy %',
                                    data: data.daily_summary.map(d => d.accuracy),
                                    backgroundColor: data.daily_summary.map(d => 
                                        d.accuracy > 80 ? 'rgba(115, 191, 105, 0.8)' :
                                        d.accuracy > 60 ? 'rgba(250, 222, 42, 0.8)' :
                                        'rgba(242, 73, 92, 0.8)'
                                    ),
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    x: { display: true, ticks: { maxRotation: 45, font: { size: 9 } } },
                                    y: { beginAtZero: true, max: 100, title: { display: true, text: 'Accuracy %' } }
                                }
                            }
                        });
                    }
                }
                
                // Prediction History List
                let html = '<div style="margin-top:16px;"><strong>Recent Validated Predictions</strong></div>';
                if (data.history && data.history.length > 0) {
                    html += '<div style="margin-top:8px;">';
                    for (const pred of data.history.slice(-20).reverse()) {
                        const accColor = pred.accuracy > 0.8 ? 'var(--accent-green)' : 
                                        pred.accuracy > 0.6 ? 'var(--accent-yellow)' : 'var(--accent-red)';
                        html += `<div class="insight-card">
                            <div class="insight-header">
                                <span class="insight-title">${pred.action || 'maintain'}</span>
                                <span style="color:${accColor};font-size:12px">${((pred.accuracy || 0) * 100).toFixed(0)}% accurate</span>
                            </div>
                            <div style="font-size:11px;color:var(--text-secondary);">
                                Predicted: ${pred.predicted?.toFixed(1) || '-'}% | Actual: ${pred.actual?.toFixed(1) || '-'}%
                            </div>
                            <div class="timeline-time">${new Date(pred.timestamp).toLocaleString()}</div>
                        </div>`;
                    }
                    html += '</div>';
                } else {
                    html += '<div class="empty-state" style="padding:20px;"><div>No validated predictions yet</div></div>';
                }
                
                document.getElementById('predictions-content').innerHTML = html;
                
            } catch (err) {
                console.error('Error loading prediction accuracy:', err);
                document.getElementById('predictions-content').innerHTML = 
                    '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>Error loading predictions</div></div>';
            }
        }
        
        // Pre-Scale Management
        async function loadPrescaleData() {
            try {
                // Load summary
                const summaryRes = await fetch('/api/prescale/summary');
                const summary = await summaryRes.json();
                
                if (!summary.error) {
                    document.getElementById('prescale-normal').textContent = summary.normal || 0;
                    document.getElementById('prescale-active').textContent = summary.pre_scaling || 0;
                    document.getElementById('prescale-success').textContent = (summary.success_rate || 0).toFixed(0) + '%';
                    document.getElementById('prescale-total').textContent = summary.total_prescale_actions || 0;
                    document.getElementById('prescale-stats').textContent = 
                        `Enabled: ${summary.enabled ? 'Yes' : 'No'} | Threshold: ${summary.config?.scale_up_threshold || 75}%`;
                }
                
                // Load profiles
                const profilesRes = await fetch('/api/prescale/profiles');
                const profilesData = await profilesRes.json();
                
                const tbody = document.getElementById('prescale-profiles-body');
                
                if (!profilesData.profiles || profilesData.profiles.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-secondary);">No deployments registered for pre-scaling yet</td></tr>';
                    return;
                }
                
                tbody.innerHTML = profilesData.profiles.map(p => {
                    const stateClass = p.state === 'pre_scaling' ? 'warning' : 
                                       p.state === 'rolling_back' ? 'critical' : 'healthy';
                    const rollbackTime = p.rollback_at ? new Date(p.rollback_at).toLocaleTimeString() : '-';
                    
                    return `
                        <tr>
                            <td><strong>${p.namespace}/${p.deployment}</strong></td>
                            <td><span class="badge ${stateClass}">${p.state}</span></td>
                            <td>${p.original_min_replicas}</td>
                            <td style="color:${p.current_min_replicas > p.original_min_replicas ? 'var(--accent-yellow)' : 'inherit'}">${p.current_min_replicas}</td>
                            <td>${p.predicted_cpu ? p.predicted_cpu.toFixed(1) + '%' : '-'}</td>
                            <td>${p.prediction_confidence ? (p.prediction_confidence * 100).toFixed(0) + '%' : '-'}</td>
                            <td>${rollbackTime}</td>
                            <td>
                                ${p.state === 'pre_scaling' ? 
                                    `<button class="btn" onclick="forcePrescaleRollback('${p.namespace}', '${p.deployment}')">Rollback</button>` :
                                    `<button class="btn" onclick="showForcePrescaleDialog('${p.namespace}', '${p.deployment}', ${p.original_max_replicas})">Force</button>`
                                }
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (err) {
                console.error('Error loading pre-scale data:', err);
                document.getElementById('prescale-profiles-body').innerHTML = 
                    '<tr><td colspan="8" style="text-align:center;color:var(--accent-red);">Error loading pre-scale data</td></tr>';
            }
        }
        
        async function forcePrescaleRollback(namespace, deployment) {
            if (!confirm(`Rollback ${namespace}/${deployment} to original minReplicas?`)) return;
            
            try {
                const res = await fetch(`/api/prescale/${namespace}/${deployment}/rollback`, { method: 'POST' });
                const data = await res.json();
                
                if (data.action === 'rolled_back') {
                    alert('Rollback successful!');
                    loadPrescaleData();
                } else {
                    alert('Rollback failed: ' + (data.reason || data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }
        
        function showForcePrescaleDialog(namespace, deployment, maxReplicas) {
            const newMin = prompt(`Force pre-scale ${namespace}/${deployment}\nEnter new minReplicas (max: ${maxReplicas}):`);
            if (!newMin) return;
            
            const minVal = parseInt(newMin);
            if (isNaN(minVal) || minVal < 1 || minVal > maxReplicas) {
                alert(`Invalid value. Must be between 1 and ${maxReplicas}`);
                return;
            }
            
            forcePrescale(namespace, deployment, minVal);
        }
        
        async function forcePrescale(namespace, deployment, newMinReplicas) {
            try {
                const res = await fetch(`/api/prescale/${namespace}/${deployment}/force`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_min_replicas: newMinReplicas, reason: 'Manual via dashboard' })
                });
                const data = await res.json();
                
                if (data.action === 'pre_scaled') {
                    alert('Pre-scale successful!');
                    loadPrescaleData();
                } else {
                    alert('Pre-scale failed: ' + (data.reason || data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }
        
        // Alerts
        async function loadAlerts() {
            const container = document.getElementById('alerts-content');
            const summaryEl = document.getElementById('alerts-summary');
            
            try {
                const res = await fetch('/api/alerts/recent?hours=24');
                const data = await res.json();
                
                if (data.error) {
                    container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>${data.error}</div></div>`;
                    return;
                }
                
                // Update summary
                const s = data.summary || {};
                summaryEl.innerHTML = `
                    <span style="color:var(--accent-red)">üî¥ ${s.critical || 0}</span> ¬∑ 
                    <span style="color:var(--accent-yellow)">üü° ${s.warning || 0}</span> ¬∑ 
                    <span style="color:var(--accent-cyan)">‚ÑπÔ∏è ${s.info || 0}</span>
                `;
                
                if (!data.alerts || data.alerts.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><div>No alerts in the last 24 hours</div></div>';
                    return;
                }
                
                let html = '';
                for (const alert of data.alerts) {
                    const severityColors = {
                        'critical': 'var(--accent-red)',
                        'warning': 'var(--accent-yellow)',
                        'info': 'var(--accent-cyan)'
                    };
                    const severityIcons = {
                        'critical': 'üî¥',
                        'warning': 'üü°',
                        'info': '‚ÑπÔ∏è'
                    };
                    const sev = (alert.severity || 'info').toLowerCase();
                    
                    html += `<div class="recommendation-panel" style="border-left-color:${severityColors[sev] || 'var(--text-secondary)'};">
                        <div class="recommendation-header">
                            <div class="recommendation-title">
                                ${severityIcons[sev] || '‚ùì'} <strong>${alert.deployment}</strong>
                                <span class="badge ${sev === 'critical' ? 'critical' : sev === 'warning' ? 'warning' : 'info'}">${alert.type}</span>
                            </div>
                            <span style="font-size:11px;color:var(--text-secondary)">${new Date(alert.timestamp).toLocaleString()}</span>
                        </div>
                        <div style="font-size:12px;margin-top:8px;">${alert.description}</div>
                        ${alert.current_value !== null ? `
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:4px;">
                                Current: ${alert.current_value} | Expected: ${alert.expected_value} | Deviation: ${alert.deviation_percent}%
                            </div>
                        ` : ''}
                    </div>`;
                }
                
                container.innerHTML = html;
                
            } catch (err) {
                console.error('Error loading alerts:', err);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>Error loading alerts</div></div>';
            }
        }
        
        // Notification Providers
        const ALERT_TYPES = [
            { id: 'cpu_spike', label: 'CPU Spike', icon: 'üî¥' },
            { id: 'scaling_thrashing', label: 'Scaling Thrashing', icon: 'üü°' },
            { id: 'high_memory', label: 'High Memory', icon: 'üü£' },
            { id: 'low_efficiency', label: 'Low Efficiency', icon: 'üîµ' },
            { id: 'hpa_flapping', label: 'HPA Flapping', icon: 'üü†' },
            { id: 'cost_optimization', label: 'Cost Optimization', icon: 'üí∞' },
            { id: 'memory_leak', label: 'Memory Leak', icon: '‚ö†Ô∏è' },
            { id: 'prescale', label: 'Pre-Scale Events', icon: 'üìà' },
            { id: 'autopilot', label: 'Autopilot Actions', icon: 'ü§ñ' }
        ];
        
        async function loadNotificationProviders() {
            const container = document.getElementById('notification-providers-content');
            
            try {
                const res = await fetch('/api/notification-providers');
                const data = await res.json();
                
                if (data.error) {
                    container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>${data.error}</div></div>`;
                    return;
                }
                
                const providers = data.providers || [];
                
                if (providers.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding:20px;">
                            <div class="empty-state-icon">üì°</div>
                            <div>No notification providers configured</div>
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:8px;">
                                Add providers via dashboard or set environment variables:<br>
                                SLACK_WEBHOOK, TEAMS_WEBHOOK, DISCORD_WEBHOOK, GENERIC_WEBHOOK
                            </div>
                        </div>`;
                    return;
                }
                
                const providerIcons = {
                    'slack': 'üí¨',
                    'teams': 'üë•',
                    'discord': 'üéÆ',
                    'generic': 'üîó'
                };
                
                let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px;">';
                
                for (const p of providers) {
                    const icon = providerIcons[p.provider_type] || 'üì°';
                    const sourceLabel = p.source === 'environment' ? 
                        '<span style="font-size:9px;background:var(--bg-tertiary);padding:2px 6px;border-radius:3px;margin-left:8px;">ENV</span>' : 
                        '<span style="font-size:9px;background:var(--accent-blue);color:white;padding:2px 6px;border-radius:3px;margin-left:8px;">DASHBOARD</span>';
                    
                    // Format alert types
                    const alertTypes = p.alert_types || ['all'];
                    const isAllTypes = alertTypes.includes('all');
                    const alertTypesDisplay = isAllTypes ? 
                        '<span style="color:var(--accent-green)">All alerts</span>' :
                        alertTypes.map(t => {
                            const at = ALERT_TYPES.find(a => a.id === t);
                            return at ? `<span title="${at.label}">${at.icon}</span>` : t;
                        }).join(' ');
                    
                    html += `
                        <div class="insight-card" style="position:relative;">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                                <div style="flex:1;">
                                    <div style="font-size:13px;font-weight:500;display:flex;align-items:center;">
                                        ${icon} ${p.name} ${sourceLabel}
                                    </div>
                                    <div style="font-size:11px;color:var(--text-secondary);margin-top:4px;">
                                        Type: <strong>${p.provider_type}</strong>
                                    </div>
                                    <div style="font-size:10px;color:var(--text-disabled);margin-top:2px;font-family:monospace;">
                                        ${p.webhook_url}
                                    </div>
                                    <div style="font-size:11px;margin-top:6px;">
                                        <span style="color:var(--text-secondary)">Subscribed:</span> ${alertTypesDisplay}
                                    </div>
                                </div>
                                <div style="display:flex;align-items:center;gap:4px;">
                                    <span style="width:8px;height:8px;border-radius:50%;background:${p.enabled ? 'var(--accent-green)' : 'var(--text-disabled)'};"></span>
                                </div>
                            </div>
                            ${!p.readonly ? `
                                <div style="display:flex;gap:8px;margin-top:12px;border-top:1px solid var(--border-weak);padding-top:8px;flex-wrap:wrap;">
                                    <button class="btn" style="font-size:10px;padding:4px 8px;" onclick="testProvider(${p.id})">üß™ Test</button>
                                    <button class="btn" style="font-size:10px;padding:4px 8px;" onclick="editProviderAlerts(${p.id}, '${p.name}', ${JSON.stringify(alertTypes).replace(/"/g, '&quot;')})">üìã Alerts</button>
                                    <button class="btn" style="font-size:10px;padding:4px 8px;" onclick="editProvider(${p.id}, '${p.name}', '${p.provider_type}', ${p.enabled})">‚úèÔ∏è Edit</button>
                                    <button class="btn" style="font-size:10px;padding:4px 8px;color:var(--accent-red);" onclick="deleteProvider(${p.id}, '${p.name}')">üóëÔ∏è</button>
                                </div>
                            ` : `
                                <div style="font-size:10px;color:var(--text-disabled);margin-top:8px;font-style:italic;">
                                    Configured via environment variable (read-only, receives all alerts)
                                </div>
                            `}
                        </div>`;
                }
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (err) {
                console.error('Error loading notification providers:', err);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>Error loading providers</div></div>';
            }
        }
        
        function showAddProviderDialog() {
            const name = prompt('Provider Name (e.g., "Production Slack"):');
            if (!name) return;
            
            const type = prompt('Provider Type (slack, teams, discord, generic):');
            if (!type || !['slack', 'teams', 'discord', 'generic'].includes(type.toLowerCase())) {
                alert('Invalid provider type. Must be: slack, teams, discord, or generic');
                return;
            }
            
            const webhookUrl = prompt('Webhook URL:');
            if (!webhookUrl) return;
            
            // Ask if user wants to test first
            const testFirst = confirm('Would you like to test the webhook before saving?');
            if (testFirst) {
                testWebhookDirect(type.toLowerCase(), webhookUrl, name);
            } else {
                addProvider(name, type.toLowerCase(), webhookUrl);
            }
        }
        
        async function testWebhookDirect(providerType, webhookUrl, providerName) {
            try {
                const res = await fetch('/api/notification-providers/test-webhook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider_type: providerType, webhook_url: webhookUrl })
                });
                const data = await res.json();
                
                if (data.success) {
                    const saveNow = confirm(`‚úÖ Test successful! ${data.message}\n\nSave this provider now?`);
                    if (saveNow) {
                        addProvider(providerName, providerType, webhookUrl);
                    }
                } else {
                    const saveAnyway = confirm(`‚ùå Test failed: ${data.error}\n\nSave provider anyway?`);
                    if (saveAnyway) {
                        addProvider(providerName, providerType, webhookUrl);
                    }
                }
            } catch (err) {
                const saveAnyway = confirm(`‚ùå Error testing webhook: ${err.message}\n\nSave provider anyway?`);
                if (saveAnyway) {
                    addProvider(providerName, providerType, webhookUrl);
                }
            }
        }
        
        function editProviderAlerts(providerId, providerName, currentAlerts) {
            // Create a simple checkbox dialog
            const isAll = currentAlerts.includes('all');
            
            let checkboxes = ALERT_TYPES.map(at => {
                const checked = isAll || currentAlerts.includes(at.id);
                return `${at.icon} ${at.label}: ${checked ? '‚úì' : '‚úó'}`;
            }).join('\\n');
            
            const input = prompt(
                `Alert subscriptions for "${providerName}":\\n\\n` +
                `Current: ${isAll ? 'All alerts' : currentAlerts.join(', ')}\\n\\n` +
                `Enter alert types to subscribe (comma-separated), or "all" for all alerts:\\n` +
                `Available: ${ALERT_TYPES.map(a => a.id).join(', ')}`,
                isAll ? 'all' : currentAlerts.join(',')
            );
            
            if (input === null) return;
            
            const newAlerts = input.trim().toLowerCase() === 'all' ? 
                ['all'] : 
                input.split(',').map(s => s.trim()).filter(s => s);
            
            updateProviderAlerts(providerId, newAlerts);
        }
        
        async function updateProviderAlerts(providerId, alertTypes) {
            try {
                const res = await fetch(`/api/notification-providers/${providerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ alert_types: alertTypes })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('Alert subscriptions updated!');
                    loadNotificationProviders();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error updating alerts: ' + err.message);
            }
        }
        
        async function addProvider(name, providerType, webhookUrl) {
            try {
                const res = await fetch('/api/notification-providers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, provider_type: providerType, webhook_url: webhookUrl, enabled: true, alert_types: ['all'] })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('Provider added successfully!');
                    loadNotificationProviders();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error adding provider: ' + err.message);
            }
        }
        
        async function testProvider(providerId) {
            try {
                const res = await fetch(`/api/notification-providers/${providerId}/test`, { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    alert(data.message);
                } else {
                    alert('Test failed: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error testing provider: ' + err.message);
            }
        }
        
        function editProvider(providerId, currentName, currentType, currentEnabled) {
            const name = prompt('Provider Name:', currentName);
            if (name === null) return;
            
            const enabled = confirm('Enable this provider?');
            
            const updateWebhook = confirm('Update webhook URL?');
            let webhookUrl = null;
            if (updateWebhook) {
                webhookUrl = prompt('New Webhook URL:');
                if (!webhookUrl) return;
            }
            
            updateProvider(providerId, name || currentName, webhookUrl, enabled);
        }
        
        async function updateProvider(providerId, name, webhookUrl, enabled) {
            try {
                const body = { name, enabled };
                if (webhookUrl) body.webhook_url = webhookUrl;
                
                const res = await fetch(`/api/notification-providers/${providerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('Provider updated successfully!');
                    loadNotificationProviders();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error updating provider: ' + err.message);
            }
        }
        
        async function deleteProvider(providerId, name) {
            if (!confirm(`Delete provider "${name}"?`)) return;
            
            try {
                const res = await fetch(`/api/notification-providers/${providerId}`, { method: 'DELETE' });
                const data = await res.json();
                
                if (data.success) {
                    alert('Provider deleted successfully!');
                    loadNotificationProviders();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error deleting provider: ' + err.message);
            }
        }
        
        // HPA Analysis
        async function loadHpaAnalysis() {
            const container = document.getElementById('hpa-analysis-content');
            
            if (!state.currentDep) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üõ°Ô∏è</div><div>Select a deployment from the Deployments tab to analyze HPA behavior</div></div>';
                return;
            }
            
            const [ns, dep] = state.currentDep.split('/');
            container.innerHTML = '<div class="empty-state"><div class="spinner">‚ü≥</div><div>Analyzing HPA behavior...</div></div>';
            
            try {
                const res = await fetch(`/api/deployment/${ns}/${dep}/hpa-analysis`);
                const data = await res.json();
                
                if (data.error) {
                    container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>${data.error}</div></div>`;
                    return;
                }
                
                const riskColors = {
                    'low': 'var(--accent-green)',
                    'medium': 'var(--accent-yellow)',
                    'high': 'var(--accent-red)'
                };
                const riskIcons = {
                    'low': '‚úÖ',
                    'medium': 'üü°',
                    'high': 'üî¥'
                };
                
                const analysis = data.analysis || {};
                const hpaConfig = data.hpa_config || {};
                const scalingFreq = data.scaling_frequency || {};
                
                let html = `
                    <!-- Risk Summary -->
                    <div class="recommendation-panel" style="border-left-color:${riskColors[analysis.risk_level] || 'var(--text-secondary)'};">
                        <div class="recommendation-header">
                            <div class="recommendation-title">
                                ${riskIcons[analysis.risk_level] || '‚ùì'} Risk Level: <strong>${(analysis.risk_level || 'unknown').toUpperCase()}</strong>
                            </div>
                            <span class="badge ${analysis.risk_level === 'high' ? 'critical' : analysis.risk_level === 'medium' ? 'warning' : 'healthy'}">${data.pattern || 'unknown'} pattern</span>
                        </div>
                        <div style="font-size:12px;margin-top:8px;">${analysis.summary || 'No analysis available'}</div>
                    </div>
                    
                    <!-- Current HPA Config -->
                    <div class="grid-2" style="margin-top:16px;">
                        <div class="resource-card">
                            <div class="resource-header">
                                <div class="resource-icon cpu">‚öôÔ∏è</div>
                                <span>Current HPA Config</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">HPA Name</span>
                                <span class="metric-value">${hpaConfig.name || '-'}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Min/Max Replicas</span>
                                <span class="metric-value">${hpaConfig.min_replicas || '-'} / ${hpaConfig.max_replicas || '-'}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Target CPU</span>
                                <span class="metric-value">${hpaConfig.target_cpu_percent || '-'}%</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Current Replicas</span>
                                <span class="metric-value">${hpaConfig.current_replicas || '-'}</span>
                            </div>
                        </div>
                        
                        <div class="resource-card">
                            <div class="resource-header">
                                <div class="resource-icon memory">üìä</div>
                                <span>Scaling Frequency</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Events (24h)</span>
                                <span class="metric-value" style="color:${scalingFreq.events_24h > 20 ? 'var(--accent-red)' : 'var(--text-primary)'}">${scalingFreq.events_24h || 0}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Events (1h)</span>
                                <span class="metric-value" style="color:${scalingFreq.events_1h > 5 ? 'var(--accent-red)' : 'var(--text-primary)'}">${scalingFreq.events_1h || 0}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Flapping Detected</span>
                                <span class="metric-value">${scalingFreq.is_flapping ? '<span style="color:var(--accent-red)">‚ö†Ô∏è YES</span>' : '<span style="color:var(--accent-green)">‚úÖ NO</span>'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Behavior Config -->
                    <div class="grid-2" style="margin-top:16px;">
                        <div class="resource-card">
                            <div class="resource-header">
                                <div class="resource-icon cpu">‚¨ÜÔ∏è</div>
                                <span>Scale Up Behavior</span>
                            </div>
                            ${hpaConfig.behavior?.scale_up ? `
                                <div class="metric-row">
                                    <span class="metric-label">Stabilization Window</span>
                                    <span class="metric-value">${hpaConfig.behavior.scale_up.stabilization_window_seconds || 0}s</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Select Policy</span>
                                    <span class="metric-value">${hpaConfig.behavior.scale_up.select_policy || 'Max'}</span>
                                </div>
                                ${(hpaConfig.behavior.scale_up.policies || []).map(p => `
                                    <div class="metric-row">
                                        <span class="metric-label">Policy</span>
                                        <span class="metric-value">${p.type}: ${p.value} / ${p.period_seconds}s</span>
                                    </div>
                                `).join('')}
                            ` : '<div style="color:var(--text-secondary);font-size:12px;">Not configured (using K8s defaults)</div>'}
                        </div>
                        
                        <div class="resource-card">
                            <div class="resource-header">
                                <div class="resource-icon memory">‚¨áÔ∏è</div>
                                <span>Scale Down Behavior</span>
                            </div>
                            ${hpaConfig.behavior?.scale_down ? `
                                <div class="metric-row">
                                    <span class="metric-label">Stabilization Window</span>
                                    <span class="metric-value">${hpaConfig.behavior.scale_down.stabilization_window_seconds || 0}s</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Select Policy</span>
                                    <span class="metric-value">${hpaConfig.behavior.scale_down.select_policy || 'Min'}</span>
                                </div>
                                ${(hpaConfig.behavior.scale_down.policies || []).map(p => `
                                    <div class="metric-row">
                                        <span class="metric-label">Policy</span>
                                        <span class="metric-value">${p.type}: ${p.value} / ${p.period_seconds}s</span>
                                    </div>
                                `).join('')}
                            ` : '<div style="color:var(--text-secondary);font-size:12px;">Not configured (using K8s defaults)</div>'}
                        </div>
                    </div>
                `;
                
                // Issues
                if (analysis.issues && analysis.issues.length > 0) {
                    html += `
                        <div style="margin-top:16px;">
                            <h4 style="font-size:13px;margin-bottom:8px;color:var(--text-primary);">‚ö†Ô∏è Issues Found</h4>
                            ${analysis.issues.map(issue => `
                                <div class="recommendation-panel ${issue.severity}" style="margin-bottom:8px;">
                                    <div style="font-size:12px;">
                                        <strong>${issue.type}</strong>: ${issue.message}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Recommendations
                if (analysis.recommendations && analysis.recommendations.length > 0) {
                    html += `
                        <div style="margin-top:16px;">
                            <h4 style="font-size:13px;margin-bottom:8px;color:var(--text-primary);">üí° Recommendations</h4>
                            ${analysis.recommendations.map(rec => `
                                <div class="recommendation-panel low" style="margin-bottom:8px;">
                                    <div style="font-size:12px;">
                                        <strong>${rec.type}</strong>
                                        ${rec.current !== null ? `<br>Current: <code>${rec.current}</code> ‚Üí Recommended: <code>${rec.recommended}</code>` : ''}
                                        <br><span style="color:var(--text-secondary)">${rec.reason}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // YAML Snippet
                if (analysis.yaml_snippet) {
                    html += `
                        <div style="margin-top:16px;">
                            <h4 style="font-size:13px;margin-bottom:8px;color:var(--text-primary);">üìã Recommended HPA Config</h4>
                            <div class="yaml-snippet">${analysis.yaml_snippet}</div>
                            <button class="btn" style="margin-top:8px;" onclick="navigator.clipboard.writeText(\`${analysis.yaml_snippet.replace(/`/g, '\\`')}\`).then(() => alert('Copied to clipboard!'))">üìã Copy YAML</button>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
            } catch (err) {
                console.error('Error loading HPA analysis:', err);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>Error loading HPA analysis</div></div>';
            }
        }

        // Show event details modal
        function showEventDetails(namespace, deployment, timestamp, action, podCount, hpaTarget) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: var(--bg-primary);
                border: 1px solid var(--border-medium);
                border-radius: 8px;
                padding: 24px;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            const actionIcon = action === 'scale_up' ? '‚Üë' : action === 'scale_down' ? '‚Üì' : '‚Üî';
            const actionColor = action === 'scale_up' ? 'var(--accent-green)' : action === 'scale_down' ? 'var(--accent-red)' : 'var(--accent-cyan)';
            
            content.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <h3 style="margin:0;font-size:18px;color:var(--text-primary);">
                        <span style="color:${actionColor};font-size:24px;">${actionIcon}</span> Scaling Event Details
                    </h3>
                    <button onclick="this.closest('[style*=fixed]').remove()" style="background:none;border:none;color:var(--text-secondary);font-size:24px;cursor:pointer;padding:0;width:32px;height:32px;">&times;</button>
                </div>
                
                <div class="metric-row">
                    <span class="metric-label">Namespace</span>
                    <span class="metric-value" style="color:var(--accent-cyan)">${namespace || 'N/A'}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Deployment</span>
                    <span class="metric-value" style="color:var(--accent-cyan)">${deployment || 'N/A'}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Action</span>
                    <span class="metric-value" style="color:${actionColor}">${action.replace('_', ' ').toUpperCase()}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Pod Count</span>
                    <span class="metric-value">${podCount || 'N/A'}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">HPA Target</span>
                    <span class="metric-value">${hpaTarget || 'N/A'}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Timestamp</span>
                    <span class="metric-value" style="font-size:11px;">${new Date(timestamp).toLocaleString()}</span>
                </div>
                
                <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border-weak);">
                    <button onclick="this.closest('[style*=fixed]').remove()" class="btn btn-primary" style="width:100%;">Close</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            // Close on Escape key
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }

        // ============================================
        // Advanced Reporting Functions
        // ============================================
        
        function selectReport(reportId, loadFunction) {
            // Remove active class from all buttons
            document.querySelectorAll('#report-type-selector .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
            });
            
            // Add active class to selected button
            const selectedBtn = document.getElementById(`btn-${reportId}`);
            if (selectedBtn) {
                selectedBtn.classList.add('btn-primary');
            }
            
            // Load the report
            loadFunction();
        }
        
        async function loadReports() {
            selectReport('executive', loadExecutiveSummary);
        }

        async function loadExecutiveSummary() {
            // Show loading state
            document.getElementById('report-content').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 16px; color: var(--text-secondary);">Generating executive summary...</p>
                </div>
            `;
            
            const data = await fetchAPI('/api/reports/executive-summary?days=30');
            if (!data || data.error) {
                const errorMsg = data?.error || 'Failed to load executive summary';
                const isNoData = errorMsg.includes('just started') || errorMsg.includes('no data');
                
                document.getElementById('report-content').innerHTML = `
                    <div class="alert ${isNoData ? 'alert-warning' : 'alert-error'}">
                        <strong>${isNoData ? 'No Data Yet' : 'Error'}:</strong> ${errorMsg}
                        ${isNoData ? '<br><br><em>üí° Tip: The system collects data every monitoring cycle. Try refreshing in a few minutes.</em>' : ''}
                    </div>
                `;
                return;
            }

            const summary = data.summary;
            const alerts = data.alerts;
            const scaling = data.scaling_activity;

            document.getElementById('report-content').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="metric-card">
                        <div class="metric-label">Total Deployments</div>
                        <div class="metric-value">${summary.total_deployments}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Monthly Cost</div>
                        <div class="metric-value">$${summary.monthly_cost.toFixed(2)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Efficiency Score</div>
                        <div class="metric-value" style="color: ${summary.efficiency_score > 70 ? 'var(--accent-green)' : summary.efficiency_score > 50 ? 'var(--accent-yellow)' : 'var(--accent-red)'}">${summary.efficiency_score}/100</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Potential Savings</div>
                        <div class="metric-value" style="color: var(--accent-green)">$${summary.potential_monthly_savings.toFixed(2)}/mo</div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${summary.savings_percentage}% reduction</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title">Scaling Activity (30 days)</span>
                        </div>
                        <div class="panel-body">
                            <div class="metric-row">
                                <span class="metric-label">Total Events</span>
                                <span class="metric-value">${scaling.total_events}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Scale Ups</span>
                                <span class="metric-value" style="color: var(--accent-green)">${scaling.scale_ups}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Scale Downs</span>
                                <span class="metric-value" style="color: var(--accent-blue)">${scaling.scale_downs}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Avg per Day</span>
                                <span class="metric-value">${scaling.avg_per_day.toFixed(1)}</span>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title">Alerts</span>
                        </div>
                        <div class="panel-body">
                            <div class="metric-row">
                                <span class="metric-label">Cost Anomalies</span>
                                <span class="metric-value" style="color: ${alerts.anomaly_count > 0 ? 'var(--accent-red)' : 'var(--accent-green)'}">${alerts.anomaly_count}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Idle Resources</span>
                                <span class="metric-value" style="color: ${alerts.idle_resource_count > 0 ? 'var(--accent-yellow)' : 'var(--accent-green)'}">${alerts.idle_resource_count}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Top Recommendations</span>
                    </div>
                    <div class="panel-body">
                        ${data.recommendations.map(rec => `
                            <div style="padding: 12px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 8px;">
                                <div style="display: flex; align-items: start; gap: 12px;">
                                    <span style="font-size: 20px;">üí°</span>
                                    <div style="flex: 1;">${rec}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                ${alerts.idle_resources.length > 0 ? `
                <div class="panel" style="margin-top: 16px;">
                    <div class="panel-header">
                        <span class="panel-title">Top Idle Resources</span>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Deployment</th>
                                    <th>CPU Util</th>
                                    <th>Memory Util</th>
                                    <th>Daily Cost</th>
                                    <th>Monthly Waste</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${alerts.idle_resources.map(r => `
                                    <tr>
                                        <td>${r.namespace}/${r.deployment}</td>
                                        <td><span class="badge badge-${r.cpu_utilization < 20 ? 'error' : 'warning'}">${r.cpu_utilization.toFixed(1)}%</span></td>
                                        <td><span class="badge badge-${r.memory_utilization < 20 ? 'error' : 'warning'}">${r.memory_utilization.toFixed(1)}%</span></td>
                                        <td>$${r.daily_cost.toFixed(2)}</td>
                                        <td style="color: var(--accent-red); font-weight: 600;">$${r.monthly_waste.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}
            `;
        }

        async function loadCostAllocation() {
            // Show loading state
            document.getElementById('report-content').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 16px; color: var(--text-secondary);">Loading cost allocation data...</p>
                </div>
            `;
            
            const teamData = await fetchAPI('/api/cost/allocation/team?hours=24');
            const namespaceData = await fetchAPI('/api/cost/allocation/namespace?hours=24');

            if (!teamData || teamData.error || !namespaceData || namespaceData.error) {
                document.getElementById('report-content').innerHTML = `
                    <div class="alert alert-error">
                        <strong>Error:</strong> ${teamData?.error || namespaceData?.error || 'Failed to load cost allocation data'}
                    </div>
                `;
                return;
            }

            const teams = Object.entries(teamData).sort((a, b) => b[1].total_cost - a[1].total_cost);
            const namespaces = Object.entries(namespaceData).sort((a, b) => b[1].total_cost - a[1].total_cost);

            document.getElementById('report-content').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title">Cost by Team (Daily)</span>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Team</th>
                                        <th>Deployments</th>
                                        <th>Daily Cost</th>
                                        <th>Monthly Est.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${teams.map(([team, data]) => `
                                        <tr>
                                            <td><strong>${team}</strong></td>
                                            <td>${data.deployment_count}</td>
                                            <td>$${data.total_cost.toFixed(2)}</td>
                                            <td>$${(data.total_cost * 30).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title">Cost by Namespace (Daily)</span>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Namespace</th>
                                        <th>Deployments</th>
                                        <th>Daily Cost</th>
                                        <th>Monthly Est.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${namespaces.map(([ns, data]) => `
                                        <tr>
                                            <td><strong>${ns}</strong></td>
                                            <td>${data.deployment_count}</td>
                                            <td>$${data.total_cost.toFixed(2)}</td>
                                            <td>$${(data.total_cost * 30).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadCostForecast() {
            const data = await fetchAPI('/api/reports/forecast?days=90');
            if (!data || data.error) {
                document.getElementById('report-content').innerHTML = `
                    <div class="alert alert-error">
                        <strong>Error:</strong> ${data?.error || 'Failed to load forecast'}
                    </div>
                `;
                return;
            }

            document.getElementById('report-content').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="metric-card">
                        <div class="metric-label">Trend</div>
                        <div class="metric-value" style="color: ${data.trend === 'increasing' ? 'var(--accent-red)' : data.trend === 'decreasing' ? 'var(--accent-green)' : 'var(--accent-yellow)'}">
                            ${data.trend.toUpperCase()}
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                            ${data.daily_change > 0 ? '+' : ''}$${data.daily_change.toFixed(2)}/day
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">30-Day Forecast</div>
                        <div class="metric-value">$${data.totals['30_day'].toFixed(2)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">60-Day Forecast</div>
                        <div class="metric-value">$${data.totals['60_day'].toFixed(2)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">90-Day Forecast</div>
                        <div class="metric-value">$${data.totals['90_day'].toFixed(2)}</div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Daily Cost Forecast (Next 30 Days)</span>
                    </div>
                    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Predicted Cost</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.forecasts.slice(0, 30).map(f => `
                                    <tr>
                                        <td>${f.date}</td>
                                        <td>$${f.predicted_cost.toFixed(2)}</td>
                                        <td><span class="badge badge-${f.confidence === 'high' ? 'success' : f.confidence === 'medium' ? 'warning' : 'error'}">${f.confidence}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        async function loadROIReport() {
            const data = await fetchAPI('/api/reports/roi');
            if (!data || data.error) {
                document.getElementById('report-content').innerHTML = `
                    <div class="alert alert-error">
                        <strong>Error:</strong> ${data?.error || 'Failed to load ROI report'}
                    </div>
                `;
                return;
            }

            document.getElementById('report-content').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="metric-card">
                        <div class="metric-label">Current Monthly Cost</div>
                        <div class="metric-value">$${data.current_monthly_cost.toFixed(2)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Potential Monthly Savings</div>
                        <div class="metric-value" style="color: var(--accent-green)">$${data.potential_monthly_savings.toFixed(2)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Potential Annual Savings</div>
                        <div class="metric-value" style="color: var(--accent-green)">$${data.potential_annual_savings.toFixed(2)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Savings Percentage</div>
                        <div class="metric-value" style="color: var(--accent-green)">${data.savings_percentage.toFixed(1)}%</div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Optimization Breakdown</span>
                    </div>
                    <div class="panel-body">
                        <div class="metric-row">
                            <span class="metric-label">Right-Sizing Opportunities</span>
                            <span class="metric-value">${data.optimization_breakdown.right_sizing.opportunities}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Monthly Savings (Right-Sizing)</span>
                            <span class="metric-value" style="color: var(--accent-green)">$${data.optimization_breakdown.right_sizing.monthly_savings.toFixed(2)}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Annual Savings (Right-Sizing)</span>
                            <span class="metric-value" style="color: var(--accent-green)">$${data.optimization_breakdown.right_sizing.annual_savings.toFixed(2)}</span>
                        </div>
                    </div>
                </div>

                ${data.top_opportunities.length > 0 ? `
                <div class="panel" style="margin-top: 16px;">
                    <div class="panel-header">
                        <span class="panel-title">Top 5 Optimization Opportunities</span>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Deployment</th>
                                    <th>CPU Util</th>
                                    <th>Memory Util</th>
                                    <th>Monthly Waste</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.top_opportunities.map(opp => `
                                    <tr>
                                        <td>${opp.namespace}/${opp.deployment}</td>
                                        <td><span class="badge badge-${opp.cpu_utilization < 20 ? 'error' : 'warning'}">${opp.cpu_utilization.toFixed(1)}%</span></td>
                                        <td><span class="badge badge-${opp.memory_utilization < 20 ? 'error' : 'warning'}">${opp.memory_utilization.toFixed(1)}%</span></td>
                                        <td style="color: var(--accent-red); font-weight: 600;">$${opp.monthly_waste.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}
            `;
        }

        async function loadTrendAnalysis() {
            const data = await fetchAPI('/api/reports/trends?days=30');
            if (!data || data.error) {
                document.getElementById('report-content').innerHTML = `
                    <div class="alert alert-error">
                        <strong>Error:</strong> ${data?.error || 'Failed to load trend analysis'}
                    </div>
                `;
                return;
            }

            const trends = data.cost_trends;

            document.getElementById('report-content').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="metric-card">
                        <div class="metric-label">Week-over-Week Change</div>
                        <div class="metric-value" style="color: ${trends.week_over_week_change > 0 ? 'var(--accent-red)' : 'var(--accent-green)'}">
                            ${trends.week_over_week_change > 0 ? '+' : ''}${trends.week_over_week_change.toFixed(1)}%
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Month-over-Month Change</div>
                        <div class="metric-value" style="color: ${trends.month_over_month_change > 0 ? 'var(--accent-red)' : 'var(--accent-green)'}">
                            ${trends.month_over_month_change > 0 ? '+' : ''}${trends.month_over_month_change.toFixed(1)}%
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Trend Direction</div>
                        <div class="metric-value" style="color: ${trends.trend_direction === 'up' ? 'var(--accent-red)' : trends.trend_direction === 'down' ? 'var(--accent-green)' : 'var(--accent-yellow)'}">
                            ${trends.trend_direction.toUpperCase()}
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Daily Average</div>
                        <div class="metric-value">$${trends.daily_average.toFixed(2)}</div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Historical Cost Data (30 Days)</span>
                    </div>
                    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Total Cost</th>
                                    <th>Deployments</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.historical_data.slice().reverse().map(d => `
                                    <tr>
                                        <td>${d.date}</td>
                                        <td>$${d.total_cost.toFixed(2)}</td>
                                        <td>${d.deployment_count}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        setInterval(() => {
            state.countdown--;
            document.getElementById('countdown').textContent = state.countdown;
            if (state.countdown <= 0) { state.countdown = 30; loadData(true); }
        }, 1000);

        loadData();
    </script>
</body>
</html>
